<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Module 4: Making Peace with Reality</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: rgba(15, 23, 42, 0.98);
    --bg-card-light: rgba(30, 41, 59, 0.65);
    --bg-card-dark: rgba(15, 23, 42, 0.45);
    --border-subtle: rgba(30, 41, 59, 0.5);
    --border-softer: rgba(51, 65, 85, 0.4);
    --primary-teal: #0e7490;
    --primary-teal-dark: #0c627a;
    --accent-amber: #d97706;
    --accent-amber-dark: #b45309;
    --text-primary: rgb(241, 245, 249);
    --text-secondary: rgb(203, 213, 225);
    --text-muted: rgb(148, 163, 184);
    --text-teal-light: rgb(165, 243, 252);
    --text-teal: rgb(94, 234, 212);
    --text-amber: rgb(251, 191, 36);
    --success-emerald: rgb(74, 222, 128);
    --success-bg: rgba(34, 197, 94, 0.12);
    --gradient-main: linear-gradient(135deg, #0e7490, #d97706);
    --gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
    --crisis-red: #dc2626;
    --crisis-red-dark: #b91c1c;
    --crisis-bg: rgba(220, 38, 38, 0.08);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg-dark);
    color: var(--text-primary);
}

.container {
    width: 100%;
    height: 100vh;
    height: -webkit-fill-available;
    display: flex;
    flex-direction: column;
}

.app-wrapper {
    width: 100%;
    max-width: 28rem;
    height: 100%;
    margin: 0 auto;
    background: var(--bg-card);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.bg-blur-1, .bg-blur-2 {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.3;
}

.bg-blur-1 {
    top: -5%;
    left: 50%;
    transform: translateX(-50%);
    width: 22rem;
    height: 22rem;
    background: rgba(14, 116, 144, 0.15);
}

.bg-blur-2 {
    bottom: -5%;
    right: -5%;
    width: 18rem;
    height: 18rem;
    background: rgba(217, 119, 6, 0.15);
}

.main-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    position: relative;
    z-index: 1;
}

.main-content::-webkit-scrollbar {
    display: none;
}

.content-wrapper {
    padding: 1.25rem;
    padding-bottom: calc(2rem + env(safe-area-inset-bottom));
    min-height: 100%;
    display: flex;
    flex-direction: column;
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
}

.header__top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.back-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    transition: all 0.2s;
}

.back-btn:active {
    transform: scale(0.9);
}

.step-indicator {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 600;
}

.progress-dots {
    display: flex;
    gap: 0.375rem;
    margin-bottom: 1rem;
}

.progress-dot {
    flex: 1;
    height: 0.5rem;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 1rem;
    transition: all 0.3s;
}

.progress-dot.active {
    background: var(--gradient-main);
}

.step-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: var(--gradient-main);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.step-subtitle {
    color: var(--text-secondary);
    font-size: 0.9375rem;
}

/* Card */
.card {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1.25rem;
    padding: 1.75rem 1.5rem;
    margin-bottom: 1.25rem;
}

.card--highlight {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14, 116, 144, 0.3);
}

.card__icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 1rem;
    line-height: 1;
}

.card__title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 0.625rem;
}

.card__content {
    color: var(--text-secondary);
    line-height: 1.7;
    font-size: 1rem;
}

.card__content p {
    margin-bottom: 1.25rem;
}

.card__content p:last-child {
    margin-bottom: 0;
}

.card__content strong {
    color: var(--text-teal);
    font-weight: 600;
}

/* Section Header */
.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-softer);
}

.section-icon {
    font-size: 1.75rem;
}

.section-title-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-teal-light);
}

/* Stats */
.technique-stats {
    display: flex;
    gap: 1rem;
    margin: 1.25rem 0;
    padding: 1rem;
    background: rgba(15,23,42,0.6);
    border-radius: 0.75rem;
}

.stat {
    flex: 1;
    text-align: center;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.stat-value {
    color: var(--text-teal);
    font-weight: 700;
    font-size: 1rem;
    margin-top: 0.25rem;
}

/* Instruction Box */
.instruction-box {
    background: rgba(15,23,42,0.6);
    border-left: 4px solid var(--primary-teal);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin: 1.25rem 0;
}

.instruction-list {
    list-style: none;
    counter-reset: step-counter;
}

.instruction-list li {
    counter-increment: step-counter;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
}

.instruction-list li:before {
    content: counter(step-counter);
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    font-weight: 700;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
}

/* Quote Box */
.quote-box {
    background: rgba(217,119,6,0.1);
    border-left: 4px solid var(--accent-amber);
    padding: 1.25rem;
    border-radius: 0.75rem;
    margin: 1.25rem 0;
    font-style: italic;
    color: var(--text-amber);
    line-height: 1.6;
}

/* Practice Card */
.practice-card {
    background: var(--gradient-subtle);
    border: 2px solid rgba(14,116,144,0.3);
    border-radius: 1rem;
    padding: 1.75rem;
    margin: 1.5rem 0;
}

.practice-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-teal-light);
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1.25rem;
}

/* Buttons */
.practice-buttons {
    display: flex;
    gap: 0.75rem;
    margin: 1.25rem 0;
}

.btn-practice {
    flex: 1;
    padding: 0.875rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-practice:active {
    transform: scale(0.97);
}

.btn-practice-primary {
    background: var(--gradient-main);
    color: white;
}

.btn-practice-primary:active {
    opacity: 0.9;
}

.btn-practice-secondary {
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn-practice-secondary:active {
    background: rgba(30,41,59,0.8);
}

.reflection-btn {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: var(--bg-card-dark);
    border: 1px solid var(--border-softer);
    color: var(--text-secondary);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.reflection-btn.selected {
    background: rgba(14,116,144,0.2);
    border-color: var(--primary-teal);
    color: var(--text-teal);
}

.reflection-btn:active {
    transform: scale(0.97);
}

/* Input Fields */
.input-field {
    width: 100%;
    padding: 0.875rem 1rem;
    background: rgba(15,23,42,0.6);
    border: 1px solid var(--border-softer);
    border-radius: 0.75rem;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
}

.input-field:focus {
    outline: none;
    border-color: var(--primary-teal);
    background: rgba(15,23,42,0.8);
}

.input-field::placeholder {
    color: var(--text-muted);
    opacity: 0.6;
}

/* Save Button */
.btn-save {
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    border: 1px solid rgba(14,116,144,0.35);
    padding: 1rem 1.5rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    margin-top: 1rem;
}

.btn-save:active {
    background: rgba(14,116,144,0.25);
    transform: scale(0.98);
}

.btn-save.saved {
    background: var(--success-bg);
    color: var(--success-emerald);
    border-color: rgba(74,222,128,0.35);
}

/* Checkboxes */
.reflection-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: rgba(15,23,42,0.6);
    border: 1px solid var(--border-softer);
    border-radius: 0.75rem;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 0.875rem;
    transition: all 0.2s;
}

.reflection-checkbox:active {
    background: rgba(30,41,59,0.8);
}

.reflection-checkbox.checked {
    border-color: var(--primary-teal);
    background: rgba(14,116,144,0.15);
    color: var(--text-primary);
}

.reflection-checkbox input[type="checkbox"] {
    width: 1.125rem;
    height: 1.125rem;
    accent-color: var(--primary-teal);
}

.reflection-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1.5rem 0;
}

/* Reference Card */
.reference-card {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14,116,144,0.3);
    border-radius: 1.25rem;
    padding: 1.75rem;
    margin: 1.5rem 0;
}

.reference-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-teal-light);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reference-grid {
    display: grid;
    gap: 1rem;
}

.reference-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    background: rgba(15,23,42,0.6);
    border-radius: 0.75rem;
}

.reference-icon {
    font-size: 1.5rem;
}

.reference-content {
    flex: 1;
}

.reference-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9375rem;
    margin-bottom: 0.25rem;
}

.reference-use {
    color: var(--text-muted);
    font-size: 0.8125rem;
    line-height: 1.5;
}

/* Buttons */
.btn {
    width: 100%;
    padding: 1.125rem 1.5rem;
    border-radius: 1rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    text-decoration: none;
}

.btn--primary {
    background: var(--gradient-main);
    color: white;
}

.btn--primary:active {
    transform: scale(0.98);
    opacity: 0.9;
}

.btn--secondary {
    background: rgba(30, 41, 59, 0.6);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn--secondary:active {
    background: rgba(30, 41, 59, 0.8);
    transform: scale(0.98);
}

.btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
}

.save-feedback {
    color: var(--success-emerald);
    font-size: 0.875rem;
    text-align: center;
    margin-top: 0.875rem;
    display: none;
}

.save-feedback.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

/* Practice Button */
.practice-section {
    text-align: center;
    margin: 1.25rem 0;
}

.practice-btn {
    background: var(--success-bg);
    color: var(--success-emerald);
    border: 1px solid rgba(74, 222, 128, 0.3);
    padding: 0.875rem 2rem;
    border-radius: 2rem;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
}

.practice-btn:active {
    background: rgba(34, 197, 94, 0.2);
    transform: scale(0.97);
}

.practice-btn.marked {
    background: rgba(34, 197, 94, 0.25);
}

/* Completion Stats */
.completion-stats {
    display: flex;
    justify-content: space-around;
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(15,23,42,0.6);
    border-radius: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-teal);
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
}

/* Footer */
.footer {
    margin-top: auto;
    padding-top: 2rem;
    border-top: 1px solid var(--border-subtle);
    text-align: center;
}

.footer__warning {
    color: #fca5a5;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.footer__resources {
    color: var(--text-muted);
    font-size: 0.8125rem;
    line-height: 1.8;
}

.footer__resources p {
    margin-bottom: 0.5rem;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.step-content {
    animation: fadeIn 0.3s ease-out;
}

/* Mobile Adjustments */
@media (max-width: 640px) {
    .reflection-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        grid-template-columns: 1fr;
    }
    
    .practice-buttons {
        flex-direction: column;
    }
}

/* iOS Safe Area */
@supports (-webkit-touch-callout: none) {
    .container {
        height: -webkit-fill-available;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="app-wrapper">
        <div class="bg-blur-1"></div>
        <div class="bg-blur-2"></div>
        <div class="main-content" id="mainContent">
            <div class="content-wrapper" id="content">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // ===== UPDATE COURSE PROGRESS =====
    // This connects Module 4 to the intro page
    let courseProgress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
    courseProgress.currentModule = 4;
    courseProgress.lastAccessed = new Date().toISOString();
    localStorage.setItem('crisis_course_progress', JSON.stringify(courseProgress));

    // State
    let currentStep = 1;
    const totalSteps = 8;
    let userData = {
        resistanceInput: '',
        acceptanceInput: '',
        negativeThoughtInput: '',
        defusionThoughtInput: '',
        believeBefore: 7,
        believeAfter: 4,
        selectedTechniques: []
    };
    
    // Step titles
    const stepTitles = {
        1: 'Introduction',
        2: 'Radical Acceptance',
        3: 'Willing Hands',
        4: 'Half-Smile',
        5: 'Self-Compassion',
        6: 'Self-Compassion Break',
        7: 'Defusion',
        8: 'Module Complete!'
    };
    
    // Storage helpers
    function saveProgress() {
        try {
            const data = {
                step: currentStep,
                userData: userData,
                timestamp: Date.now()
            };
            localStorage.setItem('crisis_module4_progress', JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Save failed:', e);
            return false;
        }
    }
    
    function loadProgress() {
        try {
            const saved = localStorage.getItem('crisis_module4_progress');
            if (saved) {
                const data = JSON.parse(saved);
                if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                    currentStep = data.step;
                    userData = data.userData;
                    return true;
                }
            }
        } catch (e) {
            console.error('Load failed:', e);
        }
        return false;
    }
    
    function saveToToolkit(item) {
        try {
            let toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
            toolkit = toolkit.filter(t => t.id !== item.id);
            toolkit.push({
                ...item,
                date: new Date().toISOString()
            });
            localStorage.setItem('crisis_toolkit', JSON.stringify(toolkit));
            return true;
        } catch (e) {
            console.error('Save to toolkit failed:', e);
            return false;
        }
    }
    
    // Navigation with scroll to top
    function scrollToTop() {
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }
    
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;
        currentStep = step;
        saveProgress();
        render();
        scrollToTop();
    }
    
    function nextStep() {
        if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            goToStep(currentStep - 1);
        } else {
            window.location.href = 'crisis-module-3.html';
        }
    }
    
    // Render functions
    function renderHeader() {
        return `
            <div class="header">
                <div class="header__top">
                    <button class="back-btn" onclick="previousStep()">‚Üê</button>
                    <span class="step-indicator">${currentStep} / ${totalSteps}</span>
                </div>
                <div class="progress-dots">
                    ${Array(totalSteps).fill(0).map((_, i) => 
                        `<div class="progress-dot ${i < currentStep ? 'active' : ''}"></div>`
                    ).join('')}
                </div>
                <h1 class="step-title">${stepTitles[currentStep]}</h1>
                <p class="step-subtitle">Module 4: Making Peace with Reality</p>
            </div>
        `;
    }
    
    function renderFooter() {
        return `
            <div class="footer">
                <p class="footer__warning">‚ö†Ô∏è EDUCATIONAL ONLY ‚Äî NOT THERAPY</p>
                <div class="footer__resources">
                    <p>988 Suicide & Crisis Lifeline: Call or text 988</p>
                    <p>Crisis Text Line: Text HOME to 741741</p>
                </div>
            </div>
        `;
    }
    
    function renderStep1() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="card__icon">üïäÔ∏è</div>
                    <div class="card__content">
                        <p style="font-size: 1.05rem; color: var(--text-teal-light); font-style: italic; margin-bottom: 1.5rem;">
                            "This is the hardest module. It's about acceptance ‚Äî not approval, not liking it, not giving up. Acceptance means stopping the internal war with reality."
                        </p>
                        
                        <p style="margin-bottom: 1rem;">Fighting reality is like refusing to believe it's raining while you're getting soaked. The rain doesn't care. You can accept it's raining AND grab an umbrella.</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card__title">
                        <span>üßÆ</span>
                        <span>The Math of Suffering</span>
                    </div>
                    <div class="card__content">
                        <div class="instruction-box" style="text-align: center;">
                            <p style="color: var(--text-teal); font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Pain √ó Rejection = Suffering</p>
                            <p style="color: var(--text-secondary); font-size: 0.9375rem;">
                                <strong>Pain</strong> = the actual difficult situation<br>
                                <strong>Rejection</strong> = fighting that it's happening<br>
                                <strong>Suffering</strong> = pain multiplied by resistance
                            </p>
                            <p style="color: var(--text-teal); margin-top: 1rem; font-style: italic;">
                                You can't always control pain. You CAN control rejection.
                            </p>
                        </div>
                        
                        <p style="margin-top: 1.5rem;">
                            <strong>The Science:</strong> Brain imaging studies show that acceptance-based responses lead to decreased amygdala activation. Fighting your emotions actually intensifies them.
                        </p>
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep2() {
        setTimeout(() => {
            initAcceptance();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">‚úã</span>
                        <span class="section-title-text">Radical Acceptance</span>
                    </div>
                    
                    <div class="card__content">
                        <p style="margin-bottom: 1.5rem; font-weight: 600; color: var(--text-primary);">Radical Acceptance doesn't mean:</p>
                        <ul style="list-style: none; margin-bottom: 1.5rem;">
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--crisis-red);">‚ùå</span> Liking what happened</li>
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--crisis-red);">‚ùå</span> Approving of it</li>
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--crisis-red);">‚ùå</span> Giving up on change</li>
                        </ul>
                        
                        <p style="margin-bottom: 1.5rem; font-weight: 600; color: var(--text-primary);">It DOES mean:</p>
                        <ul style="list-style: none; margin-bottom: 1.5rem;">
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--success-emerald);">‚úÖ</span> Acknowledging reality as it is</li>
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--success-emerald);">‚úÖ</span> Stopping the war with what you can't change</li>
                            <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;"><span style="color: var(--success-emerald);">‚úÖ</span> Freeing up energy to respond effectively</li>
                        </ul>
                    </div>
                    
                    <!-- Acceptance Phrases -->
                    <div class="quote-box">
                        <p style="font-weight: 700; margin-bottom: 1rem;">The Acceptance Phrases:</p>
                        <p style="margin-bottom: 0.75rem;">‚Ä¢ "It is what it is."</p>
                        <p style="margin-bottom: 0.75rem;">‚Ä¢ "This is my reality right now."</p>
                        <p style="margin-bottom: 0.75rem;">‚Ä¢ "I don't have to like it to accept it's real."</p>
                        <p style="margin-bottom: 0.75rem;">‚Ä¢ "Fighting reality doesn't change reality."</p>
                        <p style="margin-bottom: 0.75rem;">‚Ä¢ "What happened, happened. What happens next is up to me."</p>
                    </div>
                    
                    <!-- EXPERIENTIAL PRACTICE -->
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üí≠</span>
                            ACCEPTANCE PRACTICE
                        </div>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 1rem;">Think of something difficult in your life right now.</p>
                        
                        <button id="acceptanceStartBtn" class="btn-practice btn-practice-primary" style="margin-bottom: 1rem;">Continue ‚Üí</button>
                        
                        <div id="acceptancePractice" style="display: none;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Step 1:</strong> What's something you've been fighting or resisting?</p>
                            <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 0.5rem;">Example: "I can't believe they left me", "This isn't fair"</p>
                            <input type="text" id="resistanceInput" class="input-field" placeholder="Write it here..." value="${userData.resistanceInput || ''}">
                            
                            <p style="color: var(--text-secondary); margin-top: 1.5rem; margin-bottom: 0.5rem;"><strong>Step 2:</strong> Notice the language of rejection:</p>
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                                <button id="rejectionYesBtn" class="reflection-btn">Yes</button>
                                <button id="rejectionNoBtn" class="reflection-btn">No</button>
                            </div>
                            
                            <p style="color: var(--text-secondary); margin-top: 1.5rem; margin-bottom: 0.5rem;"><strong>Step 3:</strong> Try shifting to acceptance language:</p>
                            
                            <p style="color: var(--text-teal); font-size: 0.875rem; margin-bottom: 0.5rem;">Instead of: "This shouldn't have happened"</p>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">Try: "This DID happen. I don't like it, but it's real."</p>
                            
                            <p style="color: var(--text-teal); font-size: 0.875rem; margin-bottom: 0.5rem;">Your turn: Rewrite your situation in acceptance language:</p>
                            <input type="text" id="acceptanceInput" class="input-field" placeholder="___________" value="${userData.acceptanceInput || ''}">
                            
                            <p style="color: var(--text-secondary); margin-top: 1.5rem; margin-bottom: 0.5rem;"><strong>Step 4:</strong> Does this reduce the intensity even slightly?</p>
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                                <button id="intensityYesBtn" class="reflection-btn">Yes - a little</button>
                                <button id="intensityNoBtn" class="reflection-btn">No</button>
                                <button id="intensityUnsureBtn" class="reflection-btn">Not sure</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SAVE BUTTON FOR ACTIONABLE SKILL -->
                <button id="saveAcceptanceBtn" class="btn-save">
                    <span>‚úã</span> Save Acceptance Tools to Toolkit
                </button>
                <div id="acceptanceSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep3() {
        setTimeout(() => {
            initWillingHands();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üôè</span>
                        <span class="section-title-text">Willing Hands</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "The physical posture of acceptance vs. resistance. Your body influences your mind ‚Äî when you open your hands, it's harder to stay clenched emotionally."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° Immediate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Physical resistance</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Gentle</div>
                        </div>
                    </div>
                    
                    <!-- Willing Hands Practice -->
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üôè</span>
                            TRY WILLING HANDS NOW
                        </div>
                        
                        <button id="willingHandsBtn" class="btn-practice btn-practice-primary" style="margin-bottom: 1rem;">Show Me How ‚Üí</button>
                        
                        <div id="willingHandsPractice" style="display: none;">
                            <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 1rem;">Let's practice together.</p>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>Step 1:</strong> Clench your fists tight. Notice the tension. This is resistance.</p>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>Step 2:</strong> Now open your hands, palms up. Let shoulders drop. This is willingness.</p>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;"><strong>Step 3:</strong> Think of something mildly frustrating while holding willing hands.</p>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;"><strong>Notice:</strong> Does the physical posture of openness change your internal experience?</p>
                            
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                                <button id="willingYesBtn" class="reflection-btn">Yes</button>
                                <button id="willingNoBtn" class="reflection-btn">No</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            <strong style="color: var(--text-teal);">Try this in crisis:</strong> When you notice your body tensing up, physically open your hands and turn palms up. Say to yourself "I'm willing to feel this."
                        </p>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep4() {
        setTimeout(() => {
            initHalfSmile();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üòå</span>
                        <span class="section-title-text">Half-Smile</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Research shows that the facial feedback loop works both ways ‚Äî not only do emotions create facial expressions, but facial expressions can influence emotions."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° 30 seconds</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Emotional intensity</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Very gentle</div>
                        </div>
                    </div>
                    
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.75rem;">How to do it:</p>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">1. Slightly raise the corners of your mouth ‚Äî not a big smile, just a subtle lift</p>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">2. Relax your jaw ‚Äî let it be soft</p>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">3. Soften your eyes ‚Äî imagine seeing the world through kind eyes</p>
                        <p style="color: var(--text-secondary);">4. Hold for 30 seconds while breathing normally</p>
                    </div>
                    
                    <!-- Half-Smile Practice -->
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üòå</span>
                            TRY HALF-SMILE NOW
                        </div>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 1rem;">Let's try it together.</p>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Gently lift the corners of your mouth... relax your jaw... soften your eyes...</p>
                        
                        <div style="text-align: center; margin: 1.5rem 0;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üòå</div>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">Hold for 30 seconds</p>
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">How does it feel?</p>
                        <div style="display: flex; gap: 0.75rem;">
                            <button id="halfSmileSoftBtn" class="reflection-btn">Feels softer</button>
                            <button id="halfSmileNoChangeBtn" class="reflection-btn">No change</button>
                            <button id="halfSmileFakeBtn" class="reflection-btn">Feels fake</button>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep5() {
        setTimeout(() => {
            initCompassion();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üíù</span>
                        <span class="section-title-text">Self-Compassion</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Self-compassion means treating yourself the way you'd treat a good friend who's struggling. Most people are far harsher with themselves than they'd ever be with someone they care about."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° Immediate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Shame, self-criticism</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Gentle</div>
                        </div>
                    </div>
                    
                    <!-- Three Components -->
                    <div style="background: rgba(14,116,144,0.1); padding: 1.5rem; border-radius: 0.75rem; margin: 1.25rem 0;">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 1rem;">The Three Components (Kristin Neff):</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.5rem;">1. Self-Kindness</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">"This is really hard" instead of "I'm pathetic"</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.5rem;">2. Common Humanity</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">"Everyone struggles" instead of "I'm the only one"</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.5rem;">3. Mindfulness</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">"I'm having a hard time" instead of "I AM a failure"</p>
                    </div>
                    
                    <!-- The Science -->
                    <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem; margin: 1rem 0;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            <strong style="color: var(--text-teal);">The Science:</strong> Self-compassion activates the caregiving system in your brain (oxytocin release), while self-criticism activates the threat system. Self-compassion is not self-indulgence ‚Äî it's a more effective form of self-regulation.
                        </p>
                    </div>
                    
                    <!-- Critical Friend vs Kind Coach -->
                    <div style="margin-top: 1.5rem;">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 1rem;">The Critical Friend vs. The Kind Coach:</p>
                        
                        <div style="background: rgba(220,38,38,0.1); padding: 1rem; border-radius: 0.75rem; margin-bottom: 0.75rem;">
                            <p style="color: #fca5a5; font-weight: 600; margin-bottom: 0.25rem;">Critical Friend:</p>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">"You're such a mess. Why can't you handle this? Everyone else can."</p>
                        </div>
                        
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                            <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.25rem;">Kind Coach:</p>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">"This is genuinely difficult. You're struggling because this IS hard, not because you're broken."</p>
                        </div>
                    </div>
                </div>
                
                <!-- SAVE BUTTON FOR ACTIONABLE SKILL -->
                <button id="saveCompassionBtn" class="btn-save">
                    <span>üíù</span> Save Self-Compassion to Toolkit
                </button>
                <div id="compassionSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep6() {
        setTimeout(() => {
            initCompassionBreak();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üíù</span>
                        <span class="section-title-text">Self-Compassion Break</span>
                    </div>
                    
                    <!-- Self-Compassion Phrases -->
                    <div class="quote-box" style="margin-top: 0;">
                        <p style="font-weight: 700; margin-bottom: 0.75rem;">Self-Compassion Phrases:</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ "Of course this is hard. Anyone would struggle with this."</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ "I'm doing the best I can with what I have right now."</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ "I deserve kindness, especially when I'm suffering."</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ "What would I say to a friend in this situation?"</p>
                    </div>
                    
                    <!-- Guided Self-Compassion Break -->
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üíù</span>
                            GUIDED SELF-COMPASSION BREAK
                        </div>
                        
                        <button id="compassionStartBtn" class="btn-practice btn-practice-primary" style="margin-bottom: 1rem;">Start Guided Practice ‚Üí</button>
                        
                        <div id="compassionPractice" style="display: none;">
                            <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 1rem;">Think of a situation where you're being hard on yourself.</p>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Now, say these three things (out loud or silently):</p>
                            
                            <div style="background: rgba(14,116,144,0.15); padding: 1.25rem; border-radius: 0.75rem; margin: 1rem 0;">
                                <p style="color: var(--text-teal-light); font-weight: 700; margin-bottom: 0.75rem;">1. MINDFULNESS:</p>
                                <p style="color: var(--text-secondary);">"This is a moment of suffering."</p>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">or "This is really hard right now."</p>
                            </div>
                            
                            <div style="background: rgba(14,116,144,0.15); padding: 1.25rem; border-radius: 0.75rem; margin: 1rem 0;">
                                <p style="color: var(--text-teal-light); font-weight: 700; margin-bottom: 0.75rem;">2. COMMON HUMANITY:</p>
                                <p style="color: var(--text-secondary);">"Suffering is part of being human."</p>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">or "Everyone struggles sometimes."</p>
                            </div>
                            
                            <div style="background: rgba(14,116,144,0.15); padding: 1.25rem; border-radius: 0.75rem; margin: 1rem 0;">
                                <p style="color: var(--text-teal-light); font-weight: 700; margin-bottom: 0.75rem;">3. SELF-KINDNESS:</p>
                                <p style="color: var(--text-secondary);">"May I be kind to myself."</p>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">or "May I give myself the compassion I need."</p>
                            </div>
                            
                            <p style="color: var(--text-teal-light); margin: 1.5rem 0; text-align: center;">Now place your hand on your heart or give yourself a gentle hug.</p>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">How does this feel?</p>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button id="compassionComfortingBtn" class="reflection-btn">Comforting</button>
                                <button id="compassionAwkwardBtn" class="reflection-btn">Awkward but helpful</button>
                                <button id="compassionNotWorkBtn" class="reflection-btn">Doesn't work for me</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep7() {
        setTimeout(() => {
            initDefusion();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üé≠</span>
                        <span class="section-title-text">Defusion ‚Äî Thoughts Aren't Facts</span>
                    </div>
                    
                    <div class="card__content">
                        <p style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-teal);">Cognitive Fusion</strong> = believing your thoughts are literal truths<br>
                            <strong style="color: var(--text-teal);">Cognitive Defusion</strong> = seeing thoughts as mental events, not facts
                        </p>
                        
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem; margin: 1rem 0;">
                            <p><span style="color: var(--text-teal-light);">Example:</span><br>
                            ‚Ä¢ Fusion: "I'm worthless" (this feels like absolute truth)<br>
                            ‚Ä¢ Defusion: "I'm having the thought that I'm worthless" (this is a thought my brain produced)</p>
                        </div>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° Immediate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Intrusive thoughts</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Low</div>
                        </div>
                    </div>
                    
                    <!-- Defusion Techniques -->
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 1rem;">5 Defusion Techniques:</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.25rem;">1. "I'm having the thought that‚Ä¶"</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">Add this prefix to any negative thought ‚Äî creates distance</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.25rem;">2. "Thanks, brain!"</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">"Thanks for that input, brain!" ‚Äî acknowledge without buying in</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.25rem;">3. Silly voices</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">Say the thought in a cartoon voice ‚Äî reduces thought power</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.25rem;">4. Leaves on a stream</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">Visualize thoughts as leaves floating by ‚Äî watch them pass</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.25rem;">5. Name the story</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">"Ah, there's my 'I'm not good enough' story again."</p>
                    </div>
                    
                    <!-- Experiential Practice -->
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üé≠</span>
                            PRACTICE DEFUSION
                        </div>
                        
                        <button id="defusionStartBtn" class="btn-practice btn-practice-primary" style="margin-bottom: 1rem;">Try It Now ‚Üí</button>
                        
                        <div id="defusionPractice" style="display: none;">
                            <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 1rem;">Let's try it together.</p>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Step 1:</strong> Think of a negative thought you have often.</p>
                            <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 0.5rem;">Example: "I'm not good enough", "I always fail"</p>
                            <input type="text" id="negativeThoughtInput" class="input-field" placeholder="Write it here..." value="${userData.negativeThoughtInput || ''}">
                            
                            <p style="color: var(--text-secondary); margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Step 2:</strong> Feel the weight of that thought. Rate how much you believe it (0-10)</p>
                            <input type="range" id="believeBeforeSlider" min="0" max="10" value="${userData.believeBefore || 7}" step="1" style="width: 100%; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">0 - Don't believe</span>
                                <span style="color: var(--text-teal); font-weight: 700;" id="believeBeforeValue">${userData.believeBefore || 7}</span>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">10 - Completely believe</span>
                            </div>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Step 3:</strong> Now say it with "I'm having the thought that‚Ä¶"</p>
                            <input type="text" id="defusionThoughtInput" class="input-field" placeholder="I'm having the thought that ___________" value="${userData.defusionThoughtInput || ''}">
                            
                            <p style="color: var(--text-secondary); margin: 1rem 0 0.5rem;"><strong>Notice:</strong> Does it feel different?</p>
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem;">
                                <button id="defusionLessBtn" class="reflection-btn">Yes - less heavy</button>
                                <button id="defusionNoChangeBtn" class="reflection-btn">No change</button>
                            </div>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Step 4:</strong> Try saying it in a silly voice.</p>
                            <button id="defusionSillyBtn" class="btn-practice btn-practice-primary" style="margin-bottom: 1rem;">Done it</button>
                            
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Step 5:</strong> Now rate how much you believe it (0-10)</p>
                            <input type="range" id="believeAfterSlider" min="0" max="10" value="${userData.believeAfter || 4}" step="1" style="width: 100%; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">0 - Don't believe</span>
                                <span style="color: var(--text-teal); font-weight: 700;" id="believeAfterValue">${userData.believeAfter || 4}</span>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">10 - Completely believe</span>
                            </div>
                            
                            <div id="defusionResult" style="background: rgba(14,116,144,0.15); padding: 1rem; border-radius: 0.75rem; margin-top: 1rem; display: none;">
                                <p style="color: var(--text-teal-light);">Your result will appear here.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Insight -->
                    <div class="quote-box" style="margin-top: 1.5rem;">
                        <p style="font-weight: 700; margin-bottom: 0.75rem;">Key Insight:</p>
                        <p>
                            "You don't have to believe your thoughts just because your brain produces them. Your brain generates thousands of thoughts daily ‚Äî many are random, unhelpful, or false."
                        </p>
                    </div>
                </div>
                
                <!-- SAVE BUTTON FOR ACTIONABLE SKILL -->
                <button id="saveDefusionBtn" class="btn-save">
                    <span>üé≠</span> Save Defusion Techniques to Toolkit
                </button>
                <div id="defusionSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep8() {
        setTimeout(() => {
            initComplete();
        }, 100);
        
        // Get progress data
        const progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        const isPracticed = progress.practicedModules?.includes('module4') || false;
        const toolkitCount = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]').length;
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card card--highlight" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h2 style="color: var(--text-teal-light); font-size: 1.5rem; margin-bottom: 1rem;">Module 4 Complete!</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        You've learned how to make peace with reality and stop fighting what you can't change.
                    </p>
                    
                    <div class="completion-stats">
                        <div class="stat-item">
                            <div class="stat-value">5</div>
                            <div class="stat-label">SKILLS LEARNED</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${toolkitCount}</div>
                            <div class="stat-label">TOOLKIT ITEMS</div>
                        </div>
                    </div>
                </div>
                
                <!-- MARK AS PRACTICED BUTTON -->
                <div class="practice-section">
                    <button id="practiceBtn" class="practice-btn ${isPracticed ? 'marked' : ''}">
                        <span>${isPracticed ? '‚úì' : '‚óã'}</span>
                        <span>${isPracticed ? 'Module 4 Practiced' : 'Mark Module as Practiced'}</span>
                    </button>
                </div>
                
                <!-- NAVIGATION BUTTONS -->
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <a href="crisis-module-3.html" class="btn btn--secondary">
                            <span>‚Üê Module 3</span>
                        </a>
                        <a href="crisis-module-5.html" class="btn btn--primary">
                            <span>Module 5 ‚Üí</span>
                        </a>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <a href="crisis-intro.html" class="btn btn--secondary">
                            <span>üè†</span>
                            <span>Course Hub</span>
                        </a>
                        <button onclick="goToStep(1)" class="btn btn--secondary">
                            <span>‚Üª</span>
                            <span>Review Module</span>
                        </button>
                    </div>
                    
                    <a href="crisis-toolkit.html" class="btn-save" style="background: rgba(217,119,6,0.1); text-decoration: none; margin-top: 0.5rem;">
                        <span>üß∞</span>
                        <span>View My Toolkit</span>
                    </a>
                </div>
                
                <!-- SKILLS SUMMARY -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="section-header">
                        <span class="section-icon">üïäÔ∏è</span>
                        <span class="section-title-text">Your New Skills</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <div style="background: rgba(14,116,144,0.1); padding: 0.75rem; border-radius: 0.75rem; text-align: center;">
                            <span style="font-size: 1.5rem;">‚úã</span>
                            <p style="color: var(--text-teal); font-size: 0.75rem; margin-top: 0.25rem;">Acceptance</p>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 0.75rem; border-radius: 0.75rem; text-align: center;">
                            <span style="font-size: 1.5rem;">üôè</span>
                            <p style="color: var(--text-teal); font-size: 0.75rem; margin-top: 0.25rem;">Willing Hands</p>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 0.75rem; border-radius: 0.75rem; text-align: center;">
                            <span style="font-size: 1.5rem;">üòå</span>
                            <p style="color: var(--text-teal); font-size: 0.75rem; margin-top: 0.25rem;">Half-Smile</p>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 0.75rem; border-radius: 0.75rem; text-align: center;">
                            <span style="font-size: 1.5rem;">üíù</span>
                            <p style="color: var(--text-teal); font-size: 0.75rem; margin-top: 0.25rem;">Self-Compassion</p>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 0.75rem; border-radius: 0.75rem; text-align: center; grid-column: span 2;">
                            <span style="font-size: 1.5rem;">üé≠</span>
                            <p style="color: var(--text-teal); font-size: 0.75rem; margin-top: 0.25rem;">Defusion</p>
                        </div>
                    </div>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    // Interactive Functions
    function initAcceptance() {
        const startBtn = document.getElementById('acceptanceStartBtn');
        const practice = document.getElementById('acceptancePractice');
        const resistanceInput = document.getElementById('resistanceInput');
        const acceptanceInput = document.getElementById('acceptanceInput');
        
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                practice.style.display = 'block';
                startBtn.style.display = 'none';
            });
        }
        
        if (resistanceInput) {
            resistanceInput.addEventListener('input', function() {
                userData.resistanceInput = this.value;
            });
        }
        
        if (acceptanceInput) {
            acceptanceInput.addEventListener('input', function() {
                userData.acceptanceInput = this.value;
            });
        }
        
        // Rejection buttons
        const rejectionYesBtn = document.getElementById('rejectionYesBtn');
        const rejectionNoBtn = document.getElementById('rejectionNoBtn');
        
        if (rejectionYesBtn) {
            rejectionYesBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (rejectionNoBtn) rejectionNoBtn.classList.remove('selected');
            });
        }
        
        if (rejectionNoBtn) {
            rejectionNoBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (rejectionYesBtn) rejectionYesBtn.classList.remove('selected');
            });
        }
        
        // Intensity buttons
        const intensityYesBtn = document.getElementById('intensityYesBtn');
        const intensityNoBtn = document.getElementById('intensityNoBtn');
        const intensityUnsureBtn = document.getElementById('intensityUnsureBtn');
        
        if (intensityYesBtn) {
            intensityYesBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (intensityNoBtn) intensityNoBtn.classList.remove('selected');
                if (intensityUnsureBtn) intensityUnsureBtn.classList.remove('selected');
            });
        }
        
        if (intensityNoBtn) {
            intensityNoBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (intensityYesBtn) intensityYesBtn.classList.remove('selected');
                if (intensityUnsureBtn) intensityUnsureBtn.classList.remove('selected');
            });
        }
        
        if (intensityUnsureBtn) {
            intensityUnsureBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (intensityYesBtn) intensityYesBtn.classList.remove('selected');
                if (intensityNoBtn) intensityNoBtn.classList.remove('selected');
            });
        }
        
        // Save button
        const saveBtn = document.getElementById('saveAcceptanceBtn');
        const feedback = document.getElementById('acceptanceSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'acceptance-tools',
                    category: 'Module 4: Making Peace',
                    name: '‚úã Radical Acceptance',
                    description: 'Pain √ó Rejection = Suffering ‚Ä¢ "It is what it is" ‚Ä¢ Stop fighting reality'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                feedback.textContent = '‚úì Acceptance Tools saved to your toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>‚úã</span> Save Acceptance Tools to Toolkit';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initWillingHands() {
        const willingHandsBtn = document.getElementById('willingHandsBtn');
        const willingHandsPractice = document.getElementById('willingHandsPractice');
        
        if (willingHandsBtn) {
            willingHandsBtn.addEventListener('click', function() {
                willingHandsPractice.style.display = 'block';
                willingHandsBtn.style.display = 'none';
            });
        }
        
        const willingYesBtn = document.getElementById('willingYesBtn');
        const willingNoBtn = document.getElementById('willingNoBtn');
        
        if (willingYesBtn) {
            willingYesBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (willingNoBtn) willingNoBtn.classList.remove('selected');
            });
        }
        
        if (willingNoBtn) {
            willingNoBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (willingYesBtn) willingYesBtn.classList.remove('selected');
            });
        }
    }
    
    function initHalfSmile() {
        const halfSmileSoftBtn = document.getElementById('halfSmileSoftBtn');
        const halfSmileNoChangeBtn = document.getElementById('halfSmileNoChangeBtn');
        const halfSmileFakeBtn = document.getElementById('halfSmileFakeBtn');
        
        if (halfSmileSoftBtn) {
            halfSmileSoftBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (halfSmileNoChangeBtn) halfSmileNoChangeBtn.classList.remove('selected');
                if (halfSmileFakeBtn) halfSmileFakeBtn.classList.remove('selected');
            });
        }
        
        if (halfSmileNoChangeBtn) {
            halfSmileNoChangeBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (halfSmileSoftBtn) halfSmileSoftBtn.classList.remove('selected');
                if (halfSmileFakeBtn) halfSmileFakeBtn.classList.remove('selected');
            });
        }
        
        if (halfSmileFakeBtn) {
            halfSmileFakeBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (halfSmileSoftBtn) halfSmileSoftBtn.classList.remove('selected');
                if (halfSmileNoChangeBtn) halfSmileNoChangeBtn.classList.remove('selected');
            });
        }
    }
    
    function initCompassion() {
        const saveBtn = document.getElementById('saveCompassionBtn');
        const feedback = document.getElementById('compassionSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'self-compassion',
                    category: 'Module 4: Making Peace',
                    name: 'üíù Self-Compassion',
                    description: 'Treat yourself like a friend ‚Ä¢ Self-kindness, common humanity, mindfulness ‚Ä¢ "Of course this is hard"'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                feedback.textContent = '‚úì Self-Compassion saved to your toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üíù</span> Save Self-Compassion to Toolkit';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initCompassionBreak() {
        const compassionStartBtn = document.getElementById('compassionStartBtn');
        const compassionPractice = document.getElementById('compassionPractice');
        
        if (compassionStartBtn) {
            compassionStartBtn.addEventListener('click', function() {
                compassionPractice.style.display = 'block';
                compassionStartBtn.style.display = 'none';
            });
        }
        
        const compassionComfortingBtn = document.getElementById('compassionComfortingBtn');
        const compassionAwkwardBtn = document.getElementById('compassionAwkwardBtn');
        const compassionNotWorkBtn = document.getElementById('compassionNotWorkBtn');
        
        if (compassionComfortingBtn) {
            compassionComfortingBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (compassionAwkwardBtn) compassionAwkwardBtn.classList.remove('selected');
                if (compassionNotWorkBtn) compassionNotWorkBtn.classList.remove('selected');
            });
        }
        
        if (compassionAwkwardBtn) {
            compassionAwkwardBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (compassionComfortingBtn) compassionComfortingBtn.classList.remove('selected');
                if (compassionNotWorkBtn) compassionNotWorkBtn.classList.remove('selected');
            });
        }
        
        if (compassionNotWorkBtn) {
            compassionNotWorkBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (compassionComfortingBtn) compassionComfortingBtn.classList.remove('selected');
                if (compassionAwkwardBtn) compassionAwkwardBtn.classList.remove('selected');
            });
        }
    }
    
    function initDefusion() {
        const startBtn = document.getElementById('defusionStartBtn');
        const practice = document.getElementById('defusionPractice');
        const negativeThoughtInput = document.getElementById('negativeThoughtInput');
        const defusionThoughtInput = document.getElementById('defusionThoughtInput');
        const beforeSlider = document.getElementById('believeBeforeSlider');
        const beforeValue = document.getElementById('believeBeforeValue');
        const afterSlider = document.getElementById('believeAfterSlider');
        const afterValue = document.getElementById('believeAfterValue');
        const sillyBtn = document.getElementById('defusionSillyBtn');
        const resultDiv = document.getElementById('defusionResult');
        
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                practice.style.display = 'block';
                startBtn.style.display = 'none';
            });
        }
        
        if (negativeThoughtInput) {
            negativeThoughtInput.addEventListener('input', function() {
                userData.negativeThoughtInput = this.value;
            });
        }
        
        if (defusionThoughtInput) {
            defusionThoughtInput.addEventListener('input', function() {
                userData.defusionThoughtInput = this.value;
            });
        }
        
        if (beforeSlider && beforeValue) {
            beforeSlider.addEventListener('input', function() {
                beforeValue.textContent = this.value;
                userData.believeBefore = parseInt(this.value);
            });
        }
        
        if (afterSlider && afterValue) {
            afterSlider.addEventListener('input', function() {
                afterValue.textContent = this.value;
                userData.believeAfter = parseInt(this.value);
            });
        }
        
        if (sillyBtn) {
            sillyBtn.addEventListener('click', function() {
                const before = parseInt(beforeSlider?.value || '7');
                const after = parseInt(afterSlider?.value || '4');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p style="color: var(--text-teal-light);">Belief went from ${before} to ${after}. The thought didn't change ‚Äî your relationship to it did.</p>`;
            });
        }
        
        const defusionLessBtn = document.getElementById('defusionLessBtn');
        const defusionNoChangeBtn = document.getElementById('defusionNoChangeBtn');
        
        if (defusionLessBtn) {
            defusionLessBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (defusionNoChangeBtn) defusionNoChangeBtn.classList.remove('selected');
            });
        }
        
        if (defusionNoChangeBtn) {
            defusionNoChangeBtn.addEventListener('click', function() {
                this.classList.add('selected');
                if (defusionLessBtn) defusionLessBtn.classList.remove('selected');
            });
        }
        
        // Save button
        const saveBtn = document.getElementById('saveDefusionBtn');
        const feedback = document.getElementById('defusionSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'defusion',
                    category: 'Module 4: Making Peace',
                    name: 'üé≠ Defusion Techniques',
                    description: 'Thoughts aren\'t facts ‚Ä¢ "I\'m having the thought that‚Ä¶" ‚Ä¢ "Thanks, brain!" ‚Ä¢ Silly voices'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                feedback.textContent = '‚úì Defusion Techniques saved to your toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üé≠</span> Save Defusion Techniques to Toolkit';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initComplete() {
        // Checkboxes
        const checkboxes = document.querySelectorAll('.reflection-checkbox input[type="checkbox"]');
        
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const label = this.closest('.reflection-checkbox');
                if (this.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
                
                // Update userData
                userData.selectedTechniques = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
            });
        });
        
        // Save reflection
        const saveBtn = document.getElementById('saveReflectionBtn');
        const feedback = document.getElementById('reflectionSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (selected.length === 0) {
                    alert('Please select at least one technique.');
                    return;
                }
                
                saveToToolkit({
                    id: 'my-acceptance-tools',
                    category: 'My Crisis Profile',
                    name: 'üìã My Top Acceptance Tools',
                    description: selected.join(', ')
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                feedback.textContent = '‚úì Saved to your toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üìã</span> Save My Top Tools';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
        
        // Practice button
        const practiceBtn = document.getElementById('practiceBtn');
        
        let progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        if (!progress.practicedModules) progress.practicedModules = [];
        
        if (progress.practicedModules.includes('module4')) {
            practiceBtn.classList.add('marked');
            practiceBtn.innerHTML = '<span>‚úì</span><span>Module 4 Practiced</span>';
        }
        
        if (practiceBtn) {
            practiceBtn.addEventListener('click', function() {
                if (!progress.practicedModules.includes('module4')) {
                    progress.practicedModules.push('module4');
                    progress.lastPracticed = new Date().toISOString();
                    localStorage.setItem('crisis_course_progress', JSON.stringify(progress));
                    
                    practiceBtn.classList.add('marked');
                    practiceBtn.innerHTML = '<span>‚úì</span><span>Module 4 Practiced</span>';
                    
                    // Show feedback
                    const feedback = document.createElement('div');
                    feedback.style.cssText = 'color: var(--success-emerald); text-align: center; margin-top: 0.5rem; font-size: 0.9rem;';
                    feedback.textContent = '‚úì Progress saved!';
                    practiceBtn.parentNode.appendChild(feedback);
                    setTimeout(() => feedback.remove(), 3000);
                }
            });
        }
    }
    
    // Main render
    function render() {
        const content = document.getElementById('content');
        
        let html = '';
        switch(currentStep) {
            case 1: html = renderStep1(); break;
            case 2: html = renderStep2(); break;
            case 3: html = renderStep3(); break;
            case 4: html = renderStep4(); break;
            case 5: html = renderStep5(); break;
            case 6: html = renderStep6(); break;
            case 7: html = renderStep7(); break;
            case 8: html = renderStep8(); break;
            default: html = renderStep1();
        }
        
        content.innerHTML = html;
        
        // Initialize interactive elements based on current step
        setTimeout(() => {
            switch(currentStep) {
                case 2: initAcceptance(); break;
                case 3: initWillingHands(); break;
                case 4: initHalfSmile(); break;
                case 5: initCompassion(); break;
                case 6: initCompassionBreak(); break;
                case 7: initDefusion(); break;
                case 8: initComplete(); break;
            }
        }, 100);
    }
    
    // Expose functions globally
    window.nextStep = nextStep;
    window.previousStep = previousStep;
    window.goToStep = goToStep;
    
    // Initialize
    loadProgress();
    render();
})();
</script>
</body>
</html>
