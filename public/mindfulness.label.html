<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Just The Facts">
    <meta name="theme-color" content="#0f172a">
    <meta name="format-detection" content="telephone=no">
    <title>Just The Facts - MPHaven</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
    <style>
        :root{--bg-dark:#0f172a;--bg-card:rgba(15,23,42,.98);--border-subtle:rgba(30,41,59,.5);--primary-teal:#0e7490;--accent-amber:#d97706;--drama-red:#dc2626;--text-primary:#f1f5f9;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--text-teal:#5eead4;--text-amber:#fbbf24;--success-emerald:#4ade80;--gradient-main:linear-gradient(135deg,#0e7490,#d97706)}
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
        html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-dark);color:var(--text-primary);-webkit-overflow-scrolling:touch}
        .container{width:100%;height:100vh;height:-webkit-fill-available;display:flex;flex-direction:column}
        .app-wrapper{width:100%;max-width:28rem;height:100%;margin:0 auto;background:var(--bg-card);display:flex;flex-direction:column;position:relative;overflow:hidden}
        .bg-blur-1,.bg-blur-2{position:absolute;border-radius:50%;filter:blur(140px);pointer-events:none;z-index:0;opacity:.6}
        .bg-blur-1{top:-5%;left:50%;transform:translateX(-50%);width:22rem;height:22rem;background:rgba(14,116,144,.08)}
        .bg-blur-2{bottom:-5%;right:-5%;width:18rem;height:18rem;background:rgba(217,119,6,.08)}
        .main-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;position:relative;z-index:1}
        .main-content::-webkit-scrollbar{display:none}
        .content-wrapper{padding:1rem 1.25rem 2rem;padding-bottom:calc(2rem + env(safe-area-inset-bottom))}
        .card{background:linear-gradient(135deg,rgba(30,41,59,.65),rgba(15,23,42,.45));border:1px solid rgba(51,65,85,.4);border-radius:1.25rem;padding:1.5rem;margin-bottom:1rem;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
        .skill-header{background:var(--gradient-main)}
        .btn{color:#fff;font-weight:600;border:none;padding:1rem;border-radius:1rem;cursor:pointer;width:100%;font-size:1rem;transition:all .3s ease;-webkit-appearance:none;touch-action:manipulation}
        .btn-primary{background:var(--gradient-main);box-shadow:0 4px 16px rgba(14,116,144,.2)}
        .btn-primary:hover,.btn-primary:active{opacity:.92;transform:translateY(-2px)}
        .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
        .progress-dots{display:flex;gap:.25rem}
        .progress-dot{flex:1;height:.5rem;background:rgba(148,163,184,.25);border-radius:9999px}
        .progress-dot.active{background:var(--gradient-main)}
        @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
        .step-transition{animation:fadeIn .4s ease-out}
        .checkbox-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem}
        .checkbox-label{display:flex;align-items:center;gap:.5rem;padding:.75rem;background:rgba(30,41,59,.5);border:1px solid rgba(51,65,85,.4);border-radius:.75rem;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
        .checkbox-label:hover,.checkbox-label:active{border-color:rgba(14,116,144,.5);background:rgba(14,116,144,.12)}
        .checkbox-label.checked{border-color:rgba(14,116,144,.6);background:rgba(14,116,144,.18)}
        input[type="checkbox"]{width:1.25rem;height:1.25rem;cursor:pointer;accent-color:var(--primary-teal)}
        textarea{width:100%;padding:.75rem;border-radius:.75rem;border:1px solid rgba(51,65,85,.4);background:rgba(30,41,59,.5);color:#fff;font-size:1rem;min-height:100px;resize:vertical;-webkit-appearance:none;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
        input[type="range"]{width:100%;height:6px;background:rgba(30,41,59,.7);border-radius:10px;outline:0;-webkit-appearance:none}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:var(--primary-teal);cursor:pointer;border:none}
        input[type="text"]{width:100%;padding:.75rem;border-radius:.75rem;border:1px solid rgba(51,65,85,.4);background:rgba(30,41,59,.5);color:#fff;font-size:1rem;-webkit-appearance:none;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
        .char-counter{font-size:.875rem;color:var(--text-muted);text-align:right;margin-top:.5rem}
        .char-counter.active{color:var(--text-teal);font-weight:600}
        .feedback-toast{position:fixed;bottom:calc(2rem + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%) translateY(100px);background:rgba(14,116,144,.95);color:#fff;padding:1rem 1.5rem;border-radius:.75rem;z-index:1000;opacity:0;transition:all .3s ease;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
        .feedback-toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .hidden{display:none!important}
        .relief-emoji{font-size:2rem;margin-bottom:.5rem}
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none){.container{height:-webkit-fill-available}}
        input,textarea{font-size:16px!important} /* Prevents iOS zoom on focus */
        input:focus,textarea:focus{font-size:16px!important}
        button{cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
    </style>
</head>
<body>
<div class="container">
    <div class="app-wrapper">
        <div class="bg-blur-1"></div>
        <div class="bg-blur-2"></div>
        <div class="main-content">
            <div class="content-wrapper" id="content"></div>
        </div>
    </div>
</div>
<div id="feedbackToast" class="feedback-toast"></div>

<script>
    // Load confetti
    const confettiScript = document.createElement('script');
    confettiScript.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js';
    confettiScript.onload = initApp;
    document.head.appendChild(confettiScript);

    // Global variables
    let userInput = {
        dramaStory: "",
        factStory: "",
        relief: 5,
        diffWord: "",
        dramaWords: []
    };
    let currentStep = 1;
    const TOTAL_STEPS = 7;
    const stepTitles = {
        1: "The Drama Multiplier",
        2: "Your Blockbuster Drama",
        3: "Soap Opera vs News Report",
        4: "The Reporter Handbook",
        5: "Write Your News Report",
        6: "Drama Detector",
        7: "Your Press Pass"
    };

    function initApp() {
        // Check if iOS Safari
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS && isSafari) {
            // iOS Safari specific optimizations
            document.body.style.cursor = 'pointer';
        }
        
        if (loadProgress()) {
            render();
        } else {
            render();
        }
        
        // Prevent pull-to-refresh on iOS
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
            }
        }, { passive: false });
    }

    function autoSave() {
        localStorage.setItem("factsProgress", JSON.stringify({
            step: currentStep,
            userInput: userInput,
            timestamp: Date.now()
        }));
    }

    function loadProgress() {
        const saved = localStorage.getItem("factsProgress");
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if ((Date.now() - data.timestamp) / 3600000 < 24 && confirm("Resume where you left off?")) {
                    currentStep = data.step;
                    Object.assign(userInput, data.userInput);
                    return true;
                }
            } catch (e) {
                console.error("Error loading progress:", e);
            }
        }
        return false;
    }

    function showFeedback(message, duration = 2000) {
        const toast = document.getElementById("feedbackToast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
            toast.classList.remove("show");
        }, duration);
    }

    function renderHeader() {
        return `
            <div class="card" style="padding:1rem;margin-bottom:1rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
                    <button onclick="goBack()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:.25rem;-webkit-tap-highlight-color:transparent">‚Üê</button>
                    <h1 style="font-weight:600;font-size:1.125rem">${stepTitles[currentStep]}</h1>
                    <div style="color:var(--text-muted);font-size:.875rem">${currentStep}/${TOTAL_STEPS}</div>
                </div>
                <div class="progress-dots">
                    ${Array(TOTAL_STEPS).fill().map((_, i) => 
                        `<div class="progress-dot ${i < currentStep ? "active" : ""}"></div>`
                    ).join("")}
                </div>
            </div>`;
    }

    function goBack() {
        if (currentStep > 1) {
            currentStep--;
            render();
        } else {
            // Go back in history or to homepage for iOS
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = "/"; // Fallback to homepage
            }
        }
    }

    function canProceed() {
        if (currentStep === 2) {
            return userInput.dramaStory.length >= 20;
        }
        if (currentStep === 5) {
            return userInput.factStory.length >= 10;
        }
        return true;
    }

    function updateButtonState() {
        document.querySelectorAll(".btn-primary").forEach(btn => {
            btn.disabled = !canProceed();
        });
    }

    function nextStep() {
        if (currentStep === 2) {
            const dramaText = document.getElementById("dramaText");
            if (dramaText) userInput.dramaStory = dramaText.value.trim();
            
            const checkedWords = Array.from(document.querySelectorAll(".checkbox-label.checked"))
                .map(el => el.querySelector("span").textContent);
            userInput.dramaWords = checkedWords;
        }
        
        if (currentStep === 5) {
            const factsText = document.getElementById("factsText");
            if (factsText) userInput.factStory = factsText.value.trim();
            
            const diffWord = document.getElementById("differenceWord");
            if (diffWord) userInput.diffWord = diffWord.value.trim();
            
            const reliefRating = document.getElementById("reliefRating");
            if (reliefRating) userInput.relief = parseInt(reliefRating.value);
        }
        
        autoSave();
        
        if (currentStep < TOTAL_STEPS) {
            currentStep++;
            render();
            document.querySelector(".main-content").scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }
    }

    function getReliefEmoji(value) {
        const emojis = ["üò´", "üò£", "üòï", "üòê", "üôÇ", "üòå", "üòä", "üòÅ", "‚ú®", "üåü"];
        return emojis[Math.min(Math.max(0, value - 1), 9)];
    }

    function updateReliefValue() {
        const value = document.getElementById("reliefRating").value;
        userInput.relief = value;
        const reliefVal = document.getElementById("reliefVal");
        const reliefEmoji = document.getElementById("reliefEmoji");
        const reliefDisplay = document.getElementById("reliefDisplay");
        
        if (reliefVal) reliefVal.textContent = value;
        if (reliefEmoji) reliefEmoji.textContent = getReliefEmoji(value);
        if (reliefDisplay) {
            if (value < 4) {
                reliefDisplay.style.background = "rgba(239, 68, 68, .2)";
            } else if (value < 7) {
                reliefDisplay.style.background = "rgba(217, 119, 6, .2)";
            } else {
                reliefDisplay.style.background = "rgba(14, 116, 144, .2)";
            }
        }
    }

    function downloadProgress() {
        const content = `JUST THE FACTS - MY TRANSFORMATION
${new Date().toLocaleDateString()}

üé≠ BEFORE (Drama):
"${userInput.dramaStory || "No drama story entered"}"

üì∞ AFTER (Facts):
"${userInput.factStory || "No facts version entered"}"

üìä My Relief: ${userInput.relief}/10
‚ú® One Word: "${userInput.diffWord || "N/A"}"

üí° Key Insight: See facts. Skip drama.
"Just give me the news report."`;
        
        try {
            // iOS Safari download handling
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                // iOS Safari can't download files directly, show content
                alert("üì± iOS Note: Copy your transformation below:\n\n" + content);
                navigator.clipboard.writeText(content).then(() => {
                    showFeedback("‚úì Copied to clipboard!", 3000);
                });
            } else {
                // Regular download for other browsers
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `Just-The-Facts-${new Date().toISOString().split("T")[0]}.txt`;
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showFeedback("‚úì Downloaded! Check your downloads folder.", 3000);
            }
            
            setTimeout(() => {
                if (typeof confetti === 'function') {
                    confetti({
                        particleCount: 60,
                        spread: 50,
                        origin: { y: 0.7 }
                    });
                }
            }, 300);
            
            const downloadBtn = document.querySelector('button[onclick="downloadProgress()"]');
            if (downloadBtn) {
                const originalHTML = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<span style="font-size:1.5rem">‚úì</span> <span>Downloaded!</span>';
                downloadBtn.style.background = "var(--success-emerald)";
                downloadBtn.disabled = true;
                
                setTimeout(() => {
                    downloadBtn.innerHTML = originalHTML;
                    downloadBtn.style.background = "var(--gradient-main)";
                    downloadBtn.disabled = false;
                }, 2500);
            }
            
            localStorage.setItem("moduleCompleted", JSON.stringify({
                moduleId: "just-the-facts",
                completed: true,
                timestamp: new Date().toISOString()
            }));
        } catch (error) {
            console.error("Download failed:", error);
            showFeedback("Download failed. Please try again.", 3000);
        }
    }

    function returnToCourse() {
        localStorage.removeItem("factsProgress");
        // Check if we're in an app or browser
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        
        if (isStandalone) {
            // If installed as PWA, go to app homepage
            window.location.href = "/";
        } else if (window.history.length > 1) {
            // Try to go back
            window.history.back();
        } else {
            // Fallback to homepage
            window.location.href = "/";
        }
    }

    function render() {
        const content = document.getElementById("content");
        let html = "";
        
        switch (currentStep) {
            case 1:
                html = renderStep1();
                break;
            case 2:
                html = renderStep2();
                break;
            case 3:
                html = renderStep3();
                break;
            case 4:
                html = renderStep4();
                break;
            case 5:
                html = renderStep5();
                break;
            case 6:
                html = renderStep6();
                break;
            case 7:
                html = renderStep7();
                break;
            default:
                html = renderStep1();
        }
        
        content.innerHTML = html;
        
        setTimeout(() => {
            const mainContent = document.querySelector(".main-content");
            if (mainContent) {
                mainContent.scrollTop = 0;
            }
        }, 50);
    }

    function renderStep1() {
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card skill-header" style="padding:2rem;text-align:center;margin-bottom:1rem">
                    <div style="font-size:4rem;margin-bottom:1rem">üßÆ</div>
                    <h2 style="color:#fff;font-size:1.75rem;font-weight:700;margin-bottom:1.5rem">The Drama Multiplier</h2>
                    <div style="font-family:monospace;font-size:1.5rem;padding:1rem;background:rgba(30,41,59,.5);border-radius:1rem;margin:1rem 0">
                        What Happened<br>
                        <span style="font-size:2rem;color:var(--text-teal)">+</span><br>
                        Your Story<br>
                        <span style="font-size:2rem;color:#fca5a5">=</span><br>
                        <span style="background:rgba(14,116,144,.3);padding:.25rem .5rem;border-radius:.5rem">Suffering √ó 10</span>
                    </div>
                    <div style="background:rgba(255,255,255,.1);padding:1.25rem;border-radius:1rem;margin:1.5rem 0">
                        <p style="color:#fff;font-weight:600;margin-bottom:.5rem">Example:</p>
                        <p style="color:rgba(255,255,255,.9);font-size:1rem;line-height:1.6">
                            Friend is 15 minutes late<br>
                            <span style="color:var(--text-teal)">Fact:</span> They're not here yet<br>
                            <span style="color:#fca5a5">Story:</span> "They don't respect me!"<br>
                            <span style="color:#fff;font-weight:600">Result:</span> 10√ó more suffering
                        </p>
                    </div>
                    <div style="background:rgba(14,116,144,.18);border:1px solid rgba(14,116,144,.35);padding:.5rem 1rem;border-radius:2rem;font-size:.875rem;color:var(--text-teal);font-weight:500;display:inline-block">
                        You'll learn to skip the story
                    </div>
                </div>
                <button onclick="nextStep()" class="btn btn-primary">See How It Works ‚Üí</button>
            </div>`;
    }

    function renderStep2() {
        setTimeout(() => {
            const dramaText = document.getElementById("dramaText");
            const charCounter = document.getElementById("charCounter");
            
            if (dramaText) {
                dramaText.addEventListener("input", (e) => {
                    const length = e.target.value.length;
                    userInput.dramaStory = e.target.value;
                    if (charCounter) {
                        charCounter.textContent = `${length} characters${length < 20 ? " (min 20)" : ""}`;
                        if (length >= 20) {
                            charCounter.classList.add("active");
                        } else {
                            charCounter.classList.remove("active");
                        }
                    }
                    updateButtonState();
                });
                dramaText.dispatchEvent(new Event("input"));
                
                // iOS keyboard handling
                dramaText.addEventListener('blur', () => {
                    window.scrollTo(0, 0);
                });
            }
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const label = checkbox.closest(".checkbox-label");
                const word = label.querySelector("span").textContent;
                
                if (userInput.dramaWords && userInput.dramaWords.includes(word)) {
                    checkbox.checked = true;
                    label.classList.add("checked");
                }
                
                checkbox.addEventListener("change", (e) => {
                    if (e.target.checked) {
                        label.classList.add("checked");
                    } else {
                        label.classList.remove("checked");
                    }
                });
                
                // iOS touch handling
                label.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                });
                label.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
            
            updateButtonState();
        }, 100);
        
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card" style="background:rgba(217,119,6,.15);border:1px solid rgba(217,119,6,.35)">
                    <div style="font-size:3rem;margin-bottom:.75rem;text-align:center">üé¨</div>
                    <h2 style="font-size:1.5rem;font-weight:600;margin-bottom:1rem;text-align:center">Your Blockbuster Drama</h2>
                    <p style="color:var(--text-secondary);text-align:center;font-size:1rem">Make your problem into a movie. Really feel the drama.</p>
                </div>
                <div class="card">
                    <p style="font-size:1.05rem;font-weight:600;margin-bottom:1.5rem">Director's Instructions:</p>
                    ${["Think of something mildly annoying", "Now make it a blockbuster drama", 'Use words like "ALWAYS," "NEVER," "DISASTER"', "Really feel how awful it is"].map((instruction, index) => `
                        <div style="display:flex;gap:1rem;margin-bottom:1.5rem;align-items:start">
                            <div style="width:2.25rem;height:2.25rem;background:var(--gradient-main);border-radius:.5rem;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex-shrink:0">${index + 1}</div>
                            <p style="color:var(--text-secondary);padding-top:.375rem;line-height:1.6;font-size:1rem">${instruction}</p>
                        </div>
                    `).join("")}
                </div>
                <div class="card" style="border:2px solid rgba(220,38,38,.4);background:rgba(220,38,38,.05)">
                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem">
                        <span style="font-size:1.5rem">üé≠</span>
                        <h3 style="color:#fca5a5;font-weight:600;font-size:1.125rem">Drama Script:</h3>
                    </div>
                    <div class="checkbox-grid" style="margin-bottom:1.5rem">
                        ${["ALWAYS / NEVER", "DISASTER / RUINED", "TOTALLY / COMPLETELY", "SHOULD HAVE / FAILED", "IMPOSSIBLE / UNBEARABLE"].map(word => `
                            <label class="checkbox-label">
                                <input type="checkbox">
                                <span style="color:var(--text-secondary);font-size:.9375rem">${word}</span>
                            </label>
                        `).join("")}
                    </div>
                    <p style="font-weight:600;margin-bottom:.75rem;font-size:1rem">Write your dramatic version:</p>
                    <textarea id="dramaText" placeholder="Let the drama pour out... make it a blockbuster movie scene...">${userInput.dramaStory}</textarea>
                    <div id="charCounter" class="char-counter">0 characters (min 20)</div>
                </div>
                <button onclick="nextStep()" class="btn btn-primary">See The Two Versions ‚Üí</button>
            </div>`;
    }

    function renderStep3() {
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card" style="text-align:center;padding:1.5rem;margin-bottom:1rem">
                    <div style="font-size:3rem;margin-bottom:1rem">üéûÔ∏è</div>
                    <h2 style="font-size:1.5rem;font-weight:600;margin-bottom:.5rem">Soap Opera vs News Report</h2>
                    <p style="color:var(--text-secondary)">Your brain makes soap operas. Life is just news reports.</p>
                </div>
                <div class="card" style="border:2px solid rgba(220,38,38,.45);background:rgba(220,38,38,.08);margin-bottom:1rem">
                    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                        <div style="font-size:2rem">üé≠</div>
                        <div>
                            <h3 style="color:#fca5a5;font-weight:600;font-size:1.25rem">SOAP OPERA VERSION</h3>
                            <p style="color:#fca5a5;font-size:.875rem;font-weight:500">Drama, feelings, stories</p>
                        </div>
                    </div>
                    ${["DESTROYED MY DAY!", "THEY HATE ME!", "COMPLETE FAILURE!"].map(drama => `
                        <div style="background:rgba(220,38,38,.1);padding:1rem;border-radius:.75rem;margin-bottom:1rem">
                            <p style="color:#fca5a5;font-size:1.1rem;font-weight:600">"${drama}"</p>
                        </div>
                    `).join("")}
                </div>
                <div style="text-align:center;font-size:2rem;margin:1rem 0">‚¨áÔ∏è</div>
                <div class="card" style="border:2px solid rgba(14,116,144,.45);background:rgba(14,116,144,.08);margin-bottom:1rem">
                    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                        <div style="font-size:2rem">üì∞</div>
                        <div>
                            <h3 style="color:var(--text-teal);font-weight:600;font-size:1.25rem">NEWS REPORT VERSION</h3>
                            <p style="color:var(--text-teal);font-size:.875rem;font-weight:500">Facts, times, what happened</p>
                        </div>
                    </div>
                    ${["RAINED FOR 2 HOURS", "NO REPLY YET", "SCORED 65%"].map(fact => `
                        <div style="background:rgba(14,116,144,.1);padding:1rem;border-radius:.75rem;margin-bottom:1rem">
                            <p style="color:var(--text-teal);font-size:1.1rem;font-weight:600">"${fact}"</p>
                        </div>
                    `).join("")}
                </div>
                <button onclick="nextStep()" class="btn btn-primary">Learn News Reporter Rules ‚Üí</button>
            </div>`;
    }

    function renderStep4() {
        const rules = [
            {rule: "1", title: "Just what happened", example: '"Website crashed at 2:30 PM"', note: 'Not "disaster"'},
            {rule: "2", title: "Times, numbers, facts", example: '"Missed 3 deadlines this month"', note: 'Not "failing"'},
            {rule: "3", title: 'No "always/never"', example: '"They said \'no thanks\'"', note: 'Not "they hate me"'},
            {rule: "4", title: "No mind-reading", example: '"Meeting lasted 2 hours"', note: 'Not "unbearable"'},
            {rule: "5", title: "Does the feeling fit ONLY the facts?", example: 'Feeling: "Annoyed" ‚Üí ‚úÖ Fits', note: "(If not, story alert!)"}
        ];
        
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card skill-header" style="padding:1.75rem;margin-bottom:1rem">
                    <div style="font-size:3rem;margin-bottom:.75rem;text-align:center">üìò</div>
                    <h2 style="color:#fff;font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:.5rem">The Reporter Handbook</h2>
                    <p style="color:rgba(255,255,255,.9);text-align:center;font-size:1rem">5 rules for "just the facts"</p>
                </div>
                ${rules.map(rule => `
                    <div class="card" style="border-left:4px solid ${rule.rule === "5" ? "var(--accent-amber)" : "var(--primary-teal)"}; background:${rule.rule === "5" ? "rgba(217,119,6,.08)" : "rgba(14,116,144,.08)"}">
                        <div style="display:flex;align-items:start;gap:1rem;margin-bottom:.75rem">
                            <div style="background:${rule.rule === "5" ? "rgba(217,119,6,.2)" : "rgba(14,116,144,.2)"}; color:${rule.rule === "5" ? "var(--text-amber)" : "var(--text-teal)"}; width:2rem;height:2rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">
                                ${rule.rule}
                            </div>
                            <div>
                                <h3 style="color:${rule.rule === "5" ? "var(--text-amber)" : "var(--text-teal)"};font-weight:600;font-size:1.125rem;margin-bottom:.25rem">${rule.title}</h3>
                                <p style="color:var(--text-secondary);font-size:.9375rem">${rule.note}</p>
                            </div>
                        </div>
                        <div style="background:${rule.rule === "5" ? "rgba(217,119,6,.1)" : "rgba(14,116,144,.1)"};padding:.75rem;border-radius:.5rem;margin-top:.5rem">
                            <p style="color:${rule.rule === "5" ? "var(--text-amber)" : "var(--text-teal)"};font-weight:500;font-size:.9375rem">${rule.example}</p>
                        </div>
                    </div>
                `).join("")}
                <button onclick="nextStep()" class="btn btn-primary">Now Write Your News Report ‚Üí</button>
            </div>`;
    }

    function renderStep5() {
        setTimeout(() => {
            const factsText = document.getElementById("factsText");
            const factsCounter = document.getElementById("factsCounter");
            const reliefRating = document.getElementById("reliefRating");
            const differenceWord = document.getElementById("differenceWord");
            
            if (factsText) {
                factsText.addEventListener("input", (e) => {
                    const length = e.target.value.length;
                    userInput.factStory = e.target.value;
                    if (factsCounter) {
                        factsCounter.textContent = `${length} characters${length < 10 ? " (min 10)" : ""}`;
                        if (length >= 10) {
                            factsCounter.classList.add("active");
                        } else {
                            factsCounter.classList.remove("active");
                        }
                    }
                    updateButtonState();
                });
                factsText.dispatchEvent(new Event("input"));
                
                // iOS keyboard handling
                factsText.addEventListener('blur', () => {
                    window.scrollTo(0, 0);
                });
            }
            
            if (reliefRating) {
                reliefRating.value = userInput.relief;
                updateReliefValue();
            }
            
            if (differenceWord) {
                differenceWord.value = userInput.diffWord;
                
                // iOS keyboard handling
                differenceWord.addEventListener('blur', () => {
                    window.scrollTo(0, 0);
                });
            }
            
            updateButtonState();
        }, 100);
        
        const dramaPreview = userInput.dramaStory ? `
            <div class="card" style="border-left:4px solid var(--drama-red);background:rgba(220,38,38,.08)">
                <p style="font-weight:600;margin-bottom:.75rem;font-size:1rem">üé≠ Your Drama Version:</p>
                <p style="color:var(--text-secondary);font-style:italic;line-height:1.6;font-size:1rem">"${userInput.dramaStory}"</p>
            </div>
            <div style="text-align:center;font-size:2rem;margin:1rem 0">‚¨áÔ∏è</div>
        ` : "";
        
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card skill-header" style="padding:1.75rem;margin-bottom:1rem">
                    <div style="font-size:3rem;margin-bottom:.75rem;text-align:center">‚úçÔ∏è</div>
                    <h2 style="color:#fff;font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:.5rem">Write Your News Report</h2>
                    <p style="color:rgba(255,255,255,.9);text-align:center;font-size:1rem">Take your drama. Report just the facts.</p>
                </div>
                ${dramaPreview}
                <div class="card" style="border-left:4px solid var(--primary-teal);background:rgba(14,116,144,.08)">
                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem">
                        <span style="font-size:1.5rem">üì∞</span>
                        <h3 style="color:var(--text-teal);font-weight:600;font-size:1.125rem">Be a News Reporter:</h3>
                    </div>
                    <p style="font-size:1.05rem;margin-bottom:1rem">Your fact-based news report:</p>
                    <textarea id="factsText" placeholder="Just the facts... what actually happened? When? How long? What was said?...">${userInput.factStory}</textarea>
                    <div id="factsCounter" class="char-counter">0 characters (min 10)</div>
                </div>
                <div class="card">
                    <p style="font-weight:600;margin-bottom:1.5rem;font-size:1.125rem;text-align:center">How much lighter does the facts version feel?</p>
                    <div style="margin-bottom:2rem">
                        <input type="range" min="1" max="10" value="${userInput.relief || 5}" id="reliefRating" style="width:100%;margin-bottom:1rem" oninput="updateReliefValue()">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span style="color:var(--text-muted);font-size:.875rem">Same weight</span>
                            <div id="reliefDisplay" style="background:rgba(14,116,144,.2);padding:.5rem 1.25rem;border-radius:.75rem;min-width:3rem;text-align:center">
                                <span id="reliefVal" style="color:var(--text-teal);font-weight:700;font-size:1.5rem">${userInput.relief || 5}</span>
                                <div id="reliefEmoji" class="relief-emoji">${getReliefEmoji(userInput.relief || 5)}</div>
                            </div>
                            <span style="color:var(--text-muted);font-size:.875rem">Much lighter</span>
                        </div>
                    </div>
                    <p style="font-weight:600;margin-bottom:1rem;font-size:1rem">One word for how this feels:</p>
                    <input type="text" id="differenceWord" placeholder="e.g., freeing, clearer, lighter..." value="${userInput.diffWord}" style="width:100%;padding:.75rem;border-radius:.75rem;border:1px solid rgba(51,65,85,.4);background:rgba(30,41,59,.5);color:#fff;font-size:1rem">
                </div>
                <button onclick="nextStep()" class="btn btn-primary" style="margin-top:1rem">Continue ‚Üí</button>
            </div>`;
    }

    function renderStep6() {
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card" style="text-align:center;padding:1.5rem;margin-bottom:1rem">
                    <div style="font-size:3rem;margin-bottom:1rem">üîç</div>
                    <h2 style="font-size:1.5rem;font-weight:600;margin-bottom:.5rem">Drama Detector</h2>
                    <p style="color:var(--text-secondary)">Spot drama. Report facts. That's the skill.</p>
                </div>
                <div class="card">
                    <h3 style="font-weight:600;margin-bottom:1.5rem;font-size:1.125rem">Daily Practice:</h3>
                    <div style="margin-bottom:1.5rem">
                        <p style="font-weight:600;margin-bottom:.75rem;font-size:1rem">üéØ What to look for:</p>
                        ${["ALWAYS / NEVER (patterns)", "DISASTER / RUINED (evaluations)", "SHOULD / SHOULDN'T (judgments)", "HATE / LOVE (about situations)", "UNBEARABLE / IMPOSSIBLE (catastrophizing)"].map(item => `
                            <div style="display:flex;align-items:center;gap:.75rem;padding:.75rem;margin-bottom:.5rem;background:rgba(220,38,38,.1);border-radius:.75rem">
                                <span style="color:#fca5a5;font-size:1.25rem">‚ùå</span>
                                <span style="color:var(--text-secondary)">${item}</span>
                            </div>
                        `).join("")}
                    </div>
                    <div>
                        <p style="font-weight:600;margin-bottom:.75rem;font-size:1rem">‚úÖ What to replace with:</p>
                        ${["This time / Once (specific)", "Problem to fix (neutral)", "What happened (facts)", "Preference / Choice (neutral)", "Challenge / Situation (neutral)"].map(item => `
                            <div style="display:flex;align-items:center;gap:.75rem;padding:.75rem;margin-bottom:.5rem;background:rgba(14,116,144,.1);border-radius:.75rem">
                                <span style="color:var(--text-teal);font-size:1.25rem">‚úÖ</span>
                                <span style="color:var(--text-secondary)">${item}</span>
                            </div>
                        `).join("")}
                    </div>
                </div>
                <div class="card" style="background:rgba(14,116,144,.1);border:1px solid rgba(14,116,144,.3)">
                    <h3 style="color:var(--text-teal);font-weight:600;margin-bottom:1rem;font-size:1.05rem">‚ú® Your Power Move:</h3>
                    <div style="color:var(--text-secondary);line-height:1.7;font-size:1rem">
                        <p style="margin-bottom:1rem">When you feel heavy emotion:</p>
                        <div style="background:rgba(14,116,144,.15);padding:1rem;border-radius:.75rem;margin:1rem 0">
                            <p style="color:var(--text-teal);font-weight:600;text-align:center;font-size:1.125rem">"Just give me the news report."</p>
                        </div>
                        <p>That's it. That's the skill.</p>
                    </div>
                </div>
                <button onclick="nextStep()" class="btn btn-primary" style="margin-top:1rem">Get Your Press Pass ‚Üí</button>
            </div>`;
    }

    function renderStep7() {
        setTimeout(() => {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }, 500);
        
        const dramaPreview = userInput.dramaStory || "No dramatic story was entered";
        const factsPreview = userInput.factStory || "No factual rewrite was entered";
        const diffWord = userInput.diffWord || "Clearer";
        
        return `
            <div class="step-transition">
                ${renderHeader()}
                <div class="card skill-header" style="padding:1.5rem;text-align:center;margin-bottom:1rem">
                    <div style="font-size:3.5rem;margin-bottom:.75rem">üèÜ</div>
                    <h2 style="color:#fff;font-size:1.75rem;font-weight:700;margin-bottom:.5rem">OFFICIAL NEWS REPORTER</h2>
                    <p style="color:rgba(255,255,255,.9);font-size:.9375rem">CERTIFIED: Just The Facts</p>
                </div>
                ${userInput.dramaStory && userInput.factStory ? `
                    <div class="card">
                        <h3 style="font-weight:600;margin-bottom:1.5rem;font-size:1.25rem;text-align:center">Your Transformation:</h3>
                        <div style="margin-bottom:1.5rem;padding:1.25rem;background:rgba(220,38,38,.08);border-radius:.875rem;border-left:3px solid var(--drama-red)">
                            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
                                <span style="font-size:1.5rem">üé≠</span>
                                <p style="font-size:.875rem;color:#fca5a5;font-weight:600">Before (Soap Opera)</p>
                            </div>
                            <p style="color:var(--text-secondary);font-style:italic;line-height:1.6">"${dramaPreview.slice(0,200)}${dramaPreview.length > 200 ? "..." : ""}"</p>
                        </div>
                        <div style="text-align:center;font-size:1.5rem;margin:1rem 0">‚¨áÔ∏è</div>
                        <div style="margin-bottom:1.5rem;padding:1.25rem;background:rgba(14,116,144,.08);border-radius:.875rem;border-left:3px solid var(--primary-teal)">
                            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem">
                                <span style="font-size:1.5rem">üì∞</span>
                                <p style="font-size:.875rem;color:var(--text-teal);font-weight:600">After (News Report)</p>
                            </div>
                            <p style="color:var(--text-teal);font-weight:500;line-height:1.6">"${factsPreview.slice(0,200)}${factsPreview.length > 200 ? "..." : ""}"</p>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(14,116,144,.1),rgba(217,119,6,.1));padding:1.5rem;border-radius:.875rem;border:1px solid rgba(14,116,144,.2);text-align:center">
                            <p style="color:var(--text-secondary);font-size:.9375rem;margin-bottom:.75rem">You described this shift as:</p>
                            <h3 style="color:#fff;font-size:1.75rem;margin:.75rem 0;font-weight:700">"${diffWord}"</h3>
                            <div style="display:flex;justify-content:center;align-items:center;gap:.75rem;margin-top:1rem">
                                <span style="font-size:.875rem;color:var(--text-muted)">Relief Level:</span>
                                <span style="background:rgba(14,116,144,.25);color:var(--text-teal);padding:.375rem 1rem;border-radius:2rem;font-weight:700;font-size:1.125rem">${userInput.relief}/10</span>
                                <span style="font-size:1.5rem">${getReliefEmoji(userInput.relief)}</span>
                            </div>
                        </div>
                    </div>
                ` : ""}
                <div class="card">
                    <h3 style="font-weight:600;font-size:1.125rem;margin-bottom:1.25rem;text-align:center">Save Your Progress</h3>
                    <div style="display:grid;gap:.75rem">
                        <button onclick="downloadProgress()" class="btn btn-primary" style="display:flex;align-items:center;justify-content:center;gap:.75rem;padding:1.25rem">
                            <span style="font-size:1.5rem">üíæ</span>
                            <span>Download My Transformation</span>
                        </button>
                        <button onclick="returnToCourse()" style="width:100%;padding:1.25rem;border-radius:1rem;background:transparent;border:2px solid rgba(148,163,184,.4);color:var(--text-muted);font-weight:600;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:.75rem;cursor:pointer">
                            <span style="font-size:1.5rem">‚Üê</span>
                            <span>Return to Course</span>
                        </button>
                    </div>
                </div>
                <div style="background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);padding:1rem;margin-top:.5rem;text-align:center;border-radius:.75rem">
                    <p style="color:var(--success-emerald);font-size:.875rem;font-weight:500">üå± You've mastered: See facts. Skip drama. Just give me the news report.</p>
                </div>
            </div>`;
    }

    // Make functions globally available
    window.goBack = goBack;
    window.nextStep = nextStep;
    window.updateReliefValue = updateReliefValue;
    window.downloadProgress = downloadProgress;
    window.returnToCourse = returnToCourse;
</script>
</body>
</html>
