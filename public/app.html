<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0f1e">
<title>MPHaven</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0f1e;
  --bg-card: rgba(12, 18, 34, 0.97);
  --bg-glass: rgba(255,255,255,0.04);
  --bg-glass-hover: rgba(255,255,255,0.07);
  --border: rgba(255,255,255,0.08);
  --border-active: rgba(255,255,255,0.15);

  /* Core palette â€” deep teal + warm amber + soft rose */
  --teal: #0d9488;
  --teal-light: #5eead4;
  --teal-dim: rgba(13,148,136,0.2);
  --amber: #d97706;
  --amber-light: #fbbf24;
  --amber-dim: rgba(217,119,6,0.18);
  --rose: #e11d48;
  --rose-dim: rgba(225,29,72,0.15);
  --indigo: #6366f1;
  --indigo-dim: rgba(99,102,241,0.18);
  --emerald: #10b981;
  --emerald-dim: rgba(16,185,129,0.15);

  --text-1: #f1f5f9;
  --text-2: #94a3b8;
  --text-3: #475569;
  --text-teal: #5eead4;
  --text-amber: #fbbf24;

  --grad-main: linear-gradient(135deg, #0d9488, #d97706);
  --grad-subtle: linear-gradient(135deg, rgba(13,148,136,0.12), rgba(217,119,6,0.08));
  --grad-teal: linear-gradient(135deg, rgba(13,148,136,0.25), rgba(13,148,136,0.08));

  --shadow: 0 25px 50px -12px rgba(0,0,0,0.4);
  --shadow-sm: 0 4px 16px rgba(0,0,0,0.2);

  --font-display: 'Fraunces', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;

  --radius-xl: 1.5rem;
  --radius-lg: 1.125rem;
  --radius-md: .875rem;
  --radius-full: 9999px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing:antialiased; }
html, body { width:100%; height:100%; overflow:hidden; position:fixed; overscroll-behavior:none; }
body { background:var(--bg); font-family:var(--font-body); }

/* Layout */
.shell { width:100%; height:100vh; height:100dvh; display:flex; flex-direction:column; }
.pane { width:100%; max-width:28rem; height:100%; margin:0 auto; background:var(--bg-card); display:flex; flex-direction:column; position:relative; border-left:1px solid var(--border); border-right:1px solid var(--border); overflow:hidden; }

/* Atmospheric blobs */
.blob { position:absolute; border-radius:50%; pointer-events:none; z-index:0; filter:blur(120px); transition:opacity 2s ease; }
.blob-1 { top:-10%; left:20%; width:20rem; height:20rem; background:rgba(13,148,136,0.07); opacity:.8; }
.blob-2 { bottom:0; right:-10%; width:18rem; height:18rem; background:rgba(217,119,6,0.06); opacity:.7; }

/* Scroll area */
.scroll { flex:1; overflow-y:auto; overflow-x:hidden; position:relative; z-index:1; -webkit-overflow-scrolling:touch; scrollbar-width:none; scroll-behavior:smooth; }
.scroll::-webkit-scrollbar { display:none; }
.pad { padding:1.5rem; padding-bottom:7rem; min-height:100%; }

/* Nav */
.nav { position:relative; z-index:100; background:var(--bg-card); border-top:1px solid var(--border); backdrop-filter:blur(24px); padding:.625rem 0; padding-bottom:calc(.625rem + env(safe-area-inset-bottom)); }
.nav-inner { display:flex; align-items:center; justify-content:space-around; }
.nav-btn { display:flex; flex-direction:column; align-items:center; gap:.3rem; padding:.5rem 1.25rem; background:none; border:none; cursor:pointer; -webkit-tap-highlight-color:transparent; transition:opacity .15s; position:relative; }
.nav-btn:active { opacity:.6; }
.nav-dot { position:absolute; top:0; left:50%; transform:translateX(-50%); width:2rem; height:2.5px; border-radius:2px; background:var(--grad-main); opacity:0; transition:opacity .2s; }
.nav-dot.on { opacity:1; }
.nav-ico { width:22px; height:22px; transition:color .2s; }
.nav-ico.on { color:var(--text-1); }
.nav-ico.off { color:var(--text-3); }
.nav-lbl { font-size:.625rem; font-weight:600; letter-spacing:.04em; text-transform:uppercase; transition:color .2s; }
.nav-lbl.on { color:var(--text-1); }
.nav-lbl.off { color:var(--text-3); }

/* Typography */
.title-xl { font-family:var(--font-display); font-size:2.75rem; font-weight:400; color:var(--text-1); line-height:1.15; letter-spacing:-.02em; }
.title-xl em { font-style:italic; color:var(--text-teal); }
.title-md { font-family:var(--font-display); font-size:1.5rem; font-weight:400; color:var(--text-1); letter-spacing:-.01em; }
.section-label { font-size:.6875rem; font-weight:600; color:var(--text-3); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.875rem; }
.body-md { font-size:.9375rem; color:var(--text-2); line-height:1.6; }
.body-sm { font-size:.8125rem; color:var(--text-2); line-height:1.5; }

/* Cards */
.card { border-radius:var(--radius-xl); transition:transform .2s cubic-bezier(.4,0,.2,1), box-shadow .2s; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.card:active { transform:scale(.97); }
.card-glass { background:var(--bg-glass); border:1px solid var(--border); }
.card-glass:hover { background:var(--bg-glass-hover); border-color:var(--border-active); }

/* Check-in emotions */
.mood-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:.5rem; margin:.75rem 0; }
.mood-btn { display:flex; flex-direction:column; align-items:center; gap:.375rem; padding:.75rem .25rem; border-radius:var(--radius-md); border:1px solid var(--border); background:var(--bg-glass); cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all .2s; }
.mood-btn:active { transform:scale(.94); }
.mood-btn.selected { border-color:var(--teal); background:var(--teal-dim); }
.mood-emoji { font-size:1.375rem; line-height:1; }
.mood-word { font-size:.625rem; font-weight:600; color:var(--text-3); text-transform:uppercase; letter-spacing:.03em; transition:color .2s; }
.mood-btn.selected .mood-word { color:var(--text-teal); }

/* Progress ring */
.prog-ring { position:relative; display:inline-flex; align-items:center; justify-content:center; }
.prog-ring svg { transform:rotate(-90deg); }
.prog-ring-inner { position:absolute; text-align:center; }

/* Course track card */
.track-card { background:var(--bg-glass); border:1px solid var(--border); border-radius:var(--radius-xl); overflow:hidden; transition:all .2s; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.track-card:active { transform:scale(.98); }
.track-header { padding:1.25rem; display:flex; align-items:center; gap:1rem; }
.track-icon { width:3rem; height:3rem; border-radius:var(--radius-md); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.track-icon svg, .track-icon span { width:1.5rem; height:1.5rem; font-size:1.25rem; }
.track-modules { padding:0 1.25rem 1.25rem; display:grid; gap:.5rem; }
.module-row { display:flex; align-items:center; gap:.75rem; padding:.625rem .875rem; border-radius:var(--radius-md); background:rgba(0,0,0,0.2); }
.module-dot { width:.5rem; height:.5rem; border-radius:50%; flex-shrink:0; }
.module-dot.done { background:var(--teal); }
.module-dot.active { background:var(--amber); }
.module-dot.locked { background:var(--text-3); }

/* Breath orb */
.orb { width:130px; height:130px; border-radius:50%; background:radial-gradient(circle at 35% 35%, rgba(13,148,136,.8), rgba(217,119,6,.5)); margin:1.5rem auto; box-shadow:0 0 60px rgba(13,148,136,.3), 0 0 120px rgba(217,119,6,.15); will-change:transform,box-shadow; }

/* Streak dots */
.streak-row { display:flex; gap:.375rem; }
.streak-dot { width:1.875rem; height:.375rem; border-radius:3px; transition:background .3s; }
.streak-dot.done { background:var(--teal); }
.streak-dot.today { background:var(--amber); }
.streak-dot.empty { background:var(--border); }

/* Toast */
.toast { position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(20px); background:rgba(15,23,42,.95); border:1px solid var(--border-active); border-radius:var(--radius-md); padding:.875rem 1.25rem; color:var(--text-1); font-weight:600; font-size:.875rem; z-index:9999; opacity:0; transition:all .3s ease; backdrop-filter:blur(16px); box-shadow:var(--shadow); pointer-events:none; white-space:nowrap; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* Modal overlay */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:10000; opacity:0; visibility:hidden; transition:all .3s; backdrop-filter:blur(12px); }
.overlay.show { opacity:1; visibility:visible; }
.modal { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-xl); padding:2rem; max-width:320px; width:90%; box-shadow:var(--shadow); }

/* Utility */
.flex { display:flex; }
.flex-col { flex-direction:column; }
.items-center { align-items:center; }
.justify-between { justify-content:space-between; }
.gap-1 { gap:.5rem; }
.gap-2 { gap:1rem; }
.gap-3 { gap:1.5rem; }
.mt-1 { margin-top:.5rem; }
.mt-2 { margin-top:1rem; }
.mt-3 { margin-top:1.5rem; }
.mt-4 { margin-top:2rem; }
.mb-2 { margin-bottom:1rem; }
.mb-3 { margin-bottom:1.5rem; }
.mb-4 { margin-bottom:2rem; }
.w-full { width:100%; }
.text-center { text-align:center; }

/* Btn */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.875rem 1.5rem; border-radius:var(--radius-md); font-family:var(--font-body); font-weight:600; font-size:.9375rem; cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all .2s; border:none; }
.btn:active { transform:scale(.97); }
.btn-primary { background:var(--grad-main); color:white; }
.btn-ghost { background:var(--bg-glass); border:1px solid var(--border); color:var(--text-2); }
.btn-danger { background:rgba(225,29,72,.15); border:1.5px solid rgba(225,29,72,.4); color:#fca5a5; }

/* Fade in */
@keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.fade-up { animation:fadeUp .35s ease-out; }

/* Check-in follow-up */
.followup { background:var(--grad-teal); border:1px solid rgba(13,148,136,.3); border-radius:var(--radius-xl); padding:1.25rem; margin-top:1rem; }
.followup-q { font-size:1rem; font-weight:500; color:var(--text-teal); margin-bottom:.75rem; font-family:var(--font-display); font-style:italic; }
.followup-input { width:100%; background:rgba(0,0,0,.3); border:1px solid var(--border); border-radius:var(--radius-md); padding:.875rem 1rem; color:var(--text-1); font-family:var(--font-body); font-size:.9375rem; resize:none; outline:none; transition:border-color .2s; min-height:80px; }
.followup-input::placeholder { color:var(--text-3); }
.followup-input:focus { border-color:rgba(13,148,136,.5); }
.suggestion-card { background:rgba(217,119,6,.1); border:1px solid rgba(217,119,6,.25); border-radius:var(--radius-lg); padding:1rem 1.25rem; margin-top:.875rem; display:flex; align-items:center; gap:.875rem; cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all .2s; }
.suggestion-card:active { transform:scale(.97); }

/* Tools quick access */
.tool-pill { display:flex; align-items:center; gap:.75rem; padding:.875rem 1rem; background:var(--bg-glass); border:1px solid var(--border); border-radius:var(--radius-lg); cursor:pointer; -webkit-tap-highlight-color:transparent; transition:all .2s; }
.tool-pill:active { transform:scale(.97); background:var(--bg-glass-hover); }

/* Paywall lock */
.lock-badge { display:inline-flex; align-items:center; gap:.3rem; padding:.25rem .625rem; background:rgba(217,119,6,.15); border:1px solid rgba(217,119,6,.3); border-radius:var(--radius-full); font-size:.625rem; font-weight:700; color:var(--amber-light); text-transform:uppercase; letter-spacing:.05em; }

@media (min-width:640px) {
  .pane { border-radius:2.5rem; height:min(844px,100%); }
  .shell { padding:2rem; align-items:center; justify-content:center; }
}
</style>
</head>
<body>
<div class="shell">
  <div class="pane" id="pane">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="scroll" id="scroll">
      <div id="view" class="pad fade-up"></div>
    </div>

    <!-- Bottom Nav (4 tabs) -->
    <nav class="nav">
      <div class="nav-inner">
        <button class="nav-btn" onclick="go('today')">
          <div class="nav-dot on" id="dot-today"></div>
          <svg class="nav-ico on" id="ico-today" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
          <span class="nav-lbl on" id="lbl-today">Today</span>
        </button>
        <button class="nav-btn" onclick="go('learn')">
          <div class="nav-dot" id="dot-learn"></div>
          <svg class="nav-ico off" id="ico-learn" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
          <span class="nav-lbl off" id="lbl-learn">Learn</span>
        </button>
        <button class="nav-btn" onclick="go('tools')">
          <div class="nav-dot" id="dot-tools"></div>
          <svg class="nav-ico off" id="ico-tools" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z"/></svg>
          <span class="nav-lbl off" id="lbl-tools">Tools</span>
        </button>
        <button class="nav-btn" onclick="go('you')">
          <div class="nav-dot" id="dot-you"></div>
          <svg class="nav-ico off" id="ico-you" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
          <span class="nav-lbl off" id="lbl-you">You</span>
        </button>
      </div>
    </nav>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Logout modal -->
<div class="overlay" id="logoutModal">
  <div class="modal">
    <h3 style="font-family:var(--font-display);font-size:1.375rem;font-weight:400;color:var(--text-1);margin-bottom:.5rem">Log out?</h3>
    <p class="body-sm" style="margin-bottom:1.5rem">Your progress will be cleared from this device.</p>
    <div class="flex gap-1" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="hide('logoutModal')">Cancel</button>
      <button class="btn btn-danger" onclick="doLogout()">Log Out</button>
    </div>
  </div>
</div>

<!-- Crisis modal -->
<div class="overlay" id="crisisModal" style="z-index:20000">
  <div class="modal" style="max-width:340px">
    <div style="font-size:1.5rem;margin-bottom:.75rem">ğŸš¨</div>
    <h3 style="font-family:var(--font-display);font-size:1.375rem;font-weight:400;color:var(--text-1);margin-bottom:.5rem">Safety check</h3>
    <div style="background:rgba(225,29,72,.08);border:1px solid rgba(225,29,72,.2);border-radius:var(--radius-md);padding:1rem;margin-bottom:1.25rem">
      <p class="body-sm" style="font-weight:600;color:#fca5a5;margin-bottom:.5rem">Right now, are you experiencing:</p>
      <p class="body-sm">â€¢ Thoughts of suicide or self-harm?</p>
      <p class="body-sm">â€¢ Plans to hurt yourself or others?</p>
      <p class="body-sm">â€¢ Feeling unable to keep yourself safe?</p>
    </div>
    <div class="flex flex-col gap-1">
      <button class="btn btn-danger w-full" onclick="onCrisis(true)">Yes â€” Show crisis resources</button>
      <button class="btn btn-primary w-full" onclick="onCrisis(false)">No, I'm safe to continue</button>
    </div>
    <div id="crisisRes" style="display:none;margin-top:1.25rem;padding:1rem;background:rgba(0,0,0,.35);border-left:3px solid var(--rose);border-radius:.5rem">
      <p style="color:#fca5a5;font-weight:600;font-size:.9375rem;margin-bottom:.75rem">Please reach out now:</p>
      <p class="body-sm" style="margin-bottom:.375rem">â€¢ <a href="tel:988" style="color:#fca5a5;font-weight:700">988 Lifeline</a> â€” Call or text 988</p>
      <p class="body-sm" style="margin-bottom:.375rem">â€¢ <a href="sms:741741" style="color:#fca5a5;font-weight:700">Crisis Text Line</a> â€” Text HOME to 741741</p>
      <p class="body-sm">â€¢ <a href="tel:911" style="color:#fca5a5;font-weight:700">911</a> â€” Or go to nearest ER</p>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_V = '3.0';
const DISC_V = '3.0';
const CRISIS_TIMEOUT = 5 * 60 * 1000;

// â”€â”€ Content version â€” bump this each time you add a new course â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Change CONTENT_V to 2, 3, 4... with each quarterly release.
// Users who last saw an older version get a "New content" banner.
const CONTENT_V = 1;
const CONTENT_WHATS_NEW = {
  title: 'New: Getting Through the Storm',
  desc:  'Your crisis resilience toolkit is ready.',
  link:  'crisis-intro.html'
};

// â”€â”€ Re-engagement helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function daysSinceLastOpen() {
  const last = localStorage.getItem('mph_last_open');
  if (!last) return 0;
  return Math.floor((Date.now() - parseInt(last)) / 86400000);
}
function recordOpen() {
  localStorage.setItem('mph_last_open', Date.now().toString());
}
function seenContentV() {
  return parseInt(localStorage.getItem('mph_content_v') || '0');
}
function markContentSeen() {
  localStorage.setItem('mph_content_v', CONTENT_V.toString());
}
function dismissReengagement() {
  localStorage.setItem('mph_reeng_dismissed', Date.now().toString());
  render();
}
function dismissNewContent() {
  markContentSeen();
  render();
}
window.dismissReengagement = dismissReengagement;
window.dismissNewContent   = dismissNewContent;
window.requestPushPermission = async function() {
  if (!('Notification' in window)) { toast('Notifications not supported on this device'); return; }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    localStorage.setItem('mph_push_ok', 'true');
    scheduleDailyReminder();
    toast('Daily reminders on ğŸ””');
    render();
  } else {
    toast('Permission not granted â€” you can enable in settings');
  }
};
function scheduleDailyReminder() {
  // Web Notifications can't schedule future notifications natively â€”
  // this fires a same-session reminder demo and notes the preference.
  // Full scheduled push requires a service worker (add when going native).
  localStorage.setItem('mph_push_ok', 'true');
}
function pushEnabled() {
  return localStorage.getItem('mph_push_ok') === 'true'
    && 'Notification' in window
    && Notification.permission === 'granted';
}
function reengagementBanner() {
  const days = daysSinceLastOpen();
  const dismissed = localStorage.getItem('mph_reeng_dismissed');
  // Don't show if dismissed in last 3 days
  if (dismissed && Date.now() - parseInt(dismissed) < 3 * 86400000) return '';
  if (days < 3) return '';

  if (days >= 30) {
    return `<div style="background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(99,102,241,0.06));border:1px solid rgba(99,102,241,0.3);border-radius:var(--radius-xl);padding:1.25rem;margin-bottom:1.25rem;position:relative">
      <button onclick="dismissReengagement()" style="position:absolute;top:.75rem;right:.75rem;background:none;border:none;color:var(--text-3);font-size:1rem;cursor:pointer;line-height:1">Ã—</button>
      <div style="font-size:1.375rem;margin-bottom:.5rem">ğŸ’™</div>
      <div style="font-family:var(--font-display);font-size:1.0625rem;color:var(--text-1);margin-bottom:.375rem;font-style:italic">You've been away a while.</div>
      <p class="body-sm" style="margin-bottom:.875rem">No judgment. Life gets in the way. You're here now â€” that's what matters. Want to ease back in?</p>
      <button onclick="go('tools');toolkitSetIntensity(3);toolkitSetFeeling('growing');toolkitSetTiming('right-now');" class="btn btn-ghost" style="font-size:.8125rem;padding:.625rem 1rem">Start gently â†’</button>
    </div>`;
  }
  if (days >= 7) {
    return `<div style="background:rgba(217,119,6,0.08);border:1px solid rgba(217,119,6,0.25);border-radius:var(--radius-xl);padding:1.125rem;margin-bottom:1.25rem;position:relative">
      <button onclick="dismissReengagement()" style="position:absolute;top:.75rem;right:.75rem;background:none;border:none;color:var(--text-3);font-size:1rem;cursor:pointer;line-height:1">Ã—</button>
      <div style="font-family:var(--font-display);font-size:1rem;color:var(--text-amber);margin-bottom:.25rem;font-style:italic">It's been a few days.</div>
      <p class="body-sm">Small check-ins add up. Even today counts.</p>
    </div>`;
  }
  // 3-6 days
  return `<div style="background:rgba(13,148,136,0.06);border:1px solid rgba(13,148,136,0.2);border-radius:var(--radius-lg);padding:.875rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.75rem;position:relative">
    <span style="font-size:1.125rem">ğŸŒ¿</span>
    <p style="font-size:.8125rem;color:var(--text-2);flex:1">Welcome back. You were missed.</p>
    <button onclick="dismissReengagement()" style="background:none;border:none;color:var(--text-3);font-size:1rem;cursor:pointer;line-height:1;flex-shrink:0">Ã—</button>
  </div>`;
}
function newContentBanner() {
  if (seenContentV() >= CONTENT_V) return '';
  return `<div style="background:linear-gradient(135deg,rgba(13,148,136,0.15),rgba(217,119,6,0.1));border:1px solid rgba(13,148,136,0.4);border-radius:var(--radius-xl);padding:1.125rem 1.25rem;margin-bottom:1.25rem;display:flex;align-items:center;gap:.875rem;cursor:pointer;position:relative" onclick="markContentSeen();location.href='${CONTENT_WHATS_NEW.link}'">
    <div style="font-size:1.375rem;flex-shrink:0">âœ¨</div>
    <div style="flex:1">
      <div style="font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-teal);margin-bottom:.2rem">New Content</div>
      <div style="font-size:.9375rem;font-weight:600;color:var(--text-1);margin-bottom:.125rem">${CONTENT_WHATS_NEW.title}</div>
      <div class="body-sm">${CONTENT_WHATS_NEW.desc}</div>
    </div>
    <button onclick="event.stopPropagation();dismissNewContent()" style="background:none;border:none;color:var(--text-3);font-size:1rem;cursor:pointer;line-height:1;flex-shrink:0">Ã—</button>
  </div>`;
}
function pushPromptBanner() {
  if (pushEnabled()) return '';
  if (localStorage.getItem('mph_push_dismissed')) return '';
  if (S.streak < 7) return ''; // Only ask after 7-day streak â€” timing that converts
  return `<div style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.25);border-radius:var(--radius-lg);padding:1rem 1.125rem;margin-bottom:1rem;position:relative">
    <button onclick="localStorage.setItem('mph_push_dismissed','true');render()" style="position:absolute;top:.625rem;right:.75rem;background:none;border:none;color:var(--text-3);font-size:1rem;cursor:pointer;line-height:1">Ã—</button>
    <div style="display:flex;align-items:center;gap:.625rem;margin-bottom:.5rem">
      <span style="font-size:1rem">ğŸ””</span>
      <span style="font-size:.875rem;font-weight:600;color:var(--text-1)">7-day streak â€” nice work.</span>
    </div>
    <p class="body-sm" style="margin-bottom:.75rem">Want a gentle daily nudge to keep it going?</p>
    <button onclick="requestPushPermission()" class="btn btn-ghost" style="font-size:.8125rem;padding:.5rem .875rem">Turn on reminders</button>
  </div>`;
}

// â”€â”€ Mood data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MOODS = [
  { id:'rough',   emoji:'ğŸ˜”', word:'Rough',   color:'#e11d48',
    q: 'What\'s weighing on you most right now?',
    suggest: { label:'Getting Through the Storm', desc:'Skills for intense moments', link:'crisis-intro.html' },
    message: 'Hard moments are real. You showed up anyway â€” that counts.' },
  { id:'anxious', emoji:'ğŸ˜°', word:'Anxious',  color:'#f59e0b',
    q: 'What is your mind circling around?',
    suggest: { label:'Staying Present', desc:'Ground yourself in the now', link:'course-mindfulness.html' },
    message: 'Anxiety is your nervous system trying to protect you. Let\'s work with it.' },
  { id:'okay',    emoji:'ğŸ˜', word:'Okay',     color:'#64748b',
    q: 'What would make today feel a little better?',
    suggest: { label:'What Are Feelings?', desc:'Start with the basics', link:'#' },
    message: 'Okay is a perfectly valid place to be. Small steps still count.' },
  { id:'good',    emoji:'ğŸŒ¤', word:'Good',     color:'#0d9488',
    q: 'What\'s going well for you today?',
    suggest: { label:'Continue Learning', desc:'Good days are great for growth', link:'#' },
    message: 'Good energy is worth investing. Keep that momentum going.' },
  { id:'great',   emoji:'âœ¨', word:'Great',    color:'#d97706',
    q: 'What\'s behind the good feeling today?',
    suggest: { label:'Understanding Others', desc:'Share your energy outward', link:'#' },
    message: 'Something is working. Notice it â€” you can return to this.' }
];

// â”€â”€ Tracks / courses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TRACKS = [
  {
    id: 'know-yourself', label: 'Know Yourself', color:'#0d9488',
    icon: `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/></svg>`,
    free: true,
    courses: [
      { id:'feelings-101', title:'What Are Feelings?', desc:'What emotions are and why they exist', link:'#' },
      { id:'body-signals', title:"Your Body's Signals", desc:'Physical cues and your nervous system', link:'#', locked:true },
      { id:'your-patterns', title:'Your Patterns', desc:'Triggers, reactions, and defaults', link:'#', locked:true },
      { id:'who-you-are', title:'Who You Are', desc:'Values, identity, and self-concept', link:'#', locked:true },
    ]
  },
  {
    id: 'handle-hard', label: 'Handle the Hard Stuff', color:'#6366f1',
    icon: `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>`,
    free: false,
    courses: [
      { id:'staying-present', title:'Staying Present', desc:'Mindfulness â€” 8 modules', link:'course-mindfulness.html' },
      { id:'working-with-feelings', title:'Working With Intense Feelings', desc:'Shift the intensity without suppressing', link:'#', locked:true },
      { id:'storm', title:'Getting Through the Storm', desc:'Survive the hardest moments', link:'crisis-intro.html' },
      { id:'self-kind', title:'Being Kind to Yourself', desc:'Turn compassion inward', link:'#', locked:true },
    ]
  },
  {
    id: 'inner-world', label: 'Your Inner World', color:'#e11d48',
    icon: `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg>`,
    free: false,
    courses: [
      { id:'anxiety', title:"When You're Anxious", desc:'Understanding anxiety from the inside', link:'#', locked:true },
      { id:'anger', title:"When You're Angry", desc:'What anger is really telling you', link:'#', locked:true },
      { id:'grief', title:'When You\'re Grieving', desc:'Making space for loss', link:'#', locked:true },
      { id:'shame', title:'When You Feel Shame', desc:'The emotion nobody talks about', link:'#', locked:true },
    ]
  },
  {
    id: 'outer-world', label: 'Your Outer World', color:'#d97706',
    icon: `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>`,
    free: false,
    courses: [
      { id:'relationships', title:'Meaningful Relationships', desc:'Build deeper connections', link:'#', locked:true },
      { id:'understanding-others', title:'Understanding Others', desc:'Empathy and reading people', link:'#', locked:true },
      { id:'hard-convos', title:'Hard Conversations', desc:'Communication and conflict', link:'#', locked:true },
      { id:'what-matters', title:'Finding What Matters', desc:'Values, meaning, and direction', link:'#', locked:true },
    ]
  }
];

// â”€â”€ Quick tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Toolkit skills â€” full library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// free:true = always accessible   free:false = Pro only
// levels: which intensity levels this skill suits (1=mild 10=crisis)
// exercise: the short guided steps shown in-card
const TOOLKIT_SKILLS = [

  // â•â• LEVEL 9-10 â€” BODY ONLY (all free â€” never gate crisis help) â•â•
  {
    id:'physio-sigh', icon:'ğŸ’¨', level:[9,10], free:true,
    name:'The Double Breath',
    tagline:'Fastest way to slow your nervous system',
    source:'Stanford Neuroscience Â· 2023 RCT',
    body:'Two inhales through the nose, one long exhale. This re-inflates your air sacs and dumps COâ‚‚ â€” your brain\'s calming signal. Proven faster than any other breath technique.',
    steps:['Inhale fully through your nose until your lungs feel full.','Sniff once more on top â€” pack a little extra air in.','Breathe out slowly through your mouth â€” longer than both inhales combined.','Repeat 2â€“3 times. Notice the shift.']
  },
  {
    id:'cold-reset', icon:'ğŸ§Š', level:[9,10], free:true,
    name:'The Cold Reset',
    tagline:'Interrupt a spiral with your body',
    source:'Mammalian dive reflex research',
    body:'Cold water on your face activates an evolutionary emergency brake â€” your heart rate slows within seconds. It sounds strange. It works.',
    steps:['Splash cold water on your face, or hold ice in your hands.','Hold it for 30 seconds â€” breathe slowly while you do.','Feel your heart rate starting to drop.','When ready, take one slow breath and let go.']
  },
  {
    id:'move-it-out', icon:'âš¡', level:[9,10], free:true,
    name:'Move It Out',
    tagline:'Burn off what your body prepared for',
    source:'Somatic discharge Â· Exercise physiology',
    body:'When flooded, your body loaded adrenaline for physical action. Give it what it\'s asking for. 60 seconds of movement metabolizes the stress hormones.',
    steps:['Stand up right now.','Do 60 seconds of jumping jacks, jogging in place, or squats.','Go as hard as you can â€” this is the point.','When finished, stand still and notice what changed.']
  },
  {
    id:'come-to-now', icon:'ğŸª¨', level:[9,10], free:true,
    name:'Come Back to Now',
    tagline:'Anchor through all five senses',
    source:'Grounding therapy Â· Trauma research',
    body:'This pulls your brain\'s attention from threat-detection back into your actual body and surroundings. Name out loud if you can â€” speaking it out loud makes it more effective.',
    steps:['Name 5 things you can SEE â€” describe color and shape.','Name 4 things you can TOUCH right now â€” actually touch them.','Name 3 things you can HEAR â€” near sounds and far sounds.','Name 2 things you can SMELL. Then 1 thing you can taste.']
  },
  {
    id:'butterfly-hold', icon:'ğŸ¦‹', level:[9,10], free:true,
    name:'The Butterfly Hold',
    tagline:'Calm through gentle bilateral touch',
    source:'Bilateral stimulation Â· Trauma therapy',
    body:'Alternating left-right touch to both sides of your body simultaneously helps your brain process and calm intense emotional states. Slow is what makes it work.',
    steps:['Cross your arms over your chest.','Slowly tap alternate shoulders â€” right, left, right, left.','One tap per second. Breathe slowly.','Continue for 2â€“3 minutes while staying with what you\'re feeling.']
  },
  {
    id:'safety-scan', icon:'ğŸ‘ï¸', level:[9,10], free:true,
    name:'Safety Scan',
    tagline:'Tell your nervous system you\'re safe',
    source:'Polyvagal theory Â· Nervous system regulation',
    body:'Your threat-detection system is looking for a "safe" signal. Slowly scanning your environment gives it that signal and begins the shift out of crisis mode.',
    steps:['Slowly look around the room. Don\'t rush.','Let your eyes rest on each object for a moment.','Notice the light, the space, where the exits are.','Say out loud: "I am in [place]. I am safe right now."']
  },
  {
    id:'full-body-shake', icon:'ğŸŒ€', level:[9,10], free:true,
    name:'The Whole Body Release',
    tagline:'Let your body discharge what it\'s holding',
    source:'Somatic Experiencing Â· TRE research',
    body:'Animals tremor after stress to release activation. Humans inhibit this. Deliberate shaking is your body completing what it biologically started â€” and it dramatically shifts state.',
    steps:['Stand with feet shoulder-width apart.','Begin shaking your hands, arms, and shoulders.','Let the shaking spread to your legs and whole body.','Be uninhibited â€” 2 to 5 minutes. This is the discharge.']
  },

  // â•â• LEVEL 7-8 â€” BODY + SIMPLE STRUCTURE (mostly free) â•â•
  {
    id:'four-corners', icon:'ğŸ”²', level:[7,8], free:true,
    name:'Four Corners Breathing',
    tagline:'Military-proven to reset under pressure',
    source:'US Navy SEALs Â· HRV research',
    body:'Equal-ratio breathing used by military and ER surgeons. The predictable pattern gives your nervous system something to organize around. Simple and remarkably effective.',
    steps:['Breathe IN for 4 counts.','Hold for 4 counts.','Breathe OUT for 4 counts.','Hold empty for 4 counts. Repeat 4â€“8 times.']
  },
  {
    id:'tense-release', icon:'ğŸŒŠ', level:[7,8], free:true,
    name:'Tense and Let Go',
    tagline:'Release tension your body is holding',
    source:'Progressive Muscle Relaxation Â· 100+ clinical trials',
    body:'Tensing then releasing muscle groups discharges physical tension and teaches your body the felt difference between tension and release. One of the most-studied relaxation methods ever.',
    steps:['Start with your feet â€” tense them hard for 5 seconds.','Release suddenly. Notice the warmth and heaviness.','Move up: calves, thighs, belly, hands, shoulders, face.','Spend 20 seconds at each area after releasing.']
  },
  {
    id:'long-exhale', icon:'ğŸ’«', level:[7,8], free:true,
    name:'The Long Exhale',
    tagline:'The exhale is where calm lives',
    source:'Parasympathetic nervous system research',
    body:'The exhale â€” not the inhale â€” activates the calming branch of your nervous system. Longer out than in is the formula. The numbers don\'t matter as much as the ratio.',
    steps:['Breathe in for 4 counts through your nose.','Breathe out for 7 or 8 counts through your mouth.','Keep the exhale slow and controlled â€” don\'t rush it.','Continue for 2 minutes. Feel the shift.']
  },
  {
    id:'ride-the-wave', icon:'ğŸ„', level:[7,8], free:true,
    name:'Ride the Wave',
    tagline:'Every urge peaks and fades â€” let it',
    source:'Mindfulness-Based Relapse Prevention Â· Marlatt',
    body:'Every urge and intense feeling moves like a wave â€” it builds, peaks at 10â€“20 minutes, and fades. You don\'t have to act on it. You just have to outlast it.',
    steps:['Name the urge or feeling out loud: "There is [feeling] here."','Where do you feel it in your body? Notice it physically.','Rate its intensity from 0 to 10 right now.','Breathe and watch â€” check the rating every 2 minutes.']
  },
  {
    id:'easing-breath', icon:'ğŸ«', level:[7,8], free:true,
    name:'Hum and Ease',
    tagline:'Vibrate your nervous system calm',
    source:'Vagal nerve stimulation Â· Polyvagal theory',
    body:'Humming activates the vagus nerve â€” your body\'s main calming pathway â€” through vibration in your vocal cords. It bypasses thinking entirely.',
    steps:['Breathe in deeply through your nose.','On the exhale, hum a low tone â€” loud enough to feel it vibrate.','Feel the vibration in your chest and throat.','Repeat 6â€“8 times. Add a slow gargle with water if available.']
  },
  {
    id:'change-channel', icon:'ğŸ§©', level:[7,8], free:true,
    name:'Change the Channel',
    tagline:'Redirect with purpose, not avoidance',
    source:'DBT Distress Tolerance Â· Linehan',
    body:'When intensity is too high to process right now, deliberate distraction buys time for the wave to pass. This is not running away â€” it\'s choosing when to engage.',
    steps:['Choose ONE absorbing activity â€” something that takes real attention.','Or: do something for someone else. Text to check in. Help.','Or: engage a different sensory stream â€” music, cold water, spicy food.','Stay with it until intensity drops below 6, then return.']
  },

  // â•â• LEVEL 5-6 â€” THINKING AVAILABLE (Pro) â•â•
  {
    id:'this-is-what-is', icon:'âš“', level:[5,6], free:false,
    name:'This Is What Is',
    tagline:'Stop fighting the present moment',
    source:'Radical Acceptance Â· DBT Â· Linehan',
    body:'Fighting reality â€” wishing it were different â€” adds suffering on top of pain. Acceptance means "this is what is right now." Not approval. Not giving up. Just stopping the second layer.',
    steps:['Notice the words "this shouldn\'t be happening" or "why me."','Say plainly: "This is happening. I don\'t like it AND it is."','Where in your body are you bracing against it? Soften there slightly.','Say: "I accept this is, even though I hate it." Repeat as needed.']
  },
  {
    id:'notice-thought', icon:'ğŸ’­', level:[5,6], free:false,
    name:'"I Notice I\'m Thinking..."',
    tagline:'Create space between you and the thought',
    source:'Acceptance & Commitment Therapy Â· Hayes',
    body:'Adding a prefix to a thought creates real distance between you and it. You move from being the thought to observing it. It doesn\'t disappear â€” but it loses its grip.',
    steps:['When a distressing thought arrives, don\'t fight it.','Add this prefix: "I notice I\'m having the thought that..."','Say the whole thing: "I notice I\'m having the thought that I\'m failing."','Notice: you are the one observing the thought. Not the thought itself.']
  },
  {
    id:'look-at-evidence', icon:'ğŸ”', level:[5,6], free:false,
    name:'Look at the Evidence',
    tagline:'Test the thought before believing it',
    source:'Cognitive Behavioral Therapy',
    body:'Many intense emotions are driven not by events but by our stories about events. Separating what happened from what we\'re telling ourselves is one of the most powerful cognitive skills.',
    steps:['Write the thought driving your emotion.','Ask: What is the actual evidence FOR this thought?','Ask: What is the evidence AGAINST it?','Ask: What would I tell a close friend who had this exact thought?']
  },
  {
    id:'name-it', icon:'ğŸ·ï¸', level:[5,6], free:false,
    name:'Name It to Soften It',
    tagline:'Precise naming changes the experience',
    source:'Affective neuroscience Â· Lieberman research',
    body:'Precisely labeling an emotion reduces activity in the amygdala â€” your brain\'s alarm system. Not just "bad" â€” is it shame? Grief? Helplessness? Loneliness? Specificity is the tool.',
    steps:['Sit with the feeling for a moment without reacting.','Move past "bad" or "upset" â€” get specific.','Is it shame? Disappointment? Fear? Loneliness? Helplessness?','Say: "There is [precise emotion] here." Notice what shifts.']
  },
  {
    id:'ninety-seconds', icon:'â±ï¸', level:[5,6], free:false,
    name:'Wait 90 Seconds',
    tagline:'The chemistry of emotion passes quickly',
    source:'Neuroscience of emotion Â· Bolte Taylor',
    body:'The physiological peak of an emotion â€” the flood of stress hormones â€” lasts about 90 seconds. After that, any emotion that continues is being sustained by thought. Watch what happens.',
    steps:['Set a timer for 90 seconds right now.','Feel the emotion fully â€” don\'t push it away.','Breathe and observe it like a scientist watching data.','Notice at 90 seconds: is the intensity the same? Watch it moving.']
  },
  {
    id:'go-against-grain', icon:'ğŸ”„', level:[5,6], free:false,
    name:'Go Against the Grain',
    tagline:'Act opposite to what the emotion wants',
    source:'Opposite Action Â· DBT Emotion Regulation',
    body:'Every emotion has an action urge. When that urge isn\'t serving you, doing the opposite changes the emotion â€” not through thinking but through action.',
    steps:['Identify the emotion and what it wants you to do.','Shame says hide â†’ reach out to one safe person instead.','Anxiety says avoid â†’ approach one small piece of the fear.','Sadness says withdraw â†’ do one activating thing, even tiny.']
  },
  {
    id:'four-question-unpack', icon:'âœï¸', level:[5,6], free:false,
    name:'Four-Question Unpack',
    tagline:'Understand what just happened inside you',
    source:'Emotion journaling Â· Expressive writing research',
    body:'Five minutes of this builds more emotional self-knowledge than years of vague reflection. Write â€” don\'t just think it. Writing is what makes it work.',
    steps:['Write: What triggered this feeling?','Write: What did I feel in my body?','Write: What did the feeling want me to do?','Write: What did I actually do? What do I want to do differently?']
  },
  {
    id:'self-compassion-break', icon:'ğŸ’™', level:[5,6], free:false,
    name:'This Is a Human Moment',
    tagline:'What you would give a friend â€” give yourself',
    source:'Self-Compassion Â· Kristin Neff Â· Multiple RCTs',
    body:'Research shows self-compassion reduces emotional reactivity more effectively than self-esteem building. It specifically reduces shame spirals, which amplify all distress.',
    steps:['Place one hand on your heart.','Say: "This is a moment of pain. This is real."','Say: "Pain is part of being human. I am not alone in this."','Ask: What do I need right now? Give yourself that â€” as you would a friend.']
  },
  {
    id:'values-compass', icon:'ğŸ§­', level:[5,6], free:false,
    name:'Your Inner Compass',
    tagline:'Make one choice aligned with what matters',
    source:'Values Clarification Â· Acceptance & Commitment Therapy',
    body:'Reconnecting with what genuinely matters provides context for distress. One values-aligned action reconnects you to who you actually are â€” even on hard days.',
    steps:['Name one value that matters to you (honesty, care, courage, growth...).','Ask: is there one small thing I can do today that reflects this?','It doesn\'t have to fix anything. Just one small honest action.','Do it. Notice how it feels to act from who you want to be.']
  },
  {
    id:'wise-center', icon:'ğŸŒ™', level:[5,6], free:false,
    name:'Your Wise Center',
    tagline:'The calm part of you always knows',
    source:'Wise Mind Â· DBT Â· Mindfulness practice',
    body:'Sit between emotional mind (feels everything) and rational mind (analyzes everything). Your wise self lives between them â€” quieter, but truer.',
    steps:['Close your eyes and take three slow breaths.','Ask: what does my wisest, calmest self actually know about this?','Don\'t force it. Wait for what comes quietly.','When an answer arrives â€” it\'s usually simpler than expected â€” trust it.']
  },
];

// Toolkit UI state
let T = { intensity: null, feeling: null, timing: null, openSkillId: null, viewMode: 'entry' };
// viewMode: 'entry' | 'matched' | 'library'
// timing: 'right-now' | 'ongoing'

window.toolkitSetIntensity = function(val) {
  T.intensity = val;
  // If both answers given, show matched skills
  if (T.intensity !== null && T.feeling !== null) {
    T.viewMode = 'matched'; T.openSkillId = null;
  }
  render();
};
window.toolkitSetFeeling = function(val) {
  T.feeling = val;
  // If intensity already set, move to timing question (step 3)
  // unless intensity is high (8+) â€” skip timing, go straight to skills
  if (T.intensity !== null && T.feeling !== null) {
    if (T.intensity >= 8) {
      T.timing = 'right-now';
      T.viewMode = 'matched'; T.openSkillId = null;
    }
    // else wait for timing answer
  }
  render();
};
window.toolkitSetTiming = function(val) {
  T.timing = val;
  if (T.intensity !== null && T.feeling !== null) {
    T.viewMode = 'matched'; T.openSkillId = null;
  }
  render();
};
window.toolkitOpenSkill = function(id) {
  T.openSkillId = T.openSkillId === id ? null : id;
  render();
};
window.toolkitShowLibrary = function() { T.viewMode = 'library'; T.openSkillId = null; render(); };
window.toolkitReset = function() { T.intensity = null; T.feeling = null; T.timing = null; T.openSkillId = null; T.viewMode = 'entry'; render(); };
window.toolkitDone = function(id) { toast('Skill complete ğŸŒ¿'); };

function getMatchedSkills() {
  const i = T.intensity;
  const f = T.feeling;
  const t = T.timing; // 'right-now' | 'ongoing'

  // Intensity â†’ level bands
  let levels = [];
  if (i >= 8) levels = [9,10];
  else if (i >= 6) levels = [7,8];
  else levels = [5,6];

  let matched = TOOLKIT_SKILLS.filter(s => s.level.some(l => levels.includes(l)));

  // Comprehensive routing map
  // Covers: acute distress, relationship pain, grief, shame, identity, purpose,
  // ongoing patterns, body/health, work stress, loneliness, proactive growth
  const routing = {
    // â”€â”€ Acute / emotional flooding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'flooded':        ['physio-sigh','cold-reset','move-it-out','butterfly-hold','four-corners'],
    'panicking':      ['physio-sigh','long-exhale','come-to-now','four-corners','safety-scan'],
    'angry':          ['move-it-out','full-body-shake','tense-release','long-exhale','go-against-grain'],
    'spiraling':      ['ride-the-wave','notice-thought','four-corners','ninety-seconds','look-at-evidence'],

    // â”€â”€ Low mood / shutdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'low':            ['self-compassion-break','go-against-grain','values-compass','four-question-unpack','butterfly-hold'],
    'numb':           ['safety-scan','full-body-shake','come-to-now','four-question-unpack','easing-breath'],
    'hopeless':       ['self-compassion-break','values-compass','ninety-seconds','go-against-grain','wise-center'],
    'exhausted':      ['tense-release','long-exhale','self-compassion-break','four-question-unpack','values-compass'],

    // â”€â”€ Relationship pain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'conflict':       ['long-exhale','go-against-grain','look-at-evidence','notice-thought','four-question-unpack'],
    'lonely':         ['self-compassion-break','values-compass','go-against-grain','butterfly-hold','four-question-unpack'],
    'heartbreak':     ['self-compassion-break','ride-the-wave','tense-release','four-question-unpack','wise-center'],
    'people':         ['long-exhale','notice-thought','look-at-evidence','go-against-grain','four-question-unpack'],

    // â”€â”€ Inner experience â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'shame':          ['self-compassion-break','notice-thought','go-against-grain','wise-center','four-question-unpack'],
    'guilt':          ['look-at-evidence','go-against-grain','four-question-unpack','self-compassion-break','wise-center'],
    'grief':          ['ride-the-wave','self-compassion-break','tense-release','four-question-unpack','butterfly-hold'],
    'disconnected':   ['safety-scan','come-to-now','easing-breath','values-compass','four-question-unpack'],

    // â”€â”€ Life and direction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'lost':           ['values-compass','wise-center','four-question-unpack','self-compassion-break','notice-thought'],
    'stuck':          ['values-compass','go-against-grain','four-question-unpack','look-at-evidence','wise-center'],
    'pressure':       ['physio-sigh','four-corners','long-exhale','this-is-what-is','values-compass'],
    'overwhelmed':    ['physio-sigh','change-channel','tense-release','four-corners','this-is-what-is'],

    // â”€â”€ Proactive / building â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    'growing':        ['values-compass','wise-center','four-question-unpack','self-compassion-break','notice-thought'],
    'curious':        ['four-question-unpack','values-compass','wise-center','notice-thought','look-at-evidence'],
  };

  // Ongoing pattern modifier â€” add deeper processing skills
  const ongoingBoost = ['four-question-unpack','wise-center','values-compass','self-compassion-break','look-at-evidence'];

  const priority = routing[f] || [];
  const finalPriority = t === 'ongoing'
    ? [...new Set([...ongoingBoost, ...priority])]
    : priority;

  matched.sort((a,b) => {
    const ai = finalPriority.indexOf(a.id), bi = finalPriority.indexOf(b.id);
    if (ai === -1 && bi === -1) return 0;
    if (ai === -1) return 1;
    if (bi === -1) return -1;
    return ai - bi;
  });

  return matched.slice(0, 5);
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S = {
  tab: 'today',
  checkedInToday: false,
  todayMood: null,
  todayNote: '',
  streak: 0,
  streakHistory: [], // array of date strings 'YYYY-MM-DD'
  coursesStarted: [],
  breathActive: false,
  breathCycle: 0,
  hasBreathed: false,
  isPro: false
};
let breathTimer = null;

// â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() { try { localStorage.setItem('mph_s', JSON.stringify(S)); } catch(e){} }
function load() {
  try {
    const raw = localStorage.getItem('mph_s');
    if (raw) { const d = JSON.parse(raw); delete d.breathActive; Object.assign(S, d); }
  } catch(e){}
  S.breathActive = false;
  // Check if checked in today
  const today = todayStr();
  S.checkedInToday = S.streakHistory.includes(today);
  if (S.checkedInToday && S.todayMood) { /* keep */ }
  else if (!S.checkedInToday) { S.todayMood = null; S.todayNote = ''; }
  // Recalc streak
  S.streak = calcStreak();
}
function todayStr() { return new Date().toISOString().slice(0,10); }
function calcStreak() {
  if (!S.streakHistory.length) return 0;
  const sorted = [...S.streakHistory].sort().reverse();
  let count = 0, check = new Date();
  for (const d of sorted) {
    const checkStr = check.toISOString().slice(0,10);
    if (d === checkStr) { count++; check.setDate(check.getDate()-1); }
    else break;
  }
  return count;
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id) { document.getElementById(id).classList.add('show'); }
function hide(id) { document.getElementById(id).classList.remove('show'); }

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 3000);
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = ['today','learn','tools','you'];
function go(tab) {
  S.tab = tab;
  TABS.forEach(t => {
    const on = t===tab;
    document.getElementById(`dot-${t}`).classList.toggle('on', on);
    document.getElementById(`dot-${t}`).classList.toggle('off', !on);
    const ico = document.getElementById(`ico-${t}`);
    ico.classList.toggle('on', on);
    ico.classList.toggle('off', !on);
    ico.setAttribute('stroke-width', on ? '2.5' : '2');
    const lbl = document.getElementById(`lbl-${t}`);
    lbl.classList.toggle('on', on);
    lbl.classList.toggle('off', !on);
  });
  render(); scrollTop();
}
function scrollTop() { const el=document.getElementById('scroll'); if(el) el.scrollTo({top:0,behavior:'instant'}); }

// â”€â”€ Crisis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onCrisis = function(yes) {
  if (yes) { document.getElementById('crisisRes').style.display='block'; return; }
  localStorage.setItem('mph_crisis', Date.now());
  hide('crisisModal');
};

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogout = function() {
  const keep = {
    mph_disc_v: localStorage.getItem('mph_disc_v'),
    mph_disc_ok: localStorage.getItem('mph_disc_ok'),
    mph_crisis: localStorage.getItem('mph_crisis')
  };
  localStorage.clear();
  Object.entries(keep).forEach(([k,v])=>{ if(v) localStorage.setItem(k,v); });
  localStorage.setItem('mph_app_v', APP_V);
  Object.assign(S, { tab:'today', checkedInToday:false, todayMood:null, todayNote:'', streak:0, streakHistory:[], coursesStarted:[], breathActive:false, breathCycle:0, hasBreathed:false, isPro:false });
  hide('logoutModal');
  toast('Logged out âœ¨');
  go('today');
};

// â”€â”€ Check-in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectMood = function(id) {
  S.todayMood = id;
  save();
  render();
};
window.submitCheckin = function() {
  const note = document.getElementById('checkinNote');
  if (note) S.todayNote = note.value;
  const today = todayStr();
  if (!S.streakHistory.includes(today)) {
    S.streakHistory.push(today);
    // Keep max 90 days
    if (S.streakHistory.length > 90) S.streakHistory = S.streakHistory.slice(-90);
  }
  S.checkedInToday = true;
  S.streak = calcStreak();
  save();
  toast('Check-in saved ğŸŒ¿');
  render();
};

// â”€â”€ Breathing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startBreath = function() {
  S.breathActive = true; S.breathCycle = 0; S.hasBreathed = true;
  save(); render();
  setTimeout(breathCycle, 80);
};
function breathCycle() {
  if (!S.breathActive) return;
  const orb = document.getElementById('breathOrb');
  const txt = document.getElementById('breathTxt');
  if (!orb||!txt) return;
  S.breathCycle++;
  orb.style.transition='none';
  orb.style.transform='scale(1)';
  txt.textContent='Get readyâ€¦';
  void orb.offsetWidth;
  setTimeout(()=>{ if(!S.breathActive)return; orb.style.transition='transform 4s ease-in-out,box-shadow 4s ease-in-out'; txt.textContent='Breathe inâ€¦'; orb.style.transform='scale(1.55)'; orb.style.boxShadow='0 0 90px rgba(13,148,136,.6),0 0 160px rgba(217,119,6,.3)'; },80);
  setTimeout(()=>{ if(!S.breathActive)return; txt.textContent='Holdâ€¦'; },4100);
  setTimeout(()=>{ if(!S.breathActive)return; txt.textContent='Breathe outâ€¦'; orb.style.transition='transform 6s ease-in-out,box-shadow 6s ease-in-out'; orb.style.transform='scale(1)'; orb.style.boxShadow='0 0 60px rgba(13,148,136,.25),0 0 100px rgba(217,119,6,.12)'; },6100);
  setTimeout(()=>{ if(!S.breathActive)return; txt.textContent='Restâ€¦'; },12100);
  breathTimer=setTimeout(()=>{ if(!S.breathActive)return; if(S.breathCycle<13){breathCycle();}else{stopBreath();toast('Well done ğŸŒŠ');} },14100);
}
window.stopBreath = function() {
  S.breathActive=false; S.breathCycle=0;
  if(breathTimer){clearTimeout(breathTimer);breathTimer=null;}
  save(); render(); toast('Come back anytime ğŸŒŠ');
};

// â”€â”€ Streak dots (last 7 days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function streakDots() {
  const today = new Date();
  let html = '';
  for (let i=6;i>=0;i--) {
    const d = new Date(today); d.setDate(d.getDate()-i);
    const str = d.toISOString().slice(0,10);
    const done = S.streakHistory.includes(str);
    const isToday = i===0;
    const cls = done ? (isToday ? 'today' : 'done') : 'empty';
    html += `<div class="streak-dot ${cls}"></div>`;
  }
  return `<div class="streak-row">${html}</div>`;
}

// â”€â”€ TODAY tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function vToday() {
  const today = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const moodObj = S.todayMood ? MOODS.find(m=>m.id===S.todayMood) : null;
  const h = new Date().getHours(); const greeting = h<12?'Good morning':h<17?'Good afternoon':'Good evening';

  // -- Check-in card (not yet done today)
  let checkinBlock = '';
  if (!S.checkedInToday) {
    const moodBtns = MOODS.map(m=>`
      <button class="mood-btn${S.todayMood===m.id?' selected':''}" onclick="selectMood('${m.id}')">
        <span class="mood-emoji">${m.emoji}</span>
        <span class="mood-word">${m.word}</span>
      </button>`).join('');

    let followup = '';
    if (moodObj) {
      followup = `<div class="followup">
        <p class="followup-q">"${moodObj.q}"</p>
        <textarea class="followup-input" id="checkinNote" placeholder="Optional â€” just for youâ€¦">${S.todayNote||''}</textarea>
        <p class="body-sm" style="color:var(--text-teal);margin:.625rem 0 .875rem;font-style:italic">${moodObj.message}</p>
        <button class="btn btn-primary w-full" onclick="submitCheckin()">Save check-in</button>
      </div>`;
    }

    checkinBlock = `<div class="card card-glass mb-3" style="padding:1.375rem">
      <div class="section-label">Daily check-in</div>
      <p style="font-family:var(--font-display);font-size:1.0625rem;color:var(--text-1);margin-bottom:.125rem;font-style:italic">How are you right now?</p>
      <div class="mood-grid">${moodBtns}</div>
      ${followup}
    </div>`;
  } else {
    // Checked in â€” show affirmation + suggestion
    const msg = moodObj ? moodObj.message : 'You showed up. That\'s the first step.';
    const sug = moodObj ? moodObj.suggest : null;
    checkinBlock = `<div class="card card-glass mb-3" style="padding:1.375rem;background:var(--teal-dim);border-color:rgba(13,148,136,.3)">
      <div class="flex items-center gap-1 mb-2">
        <span style="font-size:1.25rem">${moodObj?moodObj.emoji:'ğŸŒ¿'}</span>
        <span style="color:var(--text-teal);font-weight:600;font-size:.875rem">Checked in today</span>
      </div>
      <p style="font-family:var(--font-display);font-style:italic;color:var(--text-1);font-size:1rem;margin-bottom:${sug?'.875rem':'0'}">${msg}</p>
      ${sug?`<button onclick="location.href='${sug.link}'" class="suggestion-card" style="width:100%;text-align:left;border:none">
        <span style="font-size:1.25rem">â†’</span>
        <div>
          <div style="font-weight:600;color:var(--text-amber);font-size:.9375rem">${sug.label}</div>
          <div class="body-sm">${sug.desc}</div>
        </div>
      </button>`:''}
    </div>`;
  }

  // -- Streak block
  const streakBlock = `<div class="card card-glass mb-3" style="padding:1.25rem">
    <div class="flex items-center justify-between mb-2">
      <div>
        <div class="section-label" style="margin-bottom:.25rem">Your streak</div>
        <div style="font-family:var(--font-display);font-size:1.5rem;color:var(--text-1)">${S.streak} <span style="font-size:1rem;color:var(--text-2)">day${S.streak!==1?'s':''}</span></div>
      </div>
      <span style="font-size:1.75rem">${S.streak>=7?'ğŸ”¥':S.streak>=3?'âš¡':'ğŸŒ±'}</span>
    </div>
    ${streakDots()}
    <p class="body-sm" style="margin-top:.625rem;color:var(--text-3)">Last 7 days</p>
  </div>`;

  // -- Today's focus (rotating daily tip)
  const tips = [
    { icon:'ğŸ§ ', title:'Notice without judgment', body:'When a feeling arises today, try naming it without labeling it as good or bad. "I notice I feel anxious" â€” not "I shouldn\'t feel this way."' },
    { icon:'ğŸ’¨', title:'One conscious breath', body:'Before any transition today â€” entering a room, starting a task â€” take one slow breath. You don\'t need three minutes. One counts.' },
    { icon:'ğŸª', title:'What triggered you?', body:'Think of a moment recently when you felt a strong emotion. What happened just before? Identifying triggers builds awareness over time.' },
    { icon:'ğŸ¤', title:'Validate yourself', body:'Tell yourself: "It makes sense I feel this way, given what I\'ve been through." Not as permission to stay stuck â€” just acknowledgment.' },
    { icon:'ğŸŒŠ', title:'Urge surfing', body:'When an uncomfortable feeling peaks, imagine riding it like a wave. It will crest and fade. You don\'t have to act on it â€” just ride it.' },
    { icon:'ğŸŒ¿', title:'Your body right now', body:'Take 10 seconds: where do you feel tension in your body? Your jaw? Shoulders? Upper chest? Awareness alone can start releasing it.' },
    { icon:'âœï¸', title:'Two-minute reflection', body:'Write one sentence about how you\'re feeling and one sentence about what you want from today. That\'s all. Two sentences can shift your whole morning.' },
  ];
  const tip = tips[new Date().getDay() % tips.length];
  const focusBlock = `<div class="card card-glass mb-3" style="padding:1.375rem">
    <div class="section-label">Today's focus</div>
    <div class="flex items-center gap-1 mb-2">
      <span style="font-size:1.375rem">${tip.icon}</span>
      <span style="font-family:var(--font-display);font-size:1.0625rem;color:var(--text-1)">${tip.title}</span>
    </div>
    <p class="body-md">${tip.body}</p>
  </div>`;

  // -- Continue course
  const startedTrack = TRACKS.find(t => t.courses.some(c => S.coursesStarted.includes(c.id)));
  let continueBlock = '';
  if (startedTrack) {
    const lastCourse = startedTrack.courses.find(c=>S.coursesStarted.includes(c.id));
    continueBlock = `<button onclick="location.href='${lastCourse.link||'#'}'" class="card" style="width:100%;padding:1.125rem 1.25rem;background:linear-gradient(135deg,${startedTrack.color}20,${startedTrack.color}0a);border:1px solid ${startedTrack.color}40;text-align:left;margin-bottom:1.5rem">
      <div class="flex items-center gap-2">
        <div class="track-icon" style="background:${startedTrack.color}30;width:2.5rem;height:2.5rem">
          <div style="width:1.25rem;height:1.25rem;color:${startedTrack.color}">${startedTrack.icon}</div>
        </div>
        <div style="flex:1">
          <div class="section-label" style="margin-bottom:.125rem">Continue</div>
          <div style="font-weight:600;color:var(--text-1);font-size:.9375rem">${lastCourse.title}</div>
        </div>
        <svg style="width:1rem;height:1rem;color:var(--text-3)" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
      </div>
    </button>`;
  }

  // -- Retention banners
  const reengBanner   = reengagementBanner();
  const newContentBnr = newContentBanner();
  const pushBnr       = pushPromptBanner();

  return `
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="body-sm" style="color:var(--text-3);margin-bottom:.25rem">${today}</p>
        <h1 class="title-xl">${greeting}<em>.</em></h1>
      </div>
      ${S.streak>0?`<div style="text-align:center;background:var(--amber-dim);border:1px solid rgba(217,119,6,.3);border-radius:var(--radius-lg);padding:.625rem .875rem"><div style="font-size:1.125rem">${S.streak>=7?'ğŸ”¥':'âš¡'}</div><div style="font-size:.6875rem;font-weight:700;color:var(--text-amber);margin-top:.125rem">${S.streak}d</div></div>`:''}
    </div>
    ${reengBanner}${newContentBnr}${pushBnr}${checkinBlock}
    ${focusBlock}
    ${continueBlock}
    ${streakBlock}
    <div style="text-align:center;padding:1rem 0">
      <button onclick="go('learn')" class="btn btn-ghost" style="font-size:.875rem">Explore all tracks â†’</button>
    </div>`;
}

// â”€â”€ LEARN tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function vLearn() {
  const trackCards = TRACKS.map(t => {
    const doneCount = t.courses.filter(c=>S.coursesStarted.includes(c.id)).length;
    const mods = t.courses.map(c => {
      const done = S.coursesStarted.includes(c.id);
      const locked = c.locked && !S.isPro;
      return `<div class="module-row" onclick="${locked?`toast('Unlock with MPHaven Pro ğŸ”‘')`:c.link&&c.link!=='#'?`location.href='${c.link}'`:`toast('Coming soon âœ¨')`}">
        <div class="module-dot ${done?'done':locked?'locked':'active'}"></div>
        <div style="flex:1">
          <div style="font-size:.875rem;font-weight:500;color:${locked?'var(--text-3)':'var(--text-1)'};">${c.title}</div>
          <div style="font-size:.75rem;color:var(--text-3);margin-top:.125rem">${c.desc}</div>
        </div>
        ${locked?`<div class="lock-badge">ğŸ”’ Pro</div>`:doneCount>0&&done?`<svg style="width:.875rem;height:.875rem;color:var(--teal)" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>`:''}
      </div>`;
    }).join('');

    return `<div class="track-card mb-3">
      <div class="track-header">
        <div class="track-icon" style="background:${t.color}25;color:${t.color}">
          ${t.icon}
        </div>
        <div style="flex:1">
          <div style="font-family:var(--font-display);font-size:1.125rem;color:var(--text-1)">${t.label}</div>
          <div class="body-sm">${doneCount} of ${t.courses.length} started</div>
        </div>
        ${!t.free?`<div class="lock-badge">Pro</div>`:`<div style="display:inline-flex;align-items:center;gap:.3rem;padding:.25rem .625rem;background:var(--emerald-dim);border:1px solid rgba(16,185,129,.3);border-radius:var(--radius-full);font-size:.625rem;font-weight:700;color:#6ee7b7;text-transform:uppercase;letter-spacing:.05em">Free</div>`}
      </div>
      <div class="track-modules">${mods}</div>
    </div>`;
  }).join('');

  return `
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="title-xl">Learn<em>.</em></h1>
        <p class="body-sm" style="margin-top:.25rem">Your growth curriculum</p>
      </div>
    </div>
    ${!S.isPro?`<div style="background:linear-gradient(135deg,rgba(217,119,6,.12),rgba(13,148,136,.08));border:1px solid rgba(217,119,6,.25);border-radius:var(--radius-xl);padding:1.25rem;margin-bottom:1.5rem">
      <div class="flex items-center gap-2 mb-2">
        <span style="font-size:1.25rem">âœ¨</span>
        <span style="font-family:var(--font-display);font-size:1.0625rem;color:var(--text-amber)">Unlock MPHaven Pro</span>
      </div>
      <p class="body-sm" style="margin-bottom:.875rem">All tracks, all tools, unlimited journaling. Less than one therapy copay per month.</p>
      <button class="btn btn-primary" style="font-size:.875rem;padding:.75rem 1.25rem" onclick="toast('Pro coming soon! ğŸš€')">$9.99/month â€” Get full access</button>
    </div>`:''}
    ${trackCards}`;
}

// â”€â”€ TOOLS tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skillCardHTML(sk) {
  const open = T.openSkillId === sk.id;
  const locked = !sk.free && !S.isPro;
  const borderColor = locked ? 'var(--border)' : open ? 'rgba(13,148,136,.45)' : 'var(--border)';
  const bg = open ? 'rgba(13,148,136,0.07)' : 'var(--bg-glass)';

  const steps = sk.steps.map((step, i) => `
    <div style="display:flex;gap:.625rem;margin-bottom:.5rem;align-items:flex-start">
      <div style="min-width:1.375rem;height:1.375rem;border-radius:50%;background:rgba(13,148,136,0.2);border:1px solid rgba(13,148,136,0.4);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.05rem">
        <span style="font-size:.625rem;font-weight:700;color:var(--text-teal)">${i+1}</span>
      </div>
      <p style="font-size:.8125rem;color:var(--text-2);line-height:1.55;margin:0">${step}</p>
    </div>`).join('');

  return `
    <div style="background:${bg};border:1px solid ${borderColor};border-radius:var(--radius-lg);margin-bottom:.625rem;overflow:hidden;transition:all .2s">
      <div onclick="${locked ? `toast('Unlock with MPHaven Pro ğŸ”‘')` : `toolkitOpenSkill('${sk.id}')`}"
           style="padding:.875rem 1rem;display:flex;align-items:center;gap:.75rem;cursor:pointer">
        <div style="font-size:1.25rem;width:2.25rem;height:2.25rem;border-radius:.625rem;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;flex-shrink:0">${sk.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:.9375rem;font-weight:600;color:${locked?'var(--text-3)':'var(--text-1)'};margin-bottom:.125rem">${sk.name}</div>
          <div style="font-size:.75rem;color:var(--text-3)">${sk.tagline}</div>
        </div>
        ${locked
          ? `<div class="lock-badge">ğŸ”’ Pro</div>`
          : `<svg style="width:.875rem;height:.875rem;color:var(--text-3);transition:transform .2s;transform:rotate(${open?'180deg':'0deg'})" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>`
        }
      </div>
      ${open && !locked ? `
      <div style="padding:0 1rem 1rem;border-top:1px solid rgba(255,255,255,0.06)">
        <p style="font-size:.8125rem;color:var(--text-2);line-height:1.6;margin:.875rem 0 .75rem">${sk.body}</p>
        <div style="font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-3);margin-bottom:.625rem">How to do it</div>
        ${steps}
        <div style="display:flex;gap:.5rem;margin-top:.875rem;flex-wrap:wrap">
          <button onclick="toolkitDone('${sk.id}')" class="btn btn-ghost" style="font-size:.8125rem;padding:.625rem 1rem">I did this âœ“</button>
          <div style="display:inline-flex;align-items:center;gap:.3rem;padding:.25rem .625rem;border-radius:var(--radius-full);background:rgba(100,116,139,.12);border:1px solid rgba(100,116,139,.2);font-size:.6rem;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em">${sk.source}</div>
        </div>
      </div>` : ''}
    </div>`;
}

function vToolsEntry() {
  // Step shown depends on what's been answered
  const step = T.intensity === null ? 1 : T.feeling === null ? 2 : 3;

  // â”€â”€ Step 1 â€” Intensity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const intensityBtns = [1,2,3,4,5,6,7,8,9,10].map(n => {
    const sel = T.intensity === n;
    const color = n >= 8 ? '#e11d48' : n >= 6 ? '#d97706' : n >= 4 ? '#6366f1' : '#10b981';
    const label = n===1?'Fine':n===3?'A bit off':n===5?'Struggling':n===7?'Hard':n===10?'Crisis':'';
    return `<div style="display:flex;flex-direction:column;align-items:center;gap:.25rem;flex:1">
      <button onclick="toolkitSetIntensity(${n})"
        style="width:100%;padding:.625rem .125rem;border-radius:.5rem;border:1.5px solid ${sel?color:'var(--border)'};background:${sel?color+'22':'transparent'};color:${sel?color:'var(--text-3)'};font-weight:700;font-size:.9375rem;cursor:pointer;transition:all .15s">${n}</button>
      ${label?`<span style="font-size:.5rem;color:${sel?color:'var(--text-3)'};font-weight:600;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap">${label}</span>`:'<span style="font-size:.5rem">&nbsp;</span>'}
    </div>`;
  }).join('');

  // â”€â”€ Step 2 â€” What's going on â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 8 options covering the full range of human difficulty
  // Language matches how people actually describe their experience
  const situations = [
    { id:'flooded',      emoji:'ğŸŒŠ', line1:'Intense feelings',   line2:'flooded, can\u2019t think' },
    { id:'spiraling',    emoji:'ğŸŒªï¸', line1:'Mind won\u2019t stop',   line2:'racing, overthinking' },
    { id:'low',          emoji:'ğŸŒ‘', line1:'Low or heavy',       line2:'sad, empty, flat' },
    { id:'angry',        emoji:'ğŸ”¥', line1:'Angry or reactive',  line2:'frustrated, fired up' },
    { id:'people',       emoji:'ğŸ’”', line1:'Someone or something', line2:'conflict, hurt, alone' },
    { id:'lost',         emoji:'ğŸ§­', line1:'Lost or stuck',      line2:'no direction, trapped' },
    { id:'pressure',     emoji:'âš¡', line1:'Pressure or stress', line2:'too much, canâ€™t cope' },
    { id:'growing',      emoji:'ğŸŒ±', line1:'Doing okay',         line2:'want to build something' },
  ];

  const sitBtns = situations.map(s => {
    const sel = T.feeling === s.id;
    return `<button onclick="toolkitSetFeeling('${s.id}')"
      style="padding:.75rem .5rem;border-radius:var(--radius-md);border:1px solid ${sel?'rgba(13,148,136,.5)':'var(--border)'};background:${sel?'var(--teal-dim)':'var(--bg-glass)'};cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.3rem;text-align:center">
      <span style="font-size:1.375rem;line-height:1">${s.emoji}</span>
      <span style="font-size:.6875rem;font-weight:700;color:${sel?'var(--text-teal)':'var(--text-1)'};line-height:1.2">${s.line1}</span>
      <span style="font-size:.625rem;color:${sel?'rgba(94,234,212,.7)':'var(--text-3)'};line-height:1.2">${s.line2}</span>
    </button>`;
  }).join('');

  // â”€â”€ Step 3 â€” Timing (only if intensity < 8) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const selRN = T.timing === 'right-now';
  const selOP = T.timing === 'ongoing';
  const timingBtns = [
    `<button onclick="toolkitSetTiming('right-now')"
      style="flex:1;padding:1rem .875rem;border-radius:var(--radius-lg);border:1.5px solid ${selRN?'rgba(13,148,136,.5)':'var(--border)'};background:${selRN?'var(--teal-dim)':'var(--bg-glass)'};cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.375rem;text-align:center">
      <span style="font-size:1.375rem">âš¡</span>
      <span style="font-size:.9375rem;font-weight:600;color:${selRN?'var(--text-teal)':'var(--text-1)'}">Right now</span>
      <span style="font-size:.75rem;color:${selRN?'rgba(94,234,212,.7)':'var(--text-3)'}">This came up today</span>
    </button>`,
    `<button onclick="toolkitSetTiming('ongoing')"
      style="flex:1;padding:1rem .875rem;border-radius:var(--radius-lg);border:1.5px solid ${selOP?'rgba(13,148,136,.5)':'var(--border)'};background:${selOP?'var(--teal-dim)':'var(--bg-glass)'};cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.375rem;text-align:center">
      <span style="font-size:1.375rem">ğŸ”</span>
      <span style="font-size:.9375rem;font-weight:600;color:${selOP?'var(--text-teal)':'var(--text-1)'}">Ongoing pattern</span>
      <span style="font-size:.75rem;color:${selOP?'rgba(94,234,212,.7)':'var(--text-3)'}">This keeps coming back</span>
    </button>`
  ].join('');

  // â”€â”€ Progress dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dots = [1,2,3].map(n => {
    const active = n === step;
    const done   = n < step;
    return `<div style="width:${active?'1.5rem':'.5rem'};height:.375rem;border-radius:3px;background:${done?'var(--teal)':active?'var(--amber)':'var(--border)'};transition:all .3s"></div>`;
  }).join('');

  // â”€â”€ Labels per step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const stepLabel = step===1 ? 'How intense is it right now?' : step===2 ? 'Whatâ€™s going on?' : 'Is this new or recurring?';
  const stepSub   = step===1 ? '1 = calm and fine  Â·  10 = canâ€™t cope' : step===2 ? 'Pick the one that feels closest' : 'This helps us choose the right depth';

  return `
    <div class="mb-3">
      <h1 class="title-xl">Tools<em>.</em></h1>
      <p class="body-sm" style="margin-top:.25rem">Skills matched to what you're going through</p>
    </div>

    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem">
      <div style="display:flex;gap:.375rem;align-items:center">${dots}</div>
      <div>
        <div style="font-size:.875rem;font-weight:600;color:var(--text-1)">${stepLabel}</div>
        <div style="font-size:.75rem;color:var(--text-3)">${stepSub}</div>
      </div>
    </div>

    ${step === 1 ? `
    <div class="card card-glass" style="padding:1.125rem;margin-bottom:1.25rem">
      <div style="display:flex;gap:.25rem;align-items:flex-end">${intensityBtns}</div>
    </div>` : ''}

    ${step >= 2 ? `
    <div class="card card-glass" style="padding:1rem;margin-bottom:.75rem;${step===2?'':'opacity:.5'}">
      <div style="font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-3);margin-bottom:.75rem">
        Intensity: <span style="color:var(--text-amber)">${T.intensity}/10</span>
        <button onclick="T.intensity=null;T.feeling=null;T.timing=null;render()" style="float:right;background:none;border:none;color:var(--text-3);font-size:.75rem;cursor:pointer">change</button>
      </div>
      ${step===2 ? `<div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">${sitBtns}</div>` : `
      <div style="font-size:.8125rem;color:var(--text-2)">
        ${situations.find(s=>s.id===T.feeling)?.emoji} ${situations.find(s=>s.id===T.feeling)?.line1}
        <button onclick="T.feeling=null;T.timing=null;render()" style="float:right;background:none;border:none;color:var(--text-3);font-size:.75rem;cursor:pointer">change</button>
      </div>`}
    </div>` : ''}

    ${step === 3 ? `
    <div class="card card-glass" style="padding:1rem;margin-bottom:1.25rem">
      <div style="display:flex;gap:.625rem">${timingBtns}</div>
    </div>` : ''}

    <div style="background:var(--rose-dim);border:1px solid rgba(225,29,72,.2);border-radius:var(--radius-lg);padding:.875rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.75rem">
      <span style="font-size:1rem;flex-shrink:0">ğŸ›¡ï¸</span>
      <div style="flex:1">
        <div style="font-size:.8125rem;font-weight:600;color:#fca5a5">Crisis Toolkit â€” always free</div>
        <div style="font-size:.75rem;color:var(--text-3)">If things feel unsafe, this is always here</div>
      </div>
      <button onclick="location.href='crisis-intro.html'" style="background:rgba(225,29,72,.2);border:1px solid rgba(225,29,72,.3);border-radius:var(--radius-md);padding:.375rem .625rem;color:#fca5a5;font-size:.75rem;cursor:pointer;white-space:nowrap">Open â†’</button>
    </div>

    <div style="text-align:center;padding:.5rem 0">
      <button onclick="toolkitShowLibrary()" style="background:none;border:none;color:var(--text-3);font-size:.8125rem;cursor:pointer;text-decoration:underline;text-underline-offset:3px">Browse all ${TOOLKIT_SKILLS.length} skills â†’</button>
    </div>`;
}

function vToolsMatched() {
  const matched = getMatchedSkills();
  const i = T.intensity;
  const feelingLabels = {
    'flooded':'Intense feelings','spiraling':'Mind racing','low':'Low or heavy',
    'angry':'Angry or reactive','people':'Relationship pain','lost':'Lost or stuck',
    'pressure':'Under pressure','growing':'Building & growing','panicking':'Panicking',
    'numb':'Feeling numb','hopeless':'Hopeless','exhausted':'Exhausted',
    'conflict':'In conflict','lonely':'Feeling lonely','heartbreak':'Heartbreak',
    'shame':'Carrying shame','guilt':'Feeling guilt','grief':'Grieving',
    'disconnected':'Disconnected','stuck':'Feeling stuck','overwhelmed':'Overwhelmed',
    'curious':'Curious'
  };
  const levelLabel = i >= 8 ? 'Body-First â€” Thinking Is Hard Right Now' : i >= 6 ? 'Body + Simple Structure' : 'Full Thinking Available';
  const levelColor = i >= 8 ? '#e11d48' : i >= 6 ? '#d97706' : '#10b981';
  const freeCount = matched.filter(s=>s.free).length;
  const lockedCount = matched.filter(s=>!s.free&&!S.isPro).length;

  const breathBtn = `<button onclick="startBreath();go('today')" class="tool-pill w-full mb-2" style="background:rgba(13,148,136,0.1);border-color:rgba(13,148,136,0.3)">
    <span style="font-size:1.5rem;width:2.25rem;text-align:center">ğŸŒŠ</span>
    <div style="flex:1;text-align:left">
      <div style="font-weight:600;color:var(--text-teal);font-size:.9375rem">Guided Breathing</div>
      <div class="body-sm">4-minute centering â€” always free</div>
    </div>
  </button>`;

  const skillCards = matched.map(s => skillCardHTML(s)).join('');

  const proPrompt = lockedCount > 0 && !S.isPro ? `
    <div style="background:var(--amber-dim);border:1px solid rgba(217,119,6,.3);border-radius:var(--radius-lg);padding:1rem;margin-top:.5rem;margin-bottom:1rem">
      <div style="font-size:.875rem;font-weight:600;color:var(--text-amber);margin-bottom:.375rem">âœ¨ ${lockedCount} more skill${lockedCount>1?'s':''} matched â€” unlock with Pro</div>
      <div class="body-sm" style="margin-bottom:.75rem">Deeper tools for processing what you're going through.</div>
      <button onclick="toast('Pro coming soon! ğŸš€')" class="btn btn-primary" style="font-size:.8125rem;padding:.625rem 1rem">Get MPHaven Pro</button>
    </div>` : '';

  return `
    <div class="flex items-center justify-between mb-3">
      <div>
        <h1 class="title-xl">Tools<em>.</em></h1>
        <div style="font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:${levelColor};margin-top:.25rem">${levelLabel}</div>
      </div>
      <button onclick="toolkitReset()" style="background:var(--bg-glass);border:1px solid var(--border);border-radius:var(--radius-md);padding:.5rem .75rem;color:var(--text-3);font-size:.75rem;cursor:pointer">â† Back</button>
    </div>

    <div style="background:rgba(13,148,136,0.06);border:1px solid rgba(13,148,136,0.15);border-radius:var(--radius-lg);padding:.875rem 1rem;margin-bottom:1.125rem">
      <p style="font-size:.8125rem;color:var(--text-2);line-height:1.5">Showing skills for <strong style="color:var(--text-1)">${feelingLabels[T.feeling]||T.feeling}</strong> at intensity <strong style="color:var(--text-1)">${T.intensity}/10</strong>${T.timing==='ongoing'?' Â· <em style="color:var(--text-amber)">ongoing</em>':''}.  Tap any to open the guided steps.</p>
    </div>

    ${i >= 7 ? breathBtn : ''}
    ${skillCards}
    ${proPrompt}

    <div style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <button onclick="toolkitShowLibrary()" style="background:none;border:none;color:var(--text-3);font-size:.8125rem;cursor:pointer;text-decoration:underline">All ${TOOLKIT_SKILLS.length} skills</button>
      <button onclick="location.href='crisis-intro.html'" style="background:none;border:none;color:#fca5a5;font-size:.8125rem;cursor:pointer">ğŸ›¡ï¸ Crisis Toolkit</button>
    </div>`;
}

function vToolsLibrary() {
  const freeTier = TOOLKIT_SKILLS.filter(s=>s.free);
  const proTier  = TOOLKIT_SKILLS.filter(s=>!s.free);
  const freeCards = freeTier.map(s=>skillCardHTML(s)).join('');
  const proCards  = proTier.map(s=>skillCardHTML(s)).join('');

  return `
    <div class="flex items-center justify-between mb-3">
      <div>
        <h1 class="title-xl">Tools<em>.</em></h1>
        <p class="body-sm" style="margin-top:.25rem">All ${TOOLKIT_SKILLS.length} skills</p>
      </div>
      <button onclick="toolkitReset()" style="background:var(--bg-glass);border:1px solid var(--border);border-radius:var(--radius-md);padding:.5rem .75rem;color:var(--text-3);font-size:.75rem;cursor:pointer">â† Back</button>
    </div>

    <div style="display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .75rem;border-radius:var(--radius-full);background:var(--emerald-dim);border:1px solid rgba(16,185,129,.3);font-size:.6875rem;font-weight:700;color:#6ee7b7;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem">
      Free â€” Crisis & Acute Skills
    </div>
    <p style="font-size:.8125rem;color:var(--text-3);margin-bottom:.875rem">Body-based. No thinking required. Always accessible.</p>
    ${freeCards}

    <div style="display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .75rem;border-radius:var(--radius-full);background:var(--amber-dim);border:1px solid rgba(217,119,6,.3);font-size:.6875rem;font-weight:700;color:var(--amber-light);text-transform:uppercase;letter-spacing:.05em;margin-top:.75rem;margin-bottom:.75rem">
      Pro â€” Deeper Processing Skills
    </div>
    <p style="font-size:.8125rem;color:var(--text-3);margin-bottom:.875rem">Cognitive and emotional processing. Available when thinking is online.</p>
    ${proCards}

    ${!S.isPro ? `<div style="background:var(--grad-subtle);border:1px solid rgba(13,148,136,.25);border-radius:var(--radius-xl);padding:1.25rem;margin-top:1rem">
      <div style="font-family:var(--font-display);font-size:1.0625rem;color:var(--text-1);margin-bottom:.5rem">Unlock all ${proTier.length} Pro skills</div>
      <p class="body-sm" style="margin-bottom:.875rem">The deeper tools for processing emotions, shifting patterns, and building long-term resilience.</p>
      <button class="btn btn-primary" style="font-size:.875rem;padding:.75rem 1.25rem" onclick="toast('Pro coming soon! ğŸš€')">Get MPHaven Pro</button>
    </div>` : ''}

    <div style="text-align:center;margin-top:1.5rem">
      <button onclick="location.href='crisis-intro.html'" style="background:none;border:none;color:#fca5a5;font-size:.8125rem;cursor:pointer">ğŸ›¡ï¸ Crisis Toolkit â€” always free</button>
    </div>`;
}

function vTools() {
  const breathSection = S.breathActive ? `
    <div class="card card-glass mb-3" style="padding:1.5rem;text-align:center">
      <div class="orb" id="breathOrb"></div>
      <div style="color:var(--text-teal);font-weight:600;font-size:1.125rem;margin-bottom:1rem;min-height:1.5rem" id="breathTxt">Get readyâ€¦</div>
      <button class="btn btn-ghost" onclick="stopBreath()">Finish early</button>
    </div>` : '';

  if (S.breathActive) return breathSection;

  if (T.viewMode === 'matched') return vToolsMatched();
  if (T.viewMode === 'library') return vToolsLibrary();
  return vToolsEntry();
}

// â”€â”€ YOU tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function vYou() {
  const totalDays = S.streakHistory.length;
  const totalCourses = S.coursesStarted.length;

  return `
    <div class="mb-4">
      <h1 class="title-xl">You<em>.</em></h1>
      <p class="body-sm" style="margin-top:.25rem">Your journey so far</p>
    </div>

    <div class="section-label">Your stats</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.5rem">
      <div class="card card-glass" style="padding:1.125rem;text-align:center">
        <div style="font-family:var(--font-display);font-size:2rem;color:var(--text-1)">${totalDays}</div>
        <div class="body-sm">days checked in</div>
      </div>
      <div class="card card-glass" style="padding:1.125rem;text-align:center">
        <div style="font-family:var(--font-display);font-size:2rem;color:var(--text-1)">${S.streak}</div>
        <div class="body-sm">day streak</div>
      </div>
    </div>

    <div class="section-label">Last 7 days</div>
    <div class="card card-glass" style="padding:1.25rem;margin-bottom:1.5rem">
      ${streakDots()}
      <p class="body-sm" style="margin-top:.75rem;color:var(--text-3)">Each dot is a day you checked in</p>
    </div>

    ${!S.isPro?`<div style="background:var(--grad-subtle);border:1px solid rgba(13,148,136,.25);border-radius:var(--radius-xl);padding:1.375rem;margin-bottom:1.5rem">
      <div style="font-family:var(--font-display);font-size:1.125rem;color:var(--text-1);margin-bottom:.5rem">Unlock the full journey</div>
      <p class="body-sm" style="margin-bottom:.875rem">All 4 tracks, journaling, and everything we build next.</p>
      <button class="btn btn-primary w-full" onclick="toast('Pro coming soon! ğŸš€')">$9.99/mo Â· $74.99/yr</button>
    </div>`:''}

    <div class="section-label">Settings</div>
    <div class="card card-glass" style="padding:1.25rem;margin-bottom:1rem">
      <div class="flex items-center justify-between">
        <div>
          <div style="font-weight:600;color:var(--text-1);font-size:.9375rem">Practice reminders</div>
          <div class="body-sm">Daily gentle nudge</div>
        </div>
        <div style="width:2.75rem;height:1.625rem;border-radius:var(--radius-full);background:var(--border);position:relative;cursor:pointer" onclick="pushEnabled()?toast('Reminders already on ğŸ””'):requestPushPermission()">
          <div style="width:1.125rem;height:1.125rem;border-radius:50%;background:white;position:absolute;top:.25rem;left:.25rem"></div>
        </div>
      </div>
    </div>

    <div class="card card-glass" style="padding:1.125rem;margin-bottom:1.5rem">
      <div class="flex items-center gap-1">
        <svg style="width:1.125rem;height:1.125rem;color:var(--text-teal);flex-shrink:0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
        <div>
          <div style="font-weight:600;color:var(--text-teal);font-size:.875rem">Your privacy</div>
          <div class="body-sm" style="margin-top:.125rem">All progress saved locally on your device only.</div>
        </div>
      </div>
    </div>

    <div style="padding-top:1.5rem;border-top:1px solid rgba(225,29,72,.15)">
      <button class="btn btn-danger w-full" onclick="show('logoutModal')">
        <svg style="width:1rem;height:1rem" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Log out
      </button>
      <div style="text-align:center;margin-top:2rem">
        <p style="color:var(--text-3);font-size:.6875rem">MPHaven v3.0 Â· Your companion for growth</p>
        <button onclick="if(confirm('Reset everything?')){localStorage.clear();location.reload();}" style="margin-top:.75rem;padding:.375rem .875rem;background:none;border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-3);font-size:.625rem;cursor:pointer">Reset all data</button>
      </div>
    </div>`;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const el = document.getElementById('view');
  if (!el) return;
  el.className = 'pad fade-up';
  void el.offsetWidth;
  el.className = 'pad fade-up';
  switch(S.tab) {
    case 'today': el.innerHTML = vToday(); break;
    case 'learn': el.innerHTML = vLearn(); break;
    case 'tools': el.innerHTML = vTools(); if(S.breathActive) setTimeout(breathCycle,80); break;
    case 'you':   el.innerHTML = vYou(); break;
  }
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', ()=>{
  // Version migration â€” preserve ALL safety/disclaimer keys across versions
  if (localStorage.getItem('mph_app_v') !== APP_V) {
    const keep = {
      'mph_disc_v':  localStorage.getItem('mph_disc_v')  || localStorage.getItem('mphaven_disclaimer_version'),
      'mph_disc_ok': localStorage.getItem('mph_disc_ok') || localStorage.getItem('mphaven_disclaimer_acknowledged'),
      'mph_crisis':  localStorage.getItem('mph_crisis')  || localStorage.getItem('mphaven_last_crisis_check'),
      // Preserve old keys too so old disclaimer.html still works
      'mphaven_disclaimer_acknowledged': localStorage.getItem('mphaven_disclaimer_acknowledged'),
      'mphaven_disclaimer_version':      localStorage.getItem('mphaven_disclaimer_version'),
      'mphaven_last_crisis_check':       localStorage.getItem('mphaven_last_crisis_check'),
    };
    localStorage.clear();
    Object.entries(keep).forEach(([k,v])=>{ if(v) localStorage.setItem(k,v); });
    localStorage.setItem('mph_app_v', APP_V);
  }

  recordOpen();
  load(); render();

  // Check disclaimer â€” accepts any version acknowledgment from old or new app
  setTimeout(()=>{
    const ok = localStorage.getItem('mph_disc_ok') === 'true' 
            || localStorage.getItem('mphaven_disclaimer_acknowledged') === 'true';
    // If never acknowledged at all, redirect to disclaimer
    if (!ok) { window.location.href='disclaimer.html'; return; }
    // Already acknowledged â€” mark new keys so future checks pass
    localStorage.setItem('mph_disc_ok', 'true');
    localStorage.setItem('mph_disc_v', DISC_V);

    const last = localStorage.getItem('mph_crisis') || localStorage.getItem('mphaven_last_crisis_check');
    if (!last || Date.now()-parseInt(last)>CRISIS_TIMEOUT) show('crisisModal');
  }, 120);
});

window.addEventListener('beforeunload', save);
</script>
</body>
</html>
