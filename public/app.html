<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>MPHaven</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
--bg-dark: #0f172a;
--bg-card: rgba(15, 23, 42, 0.98);
--bg-card-light: rgba(30, 41, 59, 0.65);
--bg-card-dark: rgba(15, 23, 42, 0.45);
--border-subtle: rgba(30, 41, 59, 0.5);
--border-softer: rgba(51, 65, 85, 0.4);
--primary-teal: #0e7490;
--primary-teal-dark: #0c627a;
--teal-glow: rgba(14, 116, 144, 0.25);
--accent-amber: #d97706;
--accent-amber-dark: #b45309;
--amber-glow: rgba(217, 119, 6, 0.25);
--text-teal-light: rgb(165, 243, 252);
--text-teal: rgb(94, 234, 212);
--text-teal-dark: rgb(14, 116, 144);
--text-amber-light: rgb(253, 230, 138);
--text-amber: rgb(251, 191, 36);
--text-amber-dark: rgb(217, 119, 6);
--success-emerald: rgb(74, 222, 128);
--success-bg: rgba(34, 197, 94, 0.12);
--text-primary: rgb(241, 245, 249);
--text-secondary: rgb(203, 213, 225);
--text-muted: rgb(148, 163, 184);
--text-dim: rgb(100, 116, 139);
--blur-teal: rgba(14, 116, 144, 0.08);
--blur-amber: rgba(217, 119, 6, 0.08);
--blur-radius: 140px;
--blur-opacity: 0.6;
--gradient-main: linear-gradient(135deg, #0e7490, #d97706);
--gradient-teal-heavy: linear-gradient(to right, #0e7490 70%, #d97706);
--gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
--gradient-success: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(21,128,61,0.08));
--shadow-card: 0 25px 50px -12px rgba(0,0,0,0.25);
--shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
--crisis-red: #dc2626;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; -webkit-font-smoothing: antialiased; }
html, body { width: 100%; height: 100%; overflow: hidden; position: fixed; overscroll-behavior: none; }
body { background: var(--bg-dark); touch-action: pan-y; }
.container { width: 100%; height: 100vh; height: 100dvh; display: flex; flex-direction: column; }
.app-wrapper { width: 100%; max-width: 28rem; height: 100%; margin: 0 auto; background: var(--bg-card); backdrop-filter: blur(40px); display: flex; flex-direction: column; position: relative; border-left: 1px solid var(--border-subtle); border-right: 1px solid var(--border-subtle); }
.bg-blur-1, .bg-blur-2 { position: absolute; border-radius: 50%; filter: blur(var(--blur-radius)); pointer-events: none; z-index: 0; opacity: var(--blur-opacity); transition: opacity 1.5s cubic-bezier(.4,0,.2,1); }
.bg-blur-1 { top: -5%; left: 50%; transform: translateX(-50%); width: 24rem; height: 24rem; background: var(--blur-teal); }
.bg-blur-2 { bottom: -5%; right: -5%; width: 20rem; height: 20rem; background: var(--blur-amber); }
.warmth-1 .bg-blur-1, .warmth-1 .bg-blur-2 { opacity: .25; }
.warmth-2 .bg-blur-1, .warmth-2 .bg-blur-2 { opacity: .35; }
.warmth-3 .bg-blur-1, .warmth-3 .bg-blur-2 { opacity: .45; }
.main-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 1; -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
.main-content::-webkit-scrollbar { display: none; }
.nav-bar { position: relative; z-index: 1000; border-top: 1px solid var(--border-subtle); background: var(--bg-card); backdrop-filter: blur(24px); box-shadow: var(--shadow-xl); padding: .75rem 0; padding-bottom: calc(.75rem + env(safe-area-inset-bottom)); }
.nav-container { display: flex; align-items: center; justify-content: space-around; max-width: 28rem; margin: 0 auto; }
.nav-btn { position: relative; display: flex; flex-direction: column; align-items: center; gap: .375rem; padding: .5rem 1.5rem; background: none; border: none; cursor: pointer; transition: all .2s; -webkit-tap-highlight-color: transparent; }
.nav-btn:active { opacity: .7; }
.nav-indicator { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2.5rem; height: 3px; background: var(--gradient-main); border-radius: 9999px; opacity: 0; transition: opacity .2s; }
.nav-indicator.active { opacity: 1; }
.nav-icon { width: 24px; height: 24px; transition: all .2s; }
.nav-icon.active { color: var(--text-primary); stroke-width: 2.5; }
.nav-icon.inactive { color: var(--text-dim); stroke-width: 2; }
.nav-label { font-size: .6875rem; font-weight: 600; transition: all .2s; white-space: nowrap; }
.nav-label.active { color: var(--text-primary); }
.nav-label.inactive { color: var(--text-dim); }
.content-wrapper { padding: 1.5rem; padding-bottom: 8rem; min-height: 100%; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn .35s ease-out; }
.card { position: relative; overflow: hidden; border-radius: 1.5rem; padding: 1.5rem; transition: all .3s cubic-bezier(.4,0,.2,1); box-shadow: var(--shadow-card); cursor: pointer; -webkit-tap-highlight-color: transparent; }
.card:active { transform: scale(.97); }
.path-card { background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark)); border-radius: 1.5rem; padding: 1.5rem; transition: all .3s cubic-bezier(.4,0,.2,1); cursor: pointer; }
.path-card:active { transform: scale(.97); }
.icon-container { border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
.breath-circle { 
  width: 120px; 
  height: 120px; 
  border-radius: 50%; 
  background: linear-gradient(135deg, rgba(14,116,144,.6), rgba(217,119,6,.5)); 
  margin: 1.5rem auto; 
  box-shadow: 0 0 60px var(--teal-glow), 0 0 100px rgba(217,119,6,.2); 
  transform: scale(1);
  will-change: transform, box-shadow;
}
.breath-text { text-align: center; color: var(--text-teal-light); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; min-height: 1.5rem; letter-spacing: 0.02em; }
.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); border: 1px solid var(--teal-glow); border-radius: .75rem; padding: 1rem 1.5rem; color: var(--text-primary); font-weight: 600; z-index: 10000; opacity: 0; transition: all .3s ease; backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,.3); }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.logout-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.85); display: flex; align-items: center; justify-content: center; z-index: 10001; opacity: 0; visibility: hidden; transition: all .3s ease; backdrop-filter: blur(10px); }
.logout-modal.show { opacity: 1; visibility: visible; }
.logout-modal-content { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 1.5rem; padding: 2rem; max-width: 320px; width: 90%; margin: 1rem; box-shadow: var(--shadow-card); }
.welcome-badge { display: inline-flex; align-items: center; gap: .5rem; background: var(--gradient-subtle); border: 1px solid var(--teal-glow); border-radius: 9999px; padding: .5rem 1rem; font-size: .8125rem; font-weight: 600; color: var(--text-teal-light); margin-bottom: 1rem; }
@media (min-width: 640px) {
  .app-wrapper { border-radius: 2.5rem; height: 844px; }
  .container { padding: 2rem; align-items: center; justify-content: center; }
}
</style>
</head>
<body>
<div class="container">
  <div class="app-wrapper" id="appWrapper">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>
    <div id="mainContent" class="main-content"></div>
    <div class="nav-bar">
      <div class="nav-container">
        <button class="nav-btn" onclick="switchTab('home')">
          <div class="nav-indicator active"></div>
          <svg class="nav-icon active" stroke-width="2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          <span class="nav-label active">Home</span>
        </button>
        <button class="nav-btn" onclick="switchTab('paths')">
          <div class="nav-indicator"></div>
          <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          <span class="nav-label inactive">Paths</span>
        </button>
        <button class="nav-btn" onclick="switchTab('you')">
          <div class="nav-indicator"></div>
          <svg class="nav-icon inactive" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <span class="nav-label inactive">You</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>
<div id="logoutModal" class="logout-modal">
  <div class="logout-modal-content">
    <h3 style="color:var(--text-primary);font-size:1.25rem;font-weight:700;margin-bottom:.5rem">Log Out</h3>
    <p style="color:var(--text-secondary);font-size:.9375rem;margin-bottom:1.5rem;line-height:1.5">Are you sure you want to log out? All your progress will be cleared from this device.</p>
    <div style="display:flex;gap:.75rem;justify-content:flex-end">
      <button onclick="hideLogoutModal()" style="padding:.75rem 1.25rem;background:var(--bg-card-light);color:var(--text-secondary);border:1px solid var(--border-softer);border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.875rem;-webkit-tap-highlight-color:transparent;transition:all .2s" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">Cancel</button>
      <button onclick="confirmLogout()" style="padding:.75rem 1.25rem;background:linear-gradient(to right,#dc2626,#b91c1c);color:white;border:none;border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.875rem;-webkit-tap-highlight-color:transparent;transition:all .2s" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">Log Out</button>
    </div>
  </div>
</div>

<!-- ========== DISCLAIMER & CRISIS CHECK SYSTEM ========== -->
<div id="crisisModal" class="logout-modal" style="z-index:20000">
  <div class="logout-modal-content" style="max-width:360px">
    <h3 style="color:var(--text-primary);font-size:1.25rem;font-weight:700;margin-bottom:.5rem">üö® Safety Check</h3>
    <p style="color:var(--text-secondary);font-size:.9375rem;margin-bottom:1.5rem;line-height:1.5">Before you continue, please confirm:</p>
    
    <div style="background:rgba(220,38,38,0.1);border:1px solid rgba(220,38,38,0.3);border-radius:.75rem;padding:1rem;margin-bottom:1.5rem">
      <p style="color:#fca5a5;font-size:.875rem;font-weight:600;margin-bottom:.5rem">Are you currently experiencing:</p>
      <ul style="color:var(--text-secondary);font-size:.8125rem;margin-left:1.25rem;line-height:1.6">
        <li>Thoughts of suicide or self-harm?</li>
        <li>Plans to hurt yourself or others?</li>
        <li>Unable to keep yourself safe right now?</li>
      </ul>
    </div>
    
    <div style="display:flex;gap:.75rem;flex-direction:column">
      <button onclick="handleCrisisResponse(true)" style="padding:1rem;background:rgba(220,38,38,0.2);border:2px solid var(--crisis-red);color:#fca5a5;border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.9375rem;width:100%;-webkit-tap-highlight-color:transparent">Yes - Show Crisis Resources</button>
      <button onclick="handleCrisisResponse(false)" style="padding:1rem;background:var(--gradient-main);color:white;border:none;border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.9375rem;width:100%;-webkit-tap-highlight-color:transparent">No - I'm Safe to Continue</button>
    </div>
    
    <div id="crisisResources" style="display:none;margin-top:1.5rem;padding:1rem;background:rgba(0,0,0,0.4);border-left:4px solid var(--crisis-red);border-radius:.5rem">
      <p style="color:#fca5a5;font-size:.9375rem;font-weight:600;margin-bottom:.75rem">üö® Please get help now:</p>
      <p style="color:var(--text-secondary);font-size:.8125rem;margin-bottom:.5rem">‚Ä¢ <a href="tel:988" style="color:#fca5a5;font-weight:600;text-decoration:none">988 Suicide & Crisis Lifeline</a> ‚Äî Call or text 988</p>
      <p style="color:var(--text-secondary);font-size:.8125rem;margin-bottom:.5rem">‚Ä¢ <a href="sms:741741" style="color:#fca5a5;font-weight:600;text-decoration:none">Crisis Text Line</a> ‚Äî Text HOME to 741741</p>
      <p style="color:var(--text-secondary);font-size:.8125rem">‚Ä¢ <a href="tel:911" style="color:#fca5a5;font-weight:600;text-decoration:none">911 Emergency</a> ‚Äî Or go to nearest ER</p>
    </div>
  </div>
</div>

<script>
// ========== DISCLAIMER & CRISIS CHECK SYSTEM ==========
const DISCLAIMER_VERSION = '3.0';
const CRISIS_SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes

// Show crisis check modal
function showCrisisCheck() {
  const modal = document.getElementById('crisisModal');
  if (modal) {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
}

// Hide crisis check modal
function hideCrisisCheck() {
  const modal = document.getElementById('crisisModal');
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }
}

// Handle crisis response
window.handleCrisisResponse = function(inCrisis) {
  if (inCrisis) {
    // Show crisis resources
    const resources = document.getElementById('crisisResources');
    if (resources) {
      resources.style.display = 'block';
    }
  } else {
    // User is safe - update last check and proceed
    localStorage.setItem('mphaven_last_crisis_check', Date.now().toString());
    hideCrisisCheck();
    
    // Initialize the app
    initApp();
  }
};

// ========== ORIGINAL APP CODE ==========

// Version control - clear old data if version changed
const APP_VERSION = '2.2';
if (localStorage.getItem('mphaven_version') !== APP_VERSION) {
  // Don't clear disclaimer data! Only app data
  const disclaimerAcked = localStorage.getItem('mphaven_disclaimer_acknowledged');
  const disclaimerVersion = localStorage.getItem('mphaven_disclaimer_version');
  const lastCrisisCheck = localStorage.getItem('mphaven_last_crisis_check');
  
  localStorage.clear();
  
  // Restore disclaimer data
  if (disclaimerAcked) localStorage.setItem('mphaven_disclaimer_acknowledged', disclaimerAcked);
  if (disclaimerVersion) localStorage.setItem('mphaven_disclaimer_version', disclaimerVersion);
  if (lastCrisisCheck) localStorage.setItem('mphaven_last_crisis_check', lastCrisisCheck);
  
  localStorage.setItem('mphaven_version', APP_VERSION);
}

const state = {
  currentTab: 'home',
  breathingActive: false,
  notificationsEnabled: false,
  hasSeenBreath: false,
  coursesStarted: [],
  isNewUser: true
};

const courses = [
  { id: 'mindfulness', title: 'Mindfulness', description: 'Cultivate awareness of the here and now', color: '#d97706', icon: 'M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z', category: 'Foundation', link: 'course-mindfulness.html' },
  { id: 'emotional', title: 'Understanding Feelings', description: 'Learn to recognize and be with your emotions', color: '#0e7490', icon: 'M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5', category: 'Foundation' },
  { id: 'connection', title: 'Meaningful Relationships', description: 'Build deeper connections with others', color: '#dc2626', icon: 'M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z', category: 'Relationships' },
  { id: 'purpose', title: 'Finding What Matters', description: 'Discover what gives your life meaning', color: '#0891b2', icon: 'M15 10.5a3 3 0 11-6 0 3 3 0 016 0z M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z', category: 'Growth' },
  { id: 'stress', title: 'Managing Stress', description: 'Tools to navigate difficult moments', color: '#7c3aed', icon: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z', category: 'Wellness' },
  { id: 'crisis-resilience', title: 'Crisis Resilience', description: 'Survive intense emotional moments', color: '#0e7490', icon: 'üõ°Ô∏è', category: 'Wellness', link: 'crisis-intro.html' },
  { id: 'self-compassion', title: 'Self-Compassion', description: 'Treat yourself with kindness', color: '#ec4899', icon: 'M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418', category: 'Growth' }
];

let breathTimer = null;
let breathCycleCount = 0;

function getIcon(path, strokeWidth = '2') {
  // Special handling for shield emoji icon
  if (path === 'üõ°Ô∏è') {
    return `<svg class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 0c-1.1 0-2 .9-2 2v1a2 2 0 002 2h1.5M12 4c1.1 0 2 .9 2 2v1a2 2 0 01-2 2h-1.5M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2h12a2 2 0 012 2z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 7v5m0 5v-5"/></svg>`;
  }
  return `<svg class="w-full h-full" stroke-width="${strokeWidth}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="${path}"/></svg>`;
}

function scrollToTop() {
  const content = document.getElementById('mainContent');
  if (content) content.scrollTo({ top: 0, behavior: 'instant' });
}

function updateWarmth() {
  const wrapper = document.getElementById('appWrapper');
  const started = state.coursesStarted.length;
  wrapper.className = started >= 3 ? 'app-wrapper warmth-3' :
                      started >= 2 ? 'app-wrapper warmth-2' :
                      started >= 1 ? 'app-wrapper warmth-1' : 'app-wrapper';
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function saveState() {
  localStorage.setItem('mphaven_state', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('mphaven_state');
  if (saved) {
    try {
      const loaded = JSON.parse(saved);
      // Don't load breathingActive state - never auto-start
      delete loaded.breathingActive;
      Object.assign(state, loaded);
      // Fix: Properly determine if user is new
      state.isNewUser = (!state.hasSeenBreath && state.coursesStarted.length === 0);
    } catch (e) {
      console.error('Failed to load state:', e);
    }
  }
  // Always ensure breathing is not active on load
  state.breathingActive = false;
}

function showLogoutModal() {
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
}

function hideLogoutModal() {
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }
}

function confirmLogout() {
  // Clear app data but preserve disclaimer data
  const disclaimerAcked = localStorage.getItem('mphaven_disclaimer_acknowledged');
  const disclaimerVersion = localStorage.getItem('mphaven_disclaimer_version');
  const lastCrisisCheck = localStorage.getItem('mphaven_last_crisis_check');
  
  localStorage.clear();
  
  // Restore disclaimer data
  if (disclaimerAcked) localStorage.setItem('mphaven_disclaimer_acknowledged', disclaimerAcked);
  if (disclaimerVersion) localStorage.setItem('mphaven_disclaimer_version', disclaimerVersion);
  if (lastCrisisCheck) localStorage.setItem('mphaven_last_crisis_check', lastCrisisCheck);
  
  localStorage.setItem('mphaven_version', APP_VERSION);
  
  state.breathingActive = false;
  state.notificationsEnabled = false;
  state.hasSeenBreath = false;
  state.coursesStarted = [];
  state.isNewUser = true;
  updateWarmth();
  hideLogoutModal();
  showToast('Logged out successfully ‚ú®');
  render();
  setTimeout(() => switchTab('home'), 500);
}

function switchTab(tab) {
  state.currentTab = tab;
  
  document.querySelectorAll('.nav-btn').forEach(btn => {
    const btnOnclick = btn.getAttribute('onclick');
    const btnTab = btnOnclick ? btnOnclick.replace("switchTab('", "").replace("')", "") : '';
    const isActive = btnTab === tab;
    
    const indicator = btn.querySelector('.nav-indicator');
    const icon = btn.querySelector('.nav-icon');
    const label = btn.querySelector('.nav-label');
    
    if (indicator) indicator.classList.toggle('active', isActive);
    if (icon) {
      icon.classList.toggle('active', isActive);
      icon.classList.toggle('inactive', !isActive);
      icon.setAttribute('stroke-width', isActive ? '2.5' : '2');
    }
    if (label) {
      label.classList.toggle('active', isActive);
      label.classList.toggle('inactive', !isActive);
    }
  });
  
  render();
  scrollToTop();
}

// FIXED BREATHING IMPLEMENTATION
function startBreathing() {
  state.breathingActive = true;
  state.hasSeenBreath = true;
  state.isNewUser = false;
  breathCycleCount = 0;
  saveState();
  render();
  
  // Wait for DOM then start cycle
  setTimeout(() => {
    breatheCycle();
  }, 100);
}

function breatheCycle() {
  if (!state.breathingActive) return;
  
  const circle = document.getElementById('breathCircle');
  const text = document.getElementById('breathText');
  
  if (!circle || !text) {
    console.error('Breath elements not found');
    return;
  }
  
  breathCycleCount++;
  console.log('Starting breath cycle', breathCycleCount);
  
  // Reset to starting state with no transition
  circle.style.transition = 'none';
  circle.style.transform = 'scale(1)';
  circle.style.boxShadow = '0 0 60px rgba(14,116,144,0.25), 0 0 100px rgba(217,119,6,.2)';
  text.textContent = 'Get ready...';
  
  // Force reflow
  void circle.offsetWidth;
  
  // Phase 1: Breathe in (4s)
  setTimeout(() => {
    if (!state.breathingActive) return;
    circle.style.transition = 'transform 4s ease-in-out, box-shadow 4s ease-in-out';
    text.textContent = 'Breathe in...';
    circle.style.transform = 'scale(1.5)';
    circle.style.boxShadow = '0 0 100px rgba(14,116,144,0.6), 0 0 160px rgba(217,119,6,.4)';
  }, 100);
  
  // Phase 2: Hold (2s)
  breathTimer = setTimeout(() => {
    if (!state.breathingActive) return;
    text.textContent = 'Hold...';
  }, 4100);
  
  // Phase 3: Breathe out (6s)
  breathTimer = setTimeout(() => {
    if (!state.breathingActive) return;
    text.textContent = 'Breathe out...';
    circle.style.transition = 'transform 6s ease-in-out, box-shadow 6s ease-in-out';
    circle.style.transform = 'scale(1)';
    circle.style.boxShadow = '0 0 60px rgba(14,116,144,0.25), 0 0 100px rgba(217,119,6,.2)';
  }, 6100);
  
  // Phase 4: Rest (2s)
  breathTimer = setTimeout(() => {
    if (!state.breathingActive) return;
    text.textContent = 'Rest...';
  }, 12100);
  
  // Check if we should continue (3 minutes = ~13 cycles of 14 seconds)
  breathTimer = setTimeout(() => {
    if (!state.breathingActive) return;
    if (breathCycleCount < 13) {
      breatheCycle(); // Continue
    } else {
      // Auto-finish after 3 minutes
      stopBreathing();
      showToast('Well done! üåä');
    }
  }, 14100);
}

function stopBreathing() {
  state.breathingActive = false;
  breathCycleCount = 0;
  if (breathTimer) {
    clearTimeout(breathTimer);
    breathTimer = null;
  }
  render();
  showToast('Find your center anytime üåä');
}

function startCourse(id) {
  const course = courses.find(c => c.id === id);
  if (!course) return;
  
  if (!state.coursesStarted.includes(id)) {
    state.coursesStarted.push(id);
    state.isNewUser = false;
    updateWarmth();
    saveState();
  }
  
  if (course.link) {
    window.location.href = course.link;
  } else {
    showToast(`${course.title} coming soon! ‚ú®`);
  }
}

function toggleNotifications() {
  state.notificationsEnabled = !state.notificationsEnabled;
  saveState();
  render();
  showToast(state.notificationsEnabled ? 'Reminders enabled üîî' : 'Reminders disabled üîï');
}

function renderHome() {
  const continueCourse = state.coursesStarted.length > 0 ? 
    courses.find(c => state.coursesStarted.includes(c.id)) : null;
  
  const featuredCourses = courses.slice(0, 3);
  const greeting = state.isNewUser ? 'Welcome to MPHaven' : 'Welcome back';
  const subheading = state.isNewUser ? 
    'Your journey to growth and healing begins here' : 
    'Your space for growth and healing';
  
  return `<div class="content-wrapper fade-in">
    <div style="margin-bottom:2rem">
      ${state.isNewUser ? `<div class="welcome-badge">
        <svg style="width:1rem;height:1rem" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
        New Journey
      </div>` : ''}
      <h1 style="color:var(--text-primary);font-size:2.5rem;font-weight:800;margin-bottom:.5rem;line-height:1.2">${greeting}</h1>
      <p style="color:var(--text-secondary);font-size:1rem;line-height:1.6">${subheading}</p>
    </div>
    
    ${!state.hasSeenBreath && !state.breathingActive ? `<div style="background:var(--gradient-subtle);border:1px solid var(--teal-glow);border-radius:1.5rem;padding:1.5rem;margin-bottom:2rem">
      <div style="text-align:center;margin-bottom:1rem">
        <h3 style="color:var(--text-primary);font-size:1rem;font-weight:600;margin-bottom:.5rem">Take a moment to arrive</h3>
        <p style="color:var(--text-muted);font-size:.875rem">A brief breath to center yourself</p>
      </div>
      <div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">
        <button onclick="startBreathing()" style="padding:.75rem 1.25rem;background:var(--gradient-main);color:white;border:none;border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.875rem;-webkit-tap-highlight-color:transparent;transition:transform .2s" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">Try 3 Minutes</button>
        <button onclick="state.hasSeenBreath=true;state.isNewUser=false;saveState();render()" style="padding:.75rem 1.25rem;background:var(--bg-card-light);color:var(--text-muted);border:1px solid var(--border-softer);border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.875rem;-webkit-tap-highlight-color:transparent">Skip for Now</button>
      </div>
    </div>` : ''}
    
    ${state.breathingActive ? `<div style="background:var(--gradient-subtle);border:1px solid var(--teal-glow);border-radius:1.5rem;padding:1.5rem 1rem;margin-bottom:2rem;text-align:center">
      <div class="breath-circle" id="breathCircle"></div>
      <div class="breath-text" id="breathText">Get ready...</div>
      <button onclick="stopBreathing()" style="padding:.75rem 1.5rem;background:rgba(239,68,68,.15);border:2px solid rgba(239,68,68,.35);color:rgb(252,165,165);border-radius:.75rem;font-weight:600;cursor:pointer;font-size:.875rem;-webkit-tap-highlight-color:transparent;margin-top:1rem;transition:all .2s" onmousedown="this.style.transform='scale(0.96)'" onmouseup="this.style.transform='scale(1)'">Finish Early</button>
    </div>` : ''}
    
    ${continueCourse ? `<div style="margin-bottom:2rem">
      <h2 style="color:var(--text-muted);font-size:.75rem;font-weight:700;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.1em">Continue Learning</h2>
      <button onclick="startCourse('${continueCourse.id}')" class="card" style="padding:1.5rem;background:linear-gradient(135deg,${continueCourse.color}25,${continueCourse.color}15);border:2px solid ${continueCourse.color}50;text-align:left;width:100%">
        <div style="display:flex;align-items:center;gap:1rem">
          <div class="icon-container" style="width:3.5rem;height:3.5rem;background:${continueCourse.color}">
            <div style="width:1.75rem;height:1.75rem;color:white">${getIcon(continueCourse.icon, '2')}</div>
          </div>
          <div style="flex:1">
            <h3 style="color:var(--text-primary);font-size:1.125rem;font-weight:700;margin-bottom:.25rem">${continueCourse.title}</h3>
            <p style="color:var(--text-secondary);font-size:.875rem">${continueCourse.description}</p>
          </div>
          <svg style="width:1.5rem;height:1.5rem;color:var(--text-teal-light);flex-shrink:0" stroke-width="2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
        </div>
      </button>
    </div>` : ''}
    
    <div>
      <h2 style="color:var(--text-muted);font-size:.75rem;font-weight:700;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.1em">${state.coursesStarted.length > 0 ? 'Explore More' : 'Start Your Journey'}</h2>
      <div style="display:grid;gap:1rem;margin-bottom:1.5rem">
        ${featuredCourses.filter(c => !state.coursesStarted.includes(c.id)).slice(0, 2).map(course => `
          <button onclick="startCourse('${course.id}')" class="card" style="background:linear-gradient(135deg,${course.color}15,${course.color}08);border:1px solid ${course.color}30;text-align:left">
            <div style="display:flex;align-items:center;gap:1rem">
              <div class="icon-container" style="width:3rem;height:3rem;background:${course.color}">
                <div style="width:1.5rem;height:1.5rem;color:white">${getIcon(course.icon, '2')}</div>
              </div>
              <div style="flex:1">
                <h3 style="color:var(--text-primary);font-size:1rem;font-weight:700;margin-bottom:.25rem">${course.title}</h3>
                <p style="color:var(--text-muted);font-size:.8125rem">${course.description}</p>
              </div>
              <svg style="width:1.125rem;height:1.125rem;color:var(--text-dim);flex-shrink:0" stroke-width="2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
            </div>
          </button>
        `).join('')}
      </div>
      <button onclick="switchTab('paths')" style="width:100%;padding:1rem;background:var(--bg-card-light);border:1px solid var(--border-softer);border-radius:1rem;color:var(--text-primary);font-weight:600;font-size:.9375rem;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .2s" class="card">View All Courses</button>
    </div>
  </div>`;
}

function renderPaths() {
  const categories = [...new Set(courses.map(c => c.category))];
  
  return `<div class="content-wrapper fade-in">
    <div style="margin-bottom:2rem">
      <h2 style="color:var(--text-primary);font-size:2.5rem;font-weight:800;margin-bottom:.5rem">Learning Paths</h2>
      <p style="color:var(--text-muted);font-size:1rem">Choose your journey</p>
    </div>
    
    ${categories.map(category => {
      const categoryCourses = courses.filter(c => c.category === category);
      return `
        <div style="margin-bottom:2.5rem">
          <h3 style="color:var(--text-muted);font-size:.75rem;font-weight:700;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.1em">${category}</h3>
          <div style="display:grid;gap:1rem">
            ${categoryCourses.map(course => {
              const started = state.coursesStarted.includes(course.id);
              return `
                <button onclick="startCourse('${course.id}')" class="path-card" style="border:1px solid ${course.color}40;background:linear-gradient(135deg,${course.color}${started ? '25' : '15'},${course.color}${started ? '15' : '08'});text-align:left">
                  <div style="display:flex;align-items:center;gap:1rem">
                    <div class="icon-container" style="width:3.5rem;height:3.5rem;background:${course.color}">
                      <div style="width:1.75rem;height:1.75rem;color:white">${getIcon(course.icon, '2')}</div>
                    </div>
                    <div style="flex:1">
                      <h3 style="color:var(--text-primary);font-size:1.125rem;font-weight:700;margin-bottom:.25rem">${course.title}</h3>
                      <p style="color:var(--text-secondary);font-size:.875rem">${course.description}</p>
                    </div>
                    <div style="padding:.5rem .875rem;border-radius:.75rem;background:${course.color}40;color:white;font-size:.75rem;font-weight:600;white-space:nowrap">${started ? 'Continue' : 'Start'}</div>
                  </div>
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('')}
  </div>`;
}

function renderYou() {
  return `<div class="content-wrapper fade-in">
    <div style="margin-bottom:2rem">
      <h2 style="color:var(--text-primary);font-size:2.5rem;font-weight:800;margin-bottom:.5rem">You</h2>
      <p style="color:var(--text-muted);font-size:1rem">Your preferences & settings</p>
    </div>
    
    <div style="background:var(--bg-card-light);border:1px solid var(--border-softer);border-radius:1rem;padding:1.25rem;margin-bottom:1rem">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="flex:1">
          <div style="color:var(--text-primary);font-weight:600;font-size:.9375rem;margin-bottom:.25rem">Practice Reminders</div>
          <div style="color:var(--text-muted);font-size:.8125rem">Daily gentle reminders</div>
        </div>
        <button onclick="toggleNotifications()" style="width:3rem;height:1.75rem;border-radius:9999px;border:none;cursor:pointer;transition:background .2s;background:${state.notificationsEnabled ? 'var(--gradient-main)' : 'var(--border-softer)'};position:relative;-webkit-tap-highlight-color:transparent">
          <div style="width:1.25rem;height:1.25rem;border-radius:50%;background:white;position:absolute;top:.25rem;transition:left .2s;left:${state.notificationsEnabled ? '1.5rem' : '.25rem'}"></div>
        </button>
      </div>
    </div>
    
    ${state.breathingActive === false && state.hasSeenBreath ? `<button onclick="startBreathing();switchTab('home')" style="width:100%;padding:1.25rem;background:var(--bg-card-light);border:1px solid var(--border-softer);border-radius:1rem;display:flex;align-items:center;gap:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent;text-align:left;margin-bottom:1rem;transition:all .2s" class="card">
      <div style="width:2.5rem;height:2.5rem;border-radius:.625rem;background:var(--teal-glow);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg style="width:1.25rem;height:1.25rem;color:var(--text-teal-light)" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </div>
      <div style="flex:1">
        <div style="color:var(--text-primary);font-weight:600;font-size:.9375rem;margin-bottom:.25rem">Breath Exercise</div>
        <div style="color:var(--text-muted);font-size:.8125rem">3 minutes to center yourself</div>
      </div>
      <svg style="width:1rem;height:1rem;color:var(--text-muted);flex-shrink:0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
    </button>` : ''}
    
    <div style="background:var(--teal-glow);border:1px solid var(--teal-glow);border-radius:1rem;padding:1.25rem;margin-bottom:2rem">
      <div style="display:flex;align-items:start;gap:1rem">
        <svg style="width:1.5rem;height:1.5rem;color:var(--text-teal-light);flex-shrink:0;margin-top:.125rem" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
        <div style="flex:1">
          <div style="color:var(--text-teal-light);font-weight:600;font-size:.9375rem;margin-bottom:.5rem">Your Privacy Matters</div>
          <p style="color:var(--text-secondary);font-size:.8125rem;line-height:1.5">All your progress is saved locally on your device. Nothing is uploaded to any server.</p>
        </div>
      </div>
    </div>
    
    <div style="margin-top:3rem;padding-top:2rem;border-top:1px solid rgba(239,68,68,.2)">
      <h3 style="color:rgb(252,165,165);font-size:.75rem;font-weight:700;margin-bottom:1rem;text-transform:uppercase;letter-spacing:0.1em">Account</h3>
      <button onclick="showLogoutModal()" style="width:100%;padding:1.25rem;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:1rem;display:flex;align-items:center;gap:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent;text-align:left;transition:all .2s" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
        <div style="width:2.5rem;height:2.5rem;border-radius:.625rem;background:rgba(239,68,68,.2);display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <svg style="width:1.25rem;height:1.25rem;color:rgb(252,165,165)" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        </div>
        <div style="flex:1">
          <div style="color:rgb(252,165,165);font-weight:600;font-size:.9375rem;margin-bottom:.25rem">Log Out</div>
          <div style="color:var(--text-muted);font-size:.8125rem">Clear all progress and start fresh</div>
        </div>
        <svg style="width:1rem;height:1rem;color:var(--text-muted);flex-shrink:0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
      </button>
    </div>
    
    <div style="text-align:center;margin-top:3rem;padding:2rem">
      <p style="color:var(--text-dim);font-size:.75rem">MPHaven v2.0</p>
      <p style="color:rgb(71,85,105);font-size:.6875rem;margin-top:.25rem">Your companion for growth</p>
      <button onclick="if(confirm('Reset all data? This will clear everything.')){localStorage.clear();location.reload();}" style="margin-top:1rem;padding:.5rem 1rem;background:rgba(100,116,139,.1);border:1px solid rgba(100,116,139,.3);border-radius:.5rem;color:rgb(100,116,139);font-size:.625rem;cursor:pointer;-webkit-tap-highlight-color:transparent">Reset All Data</button>
    </div>
  </div>`;
}

function render() {
  const content = document.getElementById('mainContent');
  if (!content) return;
  
  switch (state.currentTab) {
    case 'home':
      content.innerHTML = renderHome();
      break;
    case 'paths':
      content.innerHTML = renderPaths();
      break;
    case 'you':
      content.innerHTML = renderYou();
      break;
  }
}

function initApp() {
  loadState();
  updateWarmth();
  state.currentTab = 'home';
  render();
  switchTab('home');
  
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) hideLogoutModal();
    });
  }
}

// ========== INITIALIZATION - FIXED NO GLITCHES ==========
// ========== INITIALIZATION - FIXED TO SHOW CONTENT ==========
document.addEventListener('DOMContentLoaded', function() {
  // ALWAYS initialize the app first so content loads
  initApp();
  
  // THEN check disclaimer and crisis status
  setTimeout(function() {
    const acknowledged = localStorage.getItem('mphaven_disclaimer_acknowledged');
    const version = localStorage.getItem('mphaven_disclaimer_version');
    const lastCrisisCheck = localStorage.getItem('mphaven_last_crisis_check');
    
    // If never acknowledged or version changed, redirect to full disclaimer
    if (acknowledged !== 'true' || version !== DISCLAIMER_VERSION) {
      window.location.href = 'disclaimer.html';
      return;
    }
    
    // Check if we need a new crisis check (5+ minutes since last check)
    if (lastCrisisCheck) {
      const timeSinceLastCheck = Date.now() - parseInt(lastCrisisCheck);
      if (timeSinceLastCheck < CRISIS_SESSION_TIMEOUT) {
        // Recent check passed - all good
        return;
      }
    }
    
    // Need crisis check - show modal (but don't block content)
    showCrisisCheck();
  }, 100); // Small delay to ensure app renders first
});

window.addEventListener('beforeunload', saveState);
</script>
</body>
</html>
