<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Module 3: Riding the Wave ‚Äî Mental Techniques</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: rgba(15, 23, 42, 0.98);
    --bg-card-light: rgba(30, 41, 59, 0.65);
    --bg-card-dark: rgba(15, 23, 42, 0.45);
    --border-subtle: rgba(30, 41, 59, 0.5);
    --border-softer: rgba(51, 65, 85, 0.4);
    --primary-teal: #0e7490;
    --primary-teal-dark: #0c627a;
    --accent-amber: #d97706;
    --accent-amber-dark: #b45309;
    --text-primary: rgb(241, 245, 249);
    --text-secondary: rgb(203, 213, 225);
    --text-muted: rgb(148, 163, 184);
    --text-teal-light: rgb(165, 243, 252);
    --text-teal: rgb(94, 234, 212);
    --text-amber: rgb(251, 191, 36);
    --success-emerald: rgb(74, 222, 128);
    --success-bg: rgba(34, 197, 94, 0.12);
    --gradient-main: linear-gradient(135deg, #0e7490, #d97706);
    --gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
    --crisis-red: #dc2626;
    --crisis-red-dark: #b91c1c;
    --crisis-bg: rgba(220, 38, 38, 0.08);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg-dark);
    color: var(--text-primary);
}

.container {
    width: 100%;
    height: 100vh;
    height: -webkit-fill-available;
    display: flex;
    flex-direction: column;
}

.app-wrapper {
    width: 100%;
    max-width: 28rem;
    height: 100%;
    margin: 0 auto;
    background: var(--bg-card);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.bg-blur-1, .bg-blur-2 {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.3;
}

.bg-blur-1 {
    top: -5%;
    left: 50%;
    transform: translateX(-50%);
    width: 22rem;
    height: 22rem;
    background: rgba(14, 116, 144, 0.15);
}

.bg-blur-2 {
    bottom: -5%;
    right: -5%;
    width: 18rem;
    height: 18rem;
    background: rgba(217, 119, 6, 0.15);
}

.main-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    position: relative;
    z-index: 1;
}

.main-content::-webkit-scrollbar {
    display: none;
}

.content-wrapper {
    padding: 1.25rem;
    padding-bottom: calc(2rem + env(safe-area-inset-bottom));
    min-height: 100%;
    display: flex;
    flex-direction: column;
}

/* Crisis Banner */
.crisis-banner {
    background: var(--crisis-bg);
    border: 1px solid var(--crisis-red);
    border-radius: 0.875rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.crisis-banner__text {
    color: #fca5a5;
    font-size: 0.875rem;
    font-weight: 600;
    flex: 1;
    min-width: 180px;
}

.crisis-banner__actions {
    display: flex;
    gap: 0.625rem;
}

.crisis-banner__link {
    color: white;
    background: var(--crisis-red);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-size: 0.8125rem;
    font-weight: 700;
    transition: all 0.2s;
}

.crisis-banner__link:active {
    background: #b91c1c;
    transform: scale(0.97);
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
}

.header__top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.back-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    transition: all 0.2s;
}

.back-btn:active {
    transform: scale(0.9);
}

.step-indicator {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 600;
}

.progress-dots {
    display: flex;
    gap: 0.375rem;
    margin-bottom: 1rem;
}

.progress-dot {
    flex: 1;
    height: 0.5rem;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 1rem;
    transition: all 0.3s;
}

.progress-dot.active {
    background: var(--gradient-main);
}

.step-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: var(--gradient-main);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.step-subtitle {
    color: var(--text-secondary);
    font-size: 0.9375rem;
}

/* Card */
.card {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1.25rem;
    padding: 1.75rem 1.5rem;
    margin-bottom: 1.25rem;
}

.card--highlight {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14, 116, 144, 0.3);
}

.card__icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 1rem;
    line-height: 1;
}

.card__title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 0.625rem;
}

.card__content {
    color: var(--text-secondary);
    line-height: 1.7;
    font-size: 1rem;
}

.card__content p {
    margin-bottom: 1.25rem;
}

.card__content p:last-child {
    margin-bottom: 0;
}

.card__content strong {
    color: var(--text-teal);
    font-weight: 600;
}

/* Section Header */
.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-softer);
}

.section-icon {
    font-size: 1.75rem;
}

.section-title-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-teal-light);
}

/* Stats */
.technique-stats {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(15,23,42,0.6);
    border-radius: 0.75rem;
}

.stat {
    flex: 1;
    text-align: center;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.stat-value {
    color: var(--text-teal);
    font-weight: 700;
    font-size: 1rem;
    margin-top: 0.25rem;
}

/* Instruction Box */
.instruction-box {
    background: rgba(15,23,42,0.6);
    border-left: 4px solid var(--primary-teal);
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin: 1.25rem 0;
}

.instruction-list {
    list-style: none;
    counter-reset: step-counter;
}

.instruction-list li {
    counter-increment: step-counter;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
}

.instruction-list li:before {
    content: counter(step-counter);
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    font-weight: 700;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
}

/* Safety Note */
.safety-note {
    background: rgba(220,38,38,0.1);
    border-left: 4px solid var(--crisis-red);
    padding: 1rem;
    border-radius: 0.75rem;
    margin: 1rem 0;
    font-size: 0.8125rem;
    color: #fca5a5;
    line-height: 1.6;
}

/* Practice Card */
.practice-card {
    background: var(--gradient-subtle);
    border: 2px solid rgba(14,116,144,0.3);
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 1.25rem 0;
}

.practice-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-teal-light);
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.practice-buttons {
    display: flex;
    gap: 0.75rem;
    margin: 1.25rem 0;
}

.btn-practice {
    flex: 1;
    padding: 0.875rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-practice-primary {
    background: var(--gradient-main);
    color: white;
}

.btn-practice-primary:active {
    transform: scale(0.98);
    opacity: 0.9;
}

.btn-practice-secondary {
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn-practice-secondary:active {
    background: rgba(30, 41, 59, 0.8);
    transform: scale(0.98);
}

.btn-practice-danger {
    background: rgba(220,38,38,0.2);
    color: #fca5a5;
    border: 1px solid var(--crisis-red);
}

.btn-practice-danger:active {
    background: rgba(220,38,38,0.3);
    transform: scale(0.98);
}

/* Timer Controls */
.timer-container {
    text-align: center;
    padding: 1.5rem;
    background: rgba(15,23,42,0.8);
    border-radius: 1rem;
    margin: 1rem 0;
}

.timer-display {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--text-teal);
    font-variant-numeric: tabular-nums;
    margin-bottom: 1rem;
    font-family: 'Inter', monospace;
}

.timer-controls {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
}

.timer-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.timer-btn-start {
    background: var(--gradient-main);
    color: white;
}

.timer-btn-pause {
    background: var(--accent-amber);
    color: white;
}

.timer-btn-reset {
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.timer-btn:active {
    transform: scale(0.95);
}

.timer-btn:disabled {
    opacity: 0.4;
    pointer-events: none;
}

/* Checkboxes */
.reflection-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem;
    background: rgba(15,23,42,0.6);
    border: 1px solid var(--border-softer);
    border-radius: 0.75rem;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 0.875rem;
    transition: all 0.2s;
}

.reflection-checkbox.checked {
    border-color: var(--primary-teal);
    background: rgba(14,116,144,0.15);
    color: var(--text-primary);
}

.reflection-checkbox input[type="checkbox"] {
    width: 1.125rem;
    height: 1.125rem;
    accent-color: var(--primary-teal);
}

.reflection-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin: 1.25rem 0;
}

/* Input fields with save indicators */
.input-field {
    width: 100%;
    padding: 0.875rem 1rem;
    background: rgba(15,23,42,0.6);
    border: 2px solid var(--border-softer);
    border-radius: 0.75rem;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
}

.input-field:focus {
    outline: none;
    border-color: var(--primary-teal);
    background: rgba(15,23,42,0.8);
}

.input-field.saved {
    border-color: var(--success-emerald);
    background: rgba(34, 197, 94, 0.1);
}

.input-save-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    font-size: 0.75rem;
}

.input-save-indicator span {
    color: var(--success-emerald);
    display: none;
}

.input-save-indicator span.show {
    display: inline;
}

/* Math challenge */
.math-challenge {
    background: rgba(15,23,42,0.6);
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 1rem 0;
}

.math-equation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-teal-light);
    margin-bottom: 1.5rem;
}

.math-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.math-input {
    width: 100px;
    text-align: center;
    font-size: 1.5rem;
    padding: 0.75rem;
    background: rgba(15,23,42,0.8);
    border: 2px solid var(--border-softer);
    border-radius: 0.75rem;
    color: var(--text-primary);
}

.math-feedback {
    text-align: center;
    min-height: 2rem;
    margin: 1rem 0;
    font-weight: 600;
}

.math-correct {
    color: var(--success-emerald);
}

.math-incorrect {
    color: #fca5a5;
}

.math-progress {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-softer);
}

.math-dot {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: rgba(148,163,184,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-weight: 600;
}

.math-dot.completed {
    background: var(--success-bg);
    color: var(--success-emerald);
    border: 1px solid var(--success-emerald);
}

/* Reference Card */
.reference-card {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14,116,144,0.3);
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.reference-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-teal-light);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reference-grid {
    display: grid;
    gap: 0.75rem;
}

.reference-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(15,23,42,0.6);
    border-radius: 0.75rem;
}

.reference-icon {
    font-size: 1.25rem;
}

.reference-content {
    flex: 1;
}

.reference-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin-bottom: 0.125rem;
}

.reference-use {
    color: var(--text-muted);
    font-size: 0.75rem;
}

/* Buttons */
.btn {
    width: 100%;
    padding: 1.125rem 1.5rem;
    border-radius: 1rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    text-decoration: none;
}

.btn--primary {
    background: var(--gradient-main);
    color: white;
}

.btn--primary:active {
    transform: scale(0.98);
    opacity: 0.9;
}

.btn--secondary {
    background: rgba(30, 41, 59, 0.6);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn--secondary:active {
    background: rgba(30, 41, 59, 0.8);
    transform: scale(0.98);
}

.btn--save {
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    border: 1px solid rgba(14, 116, 144, 0.3);
    padding: 0.875rem 1.5rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    margin-top: 1rem;
}

.btn--save:active {
    background: rgba(14, 116, 144, 0.2);
    transform: scale(0.98);
}

.btn--save.saved {
    background: var(--success-bg);
    color: var(--success-emerald);
    border-color: rgba(74, 222, 128, 0.3);
}

.btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
}

.save-feedback {
    color: var(--success-emerald);
    font-size: 0.875rem;
    text-align: center;
    margin-top: 0.875rem;
    display: none;
}

.save-feedback.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

/* Practice Button */
.practice-section {
    text-align: center;
    margin: 1.25rem 0;
}

.practice-btn {
    background: var(--success-bg);
    color: var(--success-emerald);
    border: 1px solid rgba(74, 222, 128, 0.3);
    padding: 0.875rem 2rem;
    border-radius: 2rem;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
}

.practice-btn:active {
    background: rgba(34, 197, 94, 0.2);
    transform: scale(0.97);
}

.practice-btn.marked {
    background: rgba(34, 197, 94, 0.25);
}

/* Footer */
.footer {
    margin-top: auto;
    padding-top: 2rem;
    border-top: 1px solid var(--border-subtle);
    text-align: center;
}

.footer__warning {
    color: #fca5a5;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.footer__resources {
    color: var(--text-muted);
    font-size: 0.8125rem;
    line-height: 1.8;
}

.footer__resources p {
    margin-bottom: 0.5rem;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.timer-active {
    animation: pulse 2s infinite;
}

.step-content {
    animation: fadeIn 0.3s ease-out;
}

/* Mobile Adjustments */
@media (max-width: 640px) {
    .reflection-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-group {
        grid-template-columns: 1fr;
    }
    
    .practice-buttons {
        flex-direction: column;
    }
    
    .timer-controls {
        flex-direction: column;
    }
}

/* iOS Safe Area */
@supports (-webkit-touch-callout: none) {
    .container {
        height: -webkit-fill-available;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="app-wrapper">
        <div class="bg-blur-1"></div>
        <div class="bg-blur-2"></div>
        <div class="main-content" id="mainContent">
            <div class="content-wrapper" id="content">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Check disclaimer acknowledgment
    const acknowledged = localStorage.getItem('crisis_disclaimer_acknowledged');
    if (!acknowledged) {
        window.location.href = 'crisis-intro.html';
        return;
    }

    // State
    let currentStep = 1;
    const totalSteps = 8;
    let userData = {
        groundingBefore: 5,
        groundingAfter: 5,
        cognitiveBefore: 5,
        cognitiveAfter: 5,
        sensationBefore: 5,
        sensationAfter: 5,
        selectedTechniques: [],
        // Saved input values
        groundingInputs: {
            see: ['', '', '', '', ''],
            touch: ['', '', '', ''],
            hear: ['', '', ''],
            smell: ['', ''],
            taste: ['']
        },
        distractionInputs: {
            high1: '',
            high2: '',
            med1: '',
            med2: ''
        }
    };
    
    // Step titles
    const stepTitles = {
        1: 'Introduction',
        2: 'Grounding ‚Äî 5-4-3-2-1',
        3: 'Cognitive Load',
        4: 'Intense Sensations',
        5: 'Bilateral Stimulation',
        6: 'Strategic Distraction',
        7: 'Your Top Techniques',
        8: 'Module Complete!'
    };
    
    // Storage helpers
    function saveProgress() {
        try {
            const data = {
                step: currentStep,
                userData: userData,
                timestamp: Date.now()
            };
            localStorage.setItem('crisis_module3_progress', JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Save failed:', e);
            return false;
        }
    }
    
    function loadProgress() {
        try {
            const saved = localStorage.getItem('crisis_module3_progress');
            if (saved) {
                const data = JSON.parse(saved);
                // Check if less than 7 days old
                if (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000) {
                    currentStep = data.step;
                    userData = { ...userData, ...data.userData };
                    return true;
                }
            }
        } catch (e) {
            console.error('Load failed:', e);
        }
        return false;
    }
    
    function saveToCrisisPlan(key, value) {
        try {
            let plan = JSON.parse(localStorage.getItem('crisis_plan') || '{}');
            plan[key] = value;
            plan.lastUpdated = new Date().toISOString();
            localStorage.setItem('crisis_plan', JSON.stringify(plan));
            return true;
        } catch (e) {
            console.error('Save to crisis plan failed:', e);
            return false;
        }
    }
    
    function saveToToolkit(item) {
        try {
            let toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
            toolkit = toolkit.filter(t => t.id !== item.id);
            toolkit.push({
                ...item,
                date: new Date().toISOString()
            });
            localStorage.setItem('crisis_toolkit', JSON.stringify(toolkit));
            return true;
        } catch (e) {
            console.error('Save to toolkit failed:', e);
            return false;
        }
    }
    
    // Auto-save input fields
    function setupAutoSave(inputId, storageKey) {
        const input = document.getElementById(inputId);
        if (input) {
            // Load saved value
            if (userData[storageKey] !== undefined) {
                input.value = userData[storageKey];
            }
            
            // Save on change
            input.addEventListener('input', function() {
                userData[storageKey] = this.value;
                saveProgress();
                
                // Visual feedback
                this.classList.add('saved');
                setTimeout(() => {
                    this.classList.remove('saved');
                }, 1000);
            });
        }
    }
    
    // Update progress
    let progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
    progress.currentModule = 3;
    progress.lastAccessed = new Date().toISOString();
    localStorage.setItem('crisis_course_progress', JSON.stringify(progress));
    
    // Navigation
    function scrollToTop() {
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }
    
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;
        currentStep = step;
        saveProgress();
        render();
        scrollToTop();
    }
    
    function nextStep() {
        if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            goToStep(currentStep - 1);
        } else {
            window.location.href = 'crisis-module-2.html';
        }
    }
    
    // Render functions
    function renderHeader(showCrisis = false) {
        return `
            ${showCrisis ? `
            <div class="crisis-banner">
                <span class="crisis-banner__text">üö® In crisis? Help is available 24/7</span>
                <div class="crisis-banner__actions">
                    <a href="tel:988" class="crisis-banner__link">Call 988</a>
                    <a href="sms:988" class="crisis-banner__link">Text 988</a>
                </div>
            </div>
            ` : ''}
            
            <div class="header">
                <div class="header__top">
                    <button class="back-btn" onclick="previousStep()">‚Üê</button>
                    <span class="step-indicator">${currentStep} / ${totalSteps}</span>
                </div>
                <div class="progress-dots">
                    ${Array(totalSteps).fill(0).map((_, i) => 
                        `<div class="progress-dot ${i < currentStep ? 'active' : ''}"></div>`
                    ).join('')}
                </div>
                <h1 class="step-title">${stepTitles[currentStep]}</h1>
                <p class="step-subtitle">Module 3: Mental Techniques ‚Äî Riding the Wave</p>
            </div>
        `;
    }
    
    function renderFooter() {
        return `
            <div class="footer">
                <p class="footer__warning">‚ö†Ô∏è EDUCATIONAL ONLY ‚Äî NOT THERAPY</p>
                <div class="footer__resources">
                    <p>988 Suicide & Crisis Lifeline: Call or text 988</p>
                    <p>Crisis Text Line: Text HOME to 741741</p>
                </div>
            </div>
        `;
    }
    
    function renderStep1() {
        return `
            <div class="step-content">
                ${renderHeader(true)}
                
                <div class="card">
                    <div class="card__icon">üåä</div>
                    <div class="card__content">
                        <p style="font-size: 1.05rem; color: var(--text-teal-light); font-style: italic;">
                            "Physical techniques bring down the intensity. Mental techniques help you WAIT without acting on urges. Remember: the goal isn't to stop feeling ‚Äî it's to get through the peak without making things worse."
                        </p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card__title">
                        <span>üí°</span>
                        <span>Why Mental Techniques Work</span>
                    </div>
                    <div class="card__content">
                        <p>Once your intensity is below 8/10 (after using physical tools), your thinking brain comes back online enough to use these techniques.</p>
                        
                        <p>Mental techniques work because they:</p>
                        
                        <p><strong>1. Occupy working memory</strong><br>
                        Your brain can only hold so much at once</p>
                        
                        <p><strong>2. Create competing sensations</strong><br>
                        Intense physical input interrupts emotional spiraling</p>
                        
                        <p><strong>3. Help you ride the wave</strong><br>
                        Emotions peak and fall naturally ‚Äî these help you survive the peak</p>
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep2() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üëÅÔ∏è</span>
                        <span class="section-title-text">Grounding ‚Äî 5-4-3-2-1</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Your brain has limited attention capacity. By directing attention to concrete sensory details, you occupy the neural circuits that would otherwise spiral into catastrophic thinking."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° 2-5 min</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Panic, dissociation</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Low</div>
                        </div>
                    </div>
                    
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.75rem;">The 5-4-3-2-1 Technique:</p>
                        
                        <ul class="instruction-list">
                            <li><strong>5 things you can SEE</strong> ‚Äî look around, name them out loud</li>
                            <li><strong>4 things you can TOUCH</strong> ‚Äî actually touch them, feel texture</li>
                            <li><strong>3 things you can HEAR</strong> ‚Äî listen closely, name each sound</li>
                            <li><strong>2 things you can SMELL</strong> ‚Äî sniff the air, a pillow, your sleeve</li>
                            <li><strong>1 thing you can TASTE</strong> ‚Äî take a sip, notice any taste</li>
                        </ul>
                    </div>
                    
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üëÅÔ∏è</span>
                            PRACTICE GROUNDING NOW
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Your answers are saved automatically:</p>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.5rem;">5 things you see:</p>
                            <input type="text" id="groundingSee1" class="input-field" placeholder="1. ___________" value="${userData.groundingInputs?.see?.[0] || ''}">
                            <input type="text" id="groundingSee2" class="input-field" placeholder="2. ___________" value="${userData.groundingInputs?.see?.[1] || ''}">
                            <input type="text" id="groundingSee3" class="input-field" placeholder="3. ___________" value="${userData.groundingInputs?.see?.[2] || ''}">
                            <input type="text" id="groundingSee4" class="input-field" placeholder="4. ___________" value="${userData.groundingInputs?.see?.[3] || ''}">
                            <input type="text" id="groundingSee5" class="input-field" placeholder="5. ___________" value="${userData.groundingInputs?.see?.[4] || ''}">
                            
                            <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">4 things you touch:</p>
                            <input type="text" id="groundingTouch1" class="input-field" placeholder="1. ___________" value="${userData.groundingInputs?.touch?.[0] || ''}">
                            <input type="text" id="groundingTouch2" class="input-field" placeholder="2. ___________" value="${userData.groundingInputs?.touch?.[1] || ''}">
                            <input type="text" id="groundingTouch3" class="input-field" placeholder="3. ___________" value="${userData.groundingInputs?.touch?.[2] || ''}">
                            <input type="text" id="groundingTouch4" class="input-field" placeholder="4. ___________" value="${userData.groundingInputs?.touch?.[3] || ''}">
                        </div>
                        
                        <div style="background: rgba(14,116,144,0.15); padding: 1rem; border-radius: 0.75rem; margin-top: 1rem;">
                            <p style="color: var(--text-teal-light); font-size: 0.875rem;">
                                ‚úì All answers are automatically saved. Come back anytime and they'll still be here.
                            </p>
                        </div>
                    </div>
                </div>
                
                <button id="saveGroundingBtn" class="btn--save">
                    <span>üëÅÔ∏è</span> Save Grounding to Toolkit
                </button>
                <div id="groundingSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep3() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üß©</span>
                        <span class="section-title-text">Cognitive Load ‚Äî Occupy Your Brain</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Your working memory can only hold about 4-7 pieces of information at once. When you fill it with a demanding mental task, there's literally less 'space' for rumination or emotional spiraling."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° Immediate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Racing thoughts</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Medium</div>
                        </div>
                    </div>
                    
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.75rem;">High-Load Mental Tasks:</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üßÆ Math Challenges</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Count backwards from 100 by 7s (100, 93, 86, 79...)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Multiply double-digit numbers in your head</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üî§ Word Games</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Name animals alphabetically (Alligator, Bear, Cat...)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Think of words with 3 vowels in a row</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üß† Memory Games</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Recite song lyrics backwards</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Describe your morning routine in extreme detail</p>
                    </div>
                    
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üß©</span>
                            INTERACTIVE CHALLENGE
                        </div>
                        
                        <div id="mathChallenge" class="math-challenge">
                            <div class="math-equation">
                                <span id="currentNumber">100</span>
                                <span>‚àí 7 =</span>
                                <span>?</span>
                            </div>
                            
                            <div class="math-input-group">
                                <input type="number" id="mathInput" class="math-input" placeholder="___">
                                <button id="mathSubmitBtn" class="btn-practice btn-practice-primary">Check</button>
                            </div>
                            
                            <div id="mathFeedback" class="math-feedback"></div>
                            
                            <div class="math-progress">
                                <span class="math-dot" id="dot1">100</span>
                                <span class="math-dot" id="dot2">93</span>
                                <span class="math-dot" id="dot3">86</span>
                                <span class="math-dot" id="dot4">79</span>
                                <span class="math-dot" id="dot5">72</span>
                            </div>
                            
                            <button id="mathResetBtn" class="btn-practice btn-practice-secondary" style="margin-top: 1rem;">Reset Challenge</button>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <p style="color: var(--text-secondary);">Rate your distress before and after:</p>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <div style="flex: 1;">
                                    <p style="color: var(--text-muted); font-size: 0.75rem; text-align: center;">Before</p>
                                    <input type="range" id="cognitiveBeforeSlider" min="0" max="10" value="${userData.cognitiveBefore || 5}" step="1" style="width: 100%;">
                                    <div style="text-align: center; color: var(--text-teal); font-weight: 700;" id="cognitiveBeforeValue">${userData.cognitiveBefore || 5}</div>
                                </div>
                                <div style="flex: 1;">
                                    <p style="color: var(--text-muted); font-size: 0.75rem; text-align: center;">After</p>
                                    <input type="range" id="cognitiveAfterSlider" min="0" max="10" value="${userData.cognitiveAfter || 5}" step="1" style="width: 100%;">
                                    <div style="text-align: center; color: var(--text-teal); font-weight: 700;" id="cognitiveAfterValue">${userData.cognitiveAfter || 5}</div>
                                </div>
                            </div>
                            <button id="saveCognitiveRatings" class="btn-practice btn-practice-secondary" style="margin-top: 1rem;">Save Ratings</button>
                        </div>
                    </div>
                    
                    <div class="safety-note">
                        <strong>‚ö†Ô∏è Note:</strong> For MODERATE distress (5-7/10). At 9/10, your brain can't do math ‚Äî use physical techniques first.
                    </div>
                </div>
                
                <button id="saveCognitiveBtn" class="btn--save">
                    <span>üß©</span> Save Cognitive Load to Toolkit
                </button>
                <div id="cognitiveSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep4() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üå∂Ô∏è</span>
                        <span class="section-title-text">Intense Sensations ‚Äî Safe Alternatives</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Strong sensory input engages your sensory processing systems, which competes with emotional processing. These techniques provide intense sensation safely."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° Immediate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Numbness, dissociation</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ High</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                            <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.5rem;">üëÖ Taste</p>
                            <ul style="color: var(--text-secondary); font-size: 0.875rem; list-style-position: inside;">
                                <li>Bite into a lemon</li>
                                <li>Hot sauce or wasabi</li>
                                <li>Sour candy</li>
                            </ul>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                            <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.5rem;">‚úã Touch</p>
                            <ul style="color: var(--text-secondary); font-size: 0.875rem; list-style-position: inside;">
                                <li>Grip ice cubes</li>
                                <li>Hot (not burning) shower</li>
                                <li>Firm massage</li>
                            </ul>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                            <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.5rem;">üëÉ Smell</p>
                            <ul style="color: var(--text-secondary); font-size: 0.875rem; list-style-position: inside;">
                                <li>Peppermint oil</li>
                                <li>Eucalyptus</li>
                                <li>Strong perfume</li>
                            </ul>
                        </div>
                        <div style="background: rgba(14,116,144,0.1); padding: 1rem; border-radius: 0.75rem;">
                            <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.5rem;">üîä Sound</p>
                            <ul style="color: var(--text-secondary); font-size: 0.875rem; list-style-position: inside;">
                                <li>Very loud music</li>
                                <li>Yell into pillow</li>
                                <li>Clap hands loudly</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üå∂Ô∏è</span>
                            SENSATION EXPERIMENT
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Pick one sensation to try:</p>
                        
                        <div class="practice-buttons">
                            <button id="sensationLemonBtn" class="btn-practice btn-practice-primary">üçã Lemon</button>
                            <button id="sensationIceBtn" class="btn-practice btn-practice-primary">üßä Ice</button>
                            <button id="sensationSmellBtn" class="btn-practice btn-practice-primary">üëÉ Smell</button>
                        </div>
                        
                        <div id="sensationRating" style="display: none; margin-top: 1.5rem;">
                            <p style="color: var(--text-secondary);">Rate your presence before and after:</p>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                <div style="flex: 1;">
                                    <p style="color: var(--text-muted); font-size: 0.75rem; text-align: center;">Before</p>
                                    <input type="range" id="sensationBeforeSlider" min="0" max="10" value="${userData.sensationBefore || 5}" step="1" style="width: 100%;">
                                    <div style="text-align: center; color: var(--text-teal); font-weight: 700;" id="sensationBeforeValue">${userData.sensationBefore || 5}</div>
                                </div>
                                <div style="flex: 1;">
                                    <p style="color: var(--text-muted); font-size: 0.75rem; text-align: center;">After</p>
                                    <input type="range" id="sensationAfterSlider" min="0" max="10" value="${userData.sensationAfter || 5}" step="1" style="width: 100%;">
                                    <div style="text-align: center; color: var(--text-teal); font-weight: 700;" id="sensationAfterValue">${userData.sensationAfter || 5}</div>
                                </div>
                            </div>
                            <button id="sensationDoneBtn" class="btn-practice btn-practice-primary" style="margin-top: 1rem;">Done</button>
                            <div id="sensationResult" style="margin-top: 1rem; padding: 1rem; background: rgba(14,116,144,0.15); border-radius: 0.75rem; display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="safety-note">
                        <strong>‚ö†Ô∏è Critical:</strong> These should never cause injury. If you're using sensation to punish yourself, that's different ‚Äî talk to a therapist.
                    </div>
                </div>
                
                <button id="saveSensationsBtn" class="btn--save">
                    <span>üå∂Ô∏è</span> Save Intense Sensations to Toolkit
                </button>
                <div id="sensationsSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep5() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">ü¶ã</span>
                        <span class="section-title-text">Bilateral Stimulation</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Alternating left-right stimulation may help process distress by engaging both brain hemispheres. This is used in EMDR therapy."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° 2-5 min</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Anxiety, flashbacks</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Low</div>
                        </div>
                    </div>
                    
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.75rem;">Techniques:</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">ü¶ã Butterfly Hug</p>
                        <p style="color: var(--text-secondary);">Cross arms over chest, tap alternating shoulders slowly</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üëÅÔ∏è Eye Movements</p>
                        <p style="color: var(--text-secondary);">Move finger slowly left-right, follow with eyes</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üö∂ Walking</p>
                        <p style="color: var(--text-secondary);">Walk slowly, noticing each foot: left... right... left... right...</p>
                    </div>
                    
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>ü¶ã</span>
                            BUTTERFLY HUG TIMER
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Cross your arms over your chest, hands on opposite shoulders.</p>
                        
                        <div class="timer-container">
                            <div class="timer-display" id="butterflyTimer">02:00</div>
                            <div style="font-size: 2rem; color: var(--text-teal); margin-bottom: 1rem;" id="butterflySide">Left</div>
                            
                            <div class="timer-controls">
                                <button id="timerStartBtn" class="timer-btn timer-btn-start">Start</button>
                                <button id="timerPauseBtn" class="timer-btn timer-btn-pause" disabled>Pause</button>
                                <button id="timerResetBtn" class="timer-btn timer-btn-reset">Reset</button>
                            </div>
                            
                            <div style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;" id="timerStatus">
                                Ready to begin
                            </div>
                        </div>
                        
                        <div id="butterflyAfter" style="display: none; margin-top: 1rem;">
                            <p style="color: var(--text-secondary);">How do you feel now?</p>
                            <div class="practice-buttons">
                                <button id="butterflyCalmBtn" class="btn-practice btn-practice-primary">Calmer</button>
                                <button id="butterflySameBtn" class="btn-practice btn-practice-secondary">Same</button>
                                <button id="butterflyAnxiousBtn" class="btn-practice btn-practice-danger">More anxious</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="saveBilateralBtn" class="btn--save">
                    <span>ü¶ã</span> Save Bilateral Stim to Toolkit
                </button>
                <div id="bilateralSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep6() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="section-header">
                        <span class="section-icon">üéÆ</span>
                        <span class="section-title-text">Strategic Distraction</span>
                    </div>
                    
                    <div class="card__content">
                        <p>
                            "Distraction gets a bad reputation, but strategic distraction during the peak of emotional intensity is ADAPTIVE. You're not avoiding the problem ‚Äî you're surviving the peak so you can address it later."
                        </p>
                    </div>
                    
                    <div class="technique-stats">
                        <div class="stat">
                            <div class="stat-label">Speed</div>
                            <div class="stat-value">‚ö° 5-30 min</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Best for</div>
                            <div class="stat-value">üéØ Moderate intensity</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Intensity</div>
                            <div class="stat-value">üí™ Low-medium</div>
                        </div>
                    </div>
                    
                    <div class="instruction-box">
                        <p style="color: var(--text-teal); font-weight: 700; margin-bottom: 0.75rem;">The Distraction Hierarchy:</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üî• HIGH ENGAGEMENT (Best)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Puzzles (Sudoku, crossword)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Video games (requiring focus)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Complex recipes</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Organizing/cleaning</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">üì∫ MEDIUM ENGAGEMENT</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ TV/movies</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Reading</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Podcasts</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">ü™´ LOW ENGAGEMENT (Least effective)</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Scrolling mindlessly</p>
                        <p style="color: var(--text-secondary);">‚Ä¢ Lying in bed</p>
                    </div>
                    
                    <div class="practice-card">
                        <div class="practice-title">
                            <span>üìù</span>
                            BUILD YOUR DISTRACTION MENU
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Your answers are saved automatically:</p>
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin-bottom: 0.5rem;">High engagement:</p>
                        <input type="text" id="distractionHigh1" class="input-field" placeholder="1. ___________" value="${userData.distractionInputs?.high1 || ''}">
                        <input type="text" id="distractionHigh2" class="input-field" placeholder="2. ___________" value="${userData.distractionInputs?.high2 || ''}">
                        
                        <p style="color: var(--text-teal-light); font-weight: 600; margin: 1rem 0 0.5rem;">Medium engagement:</p>
                        <input type="text" id="distractionMed1" class="input-field" placeholder="1. ___________" value="${userData.distractionInputs?.med1 || ''}">
                        <input type="text" id="distractionMed2" class="input-field" placeholder="2. ___________" value="${userData.distractionInputs?.med2 || ''}">
                        
                        <div style="background: rgba(14,116,144,0.15); padding: 1rem; border-radius: 0.75rem; margin-top: 1rem;">
                            <p style="color: var(--text-teal-light); font-size: 0.875rem;">
                                ‚úì All answers are automatically saved. Come back anytime and they'll still be here.
                            </p>
                        </div>
                    </div>
                    
                    <div class="safety-note">
                        <strong>‚ö†Ô∏è When NOT to use:</strong> 9/10 intensity (won't work ‚Äî use physical techniques first). When "distraction" = substances or harmful behaviors.
                    </div>
                </div>
                
                <button id="saveDistractionBtn" class="btn--save">
                    <span>üìù</span> Save Distraction Plan to Toolkit
                </button>
                <div id="distractionSaveFeedback" class="save-feedback"></div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep7() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="reference-card">
                    <div class="reference-title">
                        <span>üß†</span>
                        MENTAL TECHNIQUES ‚Äî Quick Reference
                    </div>
                    
                    <div class="reference-grid">
                        <div class="reference-item">
                            <span class="reference-icon">üëÅÔ∏è</span>
                            <div class="reference-content">
                                <div class="reference-name">Grounding (5-4-3-2-1)</div>
                                <div class="reference-use">2-5 min ‚Ä¢ Panic, dissociation</div>
                            </div>
                        </div>
                        <div class="reference-item">
                            <span class="reference-icon">üß©</span>
                            <div class="reference-content">
                                <div class="reference-name">Cognitive Load</div>
                                <div class="reference-use">Immediate ‚Ä¢ Racing thoughts</div>
                            </div>
                        </div>
                        <div class="reference-item">
                            <span class="reference-icon">üå∂Ô∏è</span>
                            <div class="reference-content">
                                <div class="reference-name">Intense Sensations</div>
                                <div class="reference-use">Immediate ‚Ä¢ Numbness, dissociation</div>
                            </div>
                        </div>
                        <div class="reference-item">
                            <span class="reference-icon">ü¶ã</span>
                            <div class="reference-content">
                                <div class="reference-name">Bilateral Stimulation</div>
                                <div class="reference-use">2-5 min ‚Ä¢ Anxiety, flashbacks</div>
                            </div>
                        </div>
                        <div class="reference-item">
                            <span class="reference-icon">üéÆ</span>
                            <div class="reference-content">
                                <div class="reference-name">Strategic Distraction</div>
                                <div class="reference-use">5-30 min ‚Ä¢ Moderate intensity</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-softer);">
                        <p style="color: var(--text-primary); font-weight: 700; margin-bottom: 1rem;">
                            "Which 2-3 techniques felt most helpful?"
                        </p>
                        
                        <div class="reflection-grid">
                            <label class="reflection-checkbox ${userData.selectedTechniques?.includes('Grounding') ? 'checked' : ''}">
                                <input type="checkbox" value="Grounding" ${userData.selectedTechniques?.includes('Grounding') ? 'checked' : ''}> Grounding
                            </label>
                            <label class="reflection-checkbox ${userData.selectedTechniques?.includes('Cognitive Load') ? 'checked' : ''}">
                                <input type="checkbox" value="Cognitive Load" ${userData.selectedTechniques?.includes('Cognitive Load') ? 'checked' : ''}> Cognitive load
                            </label>
                            <label class="reflection-checkbox ${userData.selectedTechniques?.includes('Intense Sensations') ? 'checked' : ''}">
                                <input type="checkbox" value="Intense Sensations" ${userData.selectedTechniques?.includes('Intense Sensations') ? 'checked' : ''}> Sensations
                            </label>
                            <label class="reflection-checkbox ${userData.selectedTechniques?.includes('Bilateral') ? 'checked' : ''}">
                                <input type="checkbox" value="Bilateral" ${userData.selectedTechniques?.includes('Bilateral') ? 'checked' : ''}> Bilateral
                            </label>
                            <label class="reflection-checkbox ${userData.selectedTechniques?.includes('Distraction') ? 'checked' : ''}">
                                <input type="checkbox" value="Distraction" ${userData.selectedTechniques?.includes('Distraction') ? 'checked' : ''}> Distraction
                            </label>
                        </div>
                        
                        <button id="saveReflectionBtn" class="btn--save">
                            <span>üìã</span> Save My Top Techniques
                        </button>
                        <div id="reflectionSaveFeedback" class="save-feedback"></div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn--primary" onclick="nextStep()">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep8() {
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card card--highlight">
                    <div class="card__icon">‚úÖ</div>
                    <div class="card__title">Module 3 Complete!</div>
                    <div class="card__content">
                        <p>You now have mental techniques to ride the wave when your thinking brain starts coming back online.</p>
                        
                        <p><strong>Next:</strong> Module 4 will teach you how to combine physical and mental skills into a personalized crisis plan.</p>
                    </div>
                </div>
                
                <div class="practice-section">
                    <button id="practiceBtn" class="practice-btn">
                        <span>‚úì</span>
                        <span>Mark Module as Practiced</span>
                    </button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn--secondary" onclick="previousStep()">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <a href="crisis-module-4.html" class="btn btn--primary">
                        <span>Module 4</span>
                        <span>‚Üí</span>
                    </a>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    // Initialize all interactive elements after render
    function initGrounding() {
        // Auto-save all grounding inputs
        const groundingFields = [
            'groundingSee1', 'groundingSee2', 'groundingSee3', 'groundingSee4', 'groundingSee5',
            'groundingTouch1', 'groundingTouch2', 'groundingTouch3', 'groundingTouch4'
        ];
        
        groundingFields.forEach((field, index) => {
            const input = document.getElementById(field);
            if (input) {
                input.addEventListener('input', function() {
                    if (!userData.groundingInputs) userData.groundingInputs = { see: [], touch: [] };
                    
                    if (field.includes('See')) {
                        const seeIndex = parseInt(field.replace('groundingSee', '')) - 1;
                        userData.groundingInputs.see[seeIndex] = this.value;
                    } else if (field.includes('Touch')) {
                        const touchIndex = parseInt(field.replace('groundingTouch', '')) - 1;
                        userData.groundingInputs.touch[touchIndex] = this.value;
                    }
                    
                    saveProgress();
                    
                    // Visual feedback
                    this.classList.add('saved');
                    setTimeout(() => this.classList.remove('saved'), 500);
                });
            }
        });
        
        const saveBtn = document.getElementById('saveGroundingBtn');
        const feedback = document.getElementById('groundingSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'grounding',
                    category: 'Module 3: Mental Techniques',
                    name: 'Grounding ‚Äî 5-4-3-2-1',
                    description: '2-5 minutes ‚Ä¢ Name 5 things you see, 4 touch, 3 hear, 2 smell, 1 taste'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                feedback.textContent = '‚úì Saved to your toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üëÅÔ∏è</span> Save Grounding to Toolkit';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initCognitive() {
        let currentNumber = 100;
        const numbers = [100, 93, 86, 79, 72];
        let currentIndex = 1; // Start at 93
        
        const display = document.getElementById('currentNumber');
        const input = document.getElementById('mathInput');
        const submitBtn = document.getElementById('mathSubmitBtn');
        const feedback = document.getElementById('mathFeedback');
        const resetBtn = document.getElementById('mathResetBtn');
        
        const beforeSlider = document.getElementById('cognitiveBeforeSlider');
        const beforeValue = document.getElementById('cognitiveBeforeValue');
        const afterSlider = document.getElementById('cognitiveAfterSlider');
        const afterValue = document.getElementById('cognitiveAfterValue');
        const saveRatings = document.getElementById('saveCognitiveRatings');
        
        // Update dots
        function updateDots() {
            for (let i = 0; i < numbers.length; i++) {
                const dot = document.getElementById(`dot${i+1}`);
                if (dot) {
                    if (i < currentIndex) {
                        dot.classList.add('completed');
                    } else {
                        dot.classList.remove('completed');
                    }
                }
            }
        }
        
        updateDots();
        
        if (submitBtn) {
            submitBtn.addEventListener('click', function() {
                const answer = parseInt(input.value);
                const correct = numbers[currentIndex];
                
                if (answer === correct) {
                    feedback.innerHTML = '<span class="math-correct">‚úì Correct! Great job.</span>';
                    currentIndex++;
                    
                    if (currentIndex < numbers.length) {
                        display.textContent = numbers[currentIndex - 1];
                    } else {
                        feedback.innerHTML = '<span class="math-correct">‚úì Complete! You did all 5 steps.</span>';
                        submitBtn.disabled = true;
                    }
                    
                    input.value = '';
                    updateDots();
                } else {
                    feedback.innerHTML = `<span class="math-incorrect">‚úó ${numbers[currentIndex-1]} - 7 = ${correct}</span>`;
                }
            });
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                currentIndex = 1;
                display.textContent = '100';
                input.value = '';
                feedback.innerHTML = '';
                submitBtn.disabled = false;
                updateDots();
            });
        }
        
        if (beforeSlider && beforeValue) {
            beforeSlider.addEventListener('input', () => {
                beforeValue.textContent = beforeSlider.value;
                userData.cognitiveBefore = parseInt(beforeSlider.value);
            });
        }
        
        if (afterSlider && afterValue) {
            afterSlider.addEventListener('input', () => {
                afterValue.textContent = afterSlider.value;
                userData.cognitiveAfter = parseInt(afterSlider.value);
            });
        }
        
        if (saveRatings) {
            saveRatings.addEventListener('click', function() {
                saveProgress();
                this.textContent = 'Saved! ‚úì';
                this.style.background = 'var(--success-bg)';
                this.style.color = 'var(--success-emerald)';
                
                setTimeout(() => {
                    this.textContent = 'Save Ratings';
                    this.style.background = '';
                    this.style.color = '';
                }, 2000);
            });
        }
        
        const saveBtn = document.getElementById('saveCognitiveBtn');
        const fb = document.getElementById('cognitiveSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'cognitive-load',
                    category: 'Module 3: Mental Techniques',
                    name: 'Cognitive Load',
                    description: 'Immediate ‚Ä¢ Count backwards by 7s, name animals alphabetically, recite lyrics backwards'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                fb.textContent = '‚úì Saved to your toolkit.';
                fb.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üß©</span> Save Cognitive Load to Toolkit';
                    fb.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initSensations() {
        const lemonBtn = document.getElementById('sensationLemonBtn');
        const iceBtn = document.getElementById('sensationIceBtn');
        const smellBtn = document.getElementById('sensationSmellBtn');
        const ratingDiv = document.getElementById('sensationRating');
        const doneBtn = document.getElementById('sensationDoneBtn');
        const resultDiv = document.getElementById('sensationResult');
        
        const beforeSlider = document.getElementById('sensationBeforeSlider');
        const beforeValue = document.getElementById('sensationBeforeValue');
        const afterSlider = document.getElementById('sensationAfterSlider');
        const afterValue = document.getElementById('sensationAfterValue');
        
        if (beforeSlider && beforeValue) {
            beforeSlider.addEventListener('input', () => {
                beforeValue.textContent = beforeSlider.value;
                userData.sensationBefore = parseInt(beforeSlider.value);
            });
        }
        
        if (afterSlider && afterValue) {
            afterSlider.addEventListener('input', () => {
                afterValue.textContent = afterSlider.value;
                userData.sensationAfter = parseInt(afterSlider.value);
            });
        }
        
        const showRating = () => {
            ratingDiv.style.display = 'block';
            saveProgress();
        };
        
        if (lemonBtn) lemonBtn.addEventListener('click', showRating);
        if (iceBtn) iceBtn.addEventListener('click', showRating);
        if (smellBtn) smellBtn.addEventListener('click', showRating);
        
        if (doneBtn) {
            doneBtn.addEventListener('click', function() {
                const before = parseInt(beforeSlider?.value || '5');
                const after = parseInt(afterSlider?.value || '3');
                resultDiv.style.display = 'block';
                
                if (after < before) {
                    resultDiv.innerHTML = `<p style="color: var(--text-teal-light);">You went from ${before} to ${after}. You're more present ‚Äî the sensation worked!</p>`;
                } else if (after > before) {
                    resultDiv.innerHTML = `<p style="color: var(--text-teal-light);">You went from ${before} to ${after}. That's okay ‚Äî different sensations work for different people.</p>`;
                } else {
                    resultDiv.innerHTML = `<p style="color: var(--text-teal-light);">You went from ${before} to ${after}. Try a different sensation next time.</p>`;
                }
                
                saveProgress();
            });
        }
        
        const saveBtn = document.getElementById('saveSensationsBtn');
        const fb = document.getElementById('sensationsSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'intense-sensations',
                    category: 'Module 3: Mental Techniques',
                    name: 'Intense Sensations (Safe)',
                    description: 'Immediate ‚Ä¢ Taste: lemon, hot sauce ‚Ä¢ Touch: ice cubes ‚Ä¢ Smell: peppermint ‚Ä¢ Sound: loud music'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                fb.textContent = '‚úì Saved to your toolkit.';
                fb.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üå∂Ô∏è</span> Save Intense Sensations to Toolkit';
                    fb.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initBilateral() {
        let timerInterval = null;
        let timeLeft = 120; // 2 minutes in seconds
        let isRunning = false;
        let side = 'left';
        
        const timerDisplay = document.getElementById('butterflyTimer');
        const sideDisplay = document.getElementById('butterflySide');
        const startBtn = document.getElementById('timerStartBtn');
        const pauseBtn = document.getElementById('timerPauseBtn');
        const resetBtn = document.getElementById('timerResetBtn');
        const timerStatus = document.getElementById('timerStatus');
        const afterDiv = document.getElementById('butterflyAfter');
        
        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            
            // Alternate sides every 2 seconds when running
            if (isRunning) {
                if (timeLeft % 2 === 0) {
                    side = side === 'left' ? 'right' : 'left';
                    sideDisplay.textContent = side.charAt(0).toUpperCase() + side.slice(1);
                    sideDisplay.style.color = side === 'left' ? 'var(--text-teal)' : 'var(--text-amber)';
                }
            }
        }
        
        function startTimer() {
            if (timeLeft <= 0) return;
            
            isRunning = true;
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            timerStatus.textContent = 'Timer running... tap alternating shoulders';
            timerDisplay.classList.add('timer-active');
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    stopTimer();
                    timerDisplay.textContent = '02:00';
                    sideDisplay.style.display = 'none';
                    afterDiv.style.display = 'block';
                    timerStatus.textContent = 'Complete! How do you feel?';
                    timerDisplay.classList.remove('timer-active');
                }
            }, 1000);
        }
        
        function stopTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            timerStatus.textContent = 'Paused';
            timerDisplay.classList.remove('timer-active');
        }
        
        function resetTimer() {
            stopTimer();
            timeLeft = 120;
            side = 'left';
            sideDisplay.style.display = 'block';
            sideDisplay.textContent = 'Left';
            sideDisplay.style.color = 'var(--text-teal)';
            afterDiv.style.display = 'none';
            updateDisplay();
            timerStatus.textContent = 'Ready to begin';
        }
        
        if (startBtn) {
            startBtn.addEventListener('click', startTimer);
        }
        
        if (pauseBtn) {
            pauseBtn.addEventListener('click', stopTimer);
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', resetTimer);
        }
        
        // Feedback buttons
        const calmBtn = document.getElementById('butterflyCalmBtn');
        const sameBtn = document.getElementById('butterflySameBtn');
        const anxiousBtn = document.getElementById('butterflyAnxiousBtn');
        
        if (calmBtn) {
            calmBtn.addEventListener('click', function() {
                timerStatus.textContent = 'Glad it helped! Remember this feeling.';
                setTimeout(() => resetTimer(), 2000);
            });
        }
        
        if (sameBtn) {
            sameBtn.addEventListener('click', function() {
                timerStatus.textContent = 'That\'s okay ‚Äî different techniques work for different people.';
                setTimeout(() => resetTimer(), 2000);
            });
        }
        
        if (anxiousBtn) {
            anxiousBtn.addEventListener('click', function() {
                timerStatus.textContent = 'Some people feel more anxious with bilateral. Try a different technique.';
                setTimeout(() => resetTimer(), 2000);
            });
        }
        
        const saveBtn = document.getElementById('saveBilateralBtn');
        const fb = document.getElementById('bilateralSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveToToolkit({
                    id: 'bilateral',
                    category: 'Module 3: Mental Techniques',
                    name: 'Bilateral Stimulation',
                    description: '2-5 minutes ‚Ä¢ Butterfly hug, eye movements, walking rhythm'
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                fb.textContent = '‚úì Saved to your toolkit.';
                fb.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>ü¶ã</span> Save Bilateral Stim to Toolkit';
                    fb.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initDistraction() {
        // Auto-save distraction inputs
        const distractionFields = [
            'distractionHigh1', 'distractionHigh2', 'distractionMed1', 'distractionMed2'
        ];
        
        distractionFields.forEach(field => {
            const input = document.getElementById(field);
            if (input) {
                if (!userData.distractionInputs) userData.distractionInputs = {};
                
                input.addEventListener('input', function() {
                    userData.distractionInputs[field] = this.value;
                    saveProgress();
                    
                    // Visual feedback
                    this.classList.add('saved');
                    setTimeout(() => this.classList.remove('saved'), 500);
                });
            }
        });
        
        const saveBtn = document.getElementById('saveDistractionBtn');
        const fb = document.getElementById('distractionSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                const high1 = document.getElementById('distractionHigh1')?.value || '';
                const high2 = document.getElementById('distractionHigh2')?.value || '';
                const med1 = document.getElementById('distractionMed1')?.value || '';
                const med2 = document.getElementById('distractionMed2')?.value || '';
                
                const description = `High engagement: ${high1}${high2 ? ', ' + high2 : ''}. Medium: ${med1}${med2 ? ', ' + med2 : ''}`;
                
                saveToToolkit({
                    id: 'distraction-plan',
                    category: 'Module 3: Mental Techniques',
                    name: 'My Distraction Plan',
                    description: description
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                fb.textContent = '‚úì Saved to your toolkit.';
                fb.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üìù</span> Save Distraction Plan to Toolkit';
                    fb.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initReflection() {
        const checkboxes = document.querySelectorAll('.reflection-checkbox input[type="checkbox"]');
        
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const label = this.closest('.reflection-checkbox');
                if (this.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
                
                // Update userData
                userData.selectedTechniques = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                saveProgress();
            });
        });
        
        const saveBtn = document.getElementById('saveReflectionBtn');
        const fb = document.getElementById('reflectionSaveFeedback');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (selected.length === 0) {
                    alert('Please select at least one technique.');
                    return;
                }
                
                saveToToolkit({
                    id: 'my-mental-techniques',
                    category: 'My Crisis Profile',
                    name: 'My Top Mental Techniques',
                    description: selected.join(', ')
                });
                
                saveToCrisisPlan('mentalTechniques', selected);
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span> Saved to Toolkit';
                fb.textContent = '‚úì Saved to your crisis plan.';
                fb.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üìã</span> Save My Top Techniques';
                    fb.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initComplete() {
        const practiceBtn = document.getElementById('practiceBtn');
        
        let progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        if (progress.practicedModules && progress.practicedModules.includes('module3')) {
            practiceBtn.classList.add('marked');
            practiceBtn.innerHTML = '<span>‚úì</span><span>Module 3 Practiced</span>';
        }
        
        if (practiceBtn) {
            practiceBtn.addEventListener('click', function() {
                if (!progress.practicedModules) {
                    progress.practicedModules = [];
                }
                
                if (!progress.practicedModules.includes('module3')) {
                    progress.practicedModules.push('module3');
                    progress.lastPracticed = new Date().toISOString();
                    localStorage.setItem('crisis_course_progress', JSON.stringify(progress));
                    
                    practiceBtn.classList.add('marked');
                    practiceBtn.innerHTML = '<span>‚úì</span><span>Module 3 Practiced</span>';
                }
            });
        }
    }
    
    // Main render function
    function render() {
        const content = document.getElementById('content');
        
        let html = '';
        switch(currentStep) {
            case 1: html = renderStep1(); break;
            case 2: html = renderStep2(); break;
            case 3: html = renderStep3(); break;
            case 4: html = renderStep4(); break;
            case 5: html = renderStep5(); break;
            case 6: html = renderStep6(); break;
            case 7: html = renderStep7(); break;
            case 8: html = renderStep8(); break;
            default: html = renderStep1();
        }
        
        content.innerHTML = html;
        
        // Initialize interactive elements based on current step
        setTimeout(() => {
            switch(currentStep) {
                case 2: initGrounding(); break;
                case 3: initCognitive(); break;
                case 4: initSensations(); break;
                case 5: initBilateral(); break;
                case 6: initDistraction(); break;
                case 7: initReflection(); break;
                case 8: initComplete(); break;
            }
        }, 100);
    }
    
    // Expose functions globally
    window.nextStep = nextStep;
    window.previousStep = previousStep;
    window.goToStep = goToStep;
    
    // Initialize
    loadProgress();
    render();
})();
</script>
</body>
</html>
