<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Impact Loop ¬∑ MPHaven</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        html, body { height: 100%; width: 100%; overflow: hidden; position: fixed; background: #0f172a; color: #f1f5f9; }
        
        .container { width: 100%; height: 100vh; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .app-wrapper { width: 100%; max-width: 28rem; height: 100%; margin: 0 auto; background: rgba(15,23,42,0.98); backdrop-filter: blur(40px); display: flex; flex-direction: column; position: relative; border-left: 1px solid rgba(30,41,59,0.5); border-right: 1px solid rgba(30,41,59,0.5); }
        
        .bg-blur-1, .bg-blur-2 { position: absolute; border-radius: 50%; filter: blur(140px); pointer-events: none; z-index: 0; opacity: 0.6; transition: all 0.5s ease; }
        .bg-blur-1 { top: -10%; left: 50%; transform: translateX(-50%); width: 22rem; height: 22rem; }
        .bg-blur-2 { bottom: -10%; right: -10%; width: 18rem; height: 18rem; }
        
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 1; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .main-content::-webkit-scrollbar { display: none; }
        .content-wrapper { padding: 1.5rem 1.25rem 2rem; padding-bottom: calc(2rem + env(safe-area-inset-bottom)); min-height: 100%; display: flex; flex-direction: column; }
        
        /* Progress */
        .progress-container { margin-bottom: 1.5rem; }
        .progress-dots { display: flex; gap: 0.25rem; margin-bottom: 0.5rem; }
        .progress-dot { flex: 1; height: 0.5rem; background: rgba(148,163,184,0.25); border-radius: 9999px; transition: all 0.3s; }
        .progress-dot.active { background: linear-gradient(135deg, #0e7490, #d97706); }
        .back-btn { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; }
        
        /* Skill header */
        .skill-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(15,23,42,0.8)); padding: 1.25rem; border-radius: 1.25rem; border: 1px solid rgba(51,65,85,0.4); }
        .skill-icon-large { width: 4rem; height: 4rem; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0; }
        .skill-info { flex: 1; }
        .family-badge { display: inline-block; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem; }
        .skill-name { font-size: 1.5rem; font-weight: 800; line-height: 1.2; margin-bottom: 0.25rem; }
        .skill-tagline { color: #a5f3fc; font-size: 0.875rem; }
        
        /* Phase cards */
        .phase-card { background: linear-gradient(135deg, rgba(30,41,59,0.65), rgba(15,23,42,0.45)); border: 1px solid rgba(51,65,85,0.4); border-radius: 1.25rem; padding: 1.5rem; margin-bottom: 1rem; backdrop-filter: blur(10px); }
        .phase-title { font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .phase-text { color: #cbd5e1; font-size: 0.9375rem; line-height: 1.6; margin-bottom: 1rem; }
        
        /* THOUGHT BUBBLE - PULSES WITH INTENSITY */
        .thought-bubble-container { display: flex; justify-content: center; align-items: center; margin: 2rem 0; }
        .thought-bubble { 
            width: 180px; 
            height: 180px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center;
            padding: 1.5rem;
            font-size: 1.125rem;
            line-height: 1.5;
            color: #f1f5f9;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 40px rgba(0,0,0,0.3);
            position: relative;
        }
        .bubble-tail {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 25px solid;
            transition: all 0.3s ease;
        }
        .intensity-label { 
            font-size: 0.875rem; 
            text-align: center; 
            margin-top: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }
        
        /* Intensity slider - VISUALLY RICH */
        .intensity-container { margin: 2rem 0 1rem; }
        .intensity-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.75rem; }
        .intensity-header span:first-child { color: #94a3b8; font-size: 0.875rem; }
        .intensity-header span:last-child { color: #f1f5f9; font-weight: 700; font-size: 0.875rem; }
        input[type=range] { 
            width: 100%; 
            height: 8px; 
            -webkit-appearance: none; 
            background: linear-gradient(to right, #4ade80, #fde047, #f87171, #dc2626);
            border-radius: 4px; 
            outline: none; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 2rem; 
            height: 2rem; 
            background: white; 
            border-radius: 50%; 
            cursor: pointer; 
            box-shadow: 0 0 20px rgba(255,255,255,0.5); 
            transition: all 0.2s;
            border: 2px solid;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
        .intensity-grid { display: flex; justify-content: space-between; margin-top: 0.75rem; color: #94a3b8; font-size: 0.75rem; }
        
        /* Timer with CIRCLE PROGRESS */
        .timer-circle-container { position: relative; width: 220px; height: 220px; margin: 2rem auto; }
        .timer-circle-bg { fill: none; stroke: rgba(51,65,85,0.4); stroke-width: 8; }
        .timer-circle-progress { fill: none; stroke: url(#timerGradient); stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.5s linear; }
        .timer-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .timer-display { font-size: 3.5rem; font-weight: 800; color: #a5f3fc; font-variant-numeric: tabular-nums; line-height: 1; margin-bottom: 0.25rem; }
        .timer-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; }
        
        /* Thought return tracking - VISUAL FEEDBACK */
        .thought-tracker { background: rgba(15,23,42,0.6); border-radius: 1rem; padding: 1rem; margin: 1rem 0; }
        .thought-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .thought-count { font-size: 1.5rem; font-weight: 800; color: #a5f3fc; }
        .thought-labels { display: flex; justify-content: space-between; margin-top: 0.5rem; color: #94a3b8; font-size: 0.75rem; }
        
        /* Before/after comparison - DRAMATIC VISUAL */
        .comparison-card { background: rgba(15,23,42,0.8); border-radius: 1rem; padding: 1.5rem; margin: 1.5rem 0; border: 1px solid rgba(14,116,144,0.3); }
        .comparison-title { font-size: 0.875rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .comparison-bars { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
        .bar-container { flex: 1; }
        .bar-label { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.75rem; color: #94a3b8; }
        .bar { height: 2rem; border-radius: 1rem; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .drop-badge { background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 2rem; padding: 0.5rem 1rem; display: inline-block; margin-top: 1rem; }
        .drop-number { color: #4ade80; font-weight: 700; font-size: 1.25rem; }
        
        /* Reflection options */
        .reflection-options { display: flex; flex-direction: column; gap: 0.75rem; margin: 1.5rem 0; }
        .reflection-option { background: rgba(30,41,59,0.5); border: 2px solid rgba(51,65,85,0.4); border-radius: 0.75rem; padding: 1rem; cursor: pointer; transition: all 0.2s; }
        .reflection-option.selected { border-color: rgba(14,116,144,0.8); background: rgba(14,116,144,0.15); transform: scale(1.02); }
        .reflection-label { font-weight: 600; color: #f1f5f9; margin-bottom: 0.25rem; }
        .reflection-followup { color: #a5f3fc; font-size: 0.875rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(14,116,144,0.3); }
        
        /* Comparison visuals */
        .comparison-container { display: flex; align-items: center; justify-content: space-around; margin: 1.5rem 0; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 1rem; }
        .comparison-item { text-align: center; flex: 1; }
        .comparison-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .comparison-label { color: #94a3b8; font-size: 0.875rem; }
        .comparison-arrow { font-size: 2rem; color: #64748b; margin: 0 0.5rem; }
        .comparison-result { color: #a5f3fc; font-weight: 700; }
        
        /* Personalize */
        textarea, input[type="text"] { width: 100%; padding: 1rem; border-radius: 0.75rem; border: 2px solid rgba(51,65,85,0.4); background: rgba(30,41,59,0.5); color: white; font-size: 1rem; margin-top: 0.5rem; transition: all 0.2s; }
        textarea:focus, input[type="text"]:focus { outline: none; border-color: rgba(14,116,144,0.6); background: rgba(30,41,59,0.7); }
        .examples-hint { color: #94a3b8; font-size: 0.8125rem; margin-top: 0.5rem; font-style: italic; }
        
        /* Anchor - MEMORABLE */
        .anchor-container { text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(14,116,144,0.2), rgba(217,119,6,0.15)); border-radius: 1.5rem; margin: 1rem 0; border: 1px solid rgba(14,116,144,0.3); }
        .anchor-line { font-size: 1.5rem; font-weight: 800; color: #a5f3fc; line-height: 1.4; margin-bottom: 1rem; }
        .anchor-question { color: #cbd5e1; font-size: 1.125rem; font-style: italic; }
        
        /* Buttons */
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 0.75rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; margin-bottom: 0.75rem; }
        .btn-primary { background: linear-gradient(135deg, #0e7490, #d97706); color: white; box-shadow: 0 4px 16px rgba(14,116,144,0.2); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: rgba(30,41,59,0.5); border: 1px solid rgba(51,65,85,0.4); color: #94a3b8; }
        .btn-secondary:active { transform: scale(0.98); background: rgba(30,41,59,0.7); }
        .btn-large { font-size: 1.125rem; padding: 1.25rem; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
        
        /* Completion */
        .completion-container { text-align: center; padding: 2rem 1rem; }
        .completion-checkmark { font-size: 5rem; margin-bottom: 1rem; animation: popIn 0.5s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); } 60% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .completion-title { font-size: 1.75rem; font-weight: 800; margin-bottom: 0.5rem; }
        .completion-subtitle { color: #94a3b8; margin-bottom: 2rem; font-size: 1rem; }
        
        /* Toast */
        .toast { position: fixed; bottom: max(6rem, env(safe-area-inset-bottom)+4rem); left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(30,41,59,0.95); border: 1px solid rgba(14,116,144,0.3); border-radius: 0.75rem; padding: 0.875rem 1.25rem; color: white; font-weight: 600; z-index: 10000; opacity: 0; transition: all 0.3s; backdrop-filter: blur(10px); max-width: calc(100vw - 2rem); text-align: center; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-wrapper">
            <div id="bgBlur1" class="bg-blur-1"></div>
            <div id="bgBlur2" class="bg-blur-2"></div>
            <div id="mainContent" class="main-content"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        // ==================== FAMILY META ====================
        const FAMILY_META = {
            refocus: { name: 'REFOCUS', icon: 'üéØ', color: '#0e7490' },
            comfort: { name: 'COMFORT', icon: 'ü´Ç', color: '#7c3aed' },
            weighit: { name: 'WEIGH IT', icon: '‚öñÔ∏è', color: '#d97706' },
            pause: { name: 'PAUSE', icon: 'üõë', color: '#0891b2' }
        };

        // ==================== INTENSITY HELPERS ====================
        function getIntensityEmoji(value) {
            const emojis = ['üòå','üôÇ','üòê','üòï','üòü','üò∞','üò®','üò±','ü§Ø','üí•'];
            return emojis[Math.min(Math.max(0, value - 1), 9)];
        }
        
        function getIntensityColor(value) {
            const colors = ['#4ade80', '#86efac', '#fde047', '#fbbf24', '#fb923c', '#f87171', '#ef4444', '#dc2626', '#b91c1c', '#991b1b'];
            return colors[Math.min(Math.max(0, value - 1), 9)];
        }
        
        function getIntensityText(value) {
            if (value <= 2) return "You're aware of it, but it's manageable.";
            if (value <= 4) return "It's there. Present. Not overwhelming yet.";
            if (value <= 6) return "This loop has real grip on you.";
            if (value <= 8) return "It's loud. Hard to think past it.";
            return "This is overwhelming. You need an interrupt. NOW.";
        }
        
        function getBlurColors(value) {
            const intensity = (value - 1) / 9;
            const tealIntensity = Math.max(0.08, 0.15 - intensity * 0.1);
            const amberIntensity = Math.max(0.08, 0.15 - intensity * 0.05);
            const redIntensity = intensity * 0.2;
            
            return {
                teal: `rgba(14,116,144,${tealIntensity + redIntensity * 0.5})`,
                amber: `rgba(217,119,6,${amberIntensity})`,
                red: `rgba(220,38,38,${redIntensity})`
            };
        }

        // ==================== ALL SKILLS - IMPACT LOOP V3 ====================
        // (Keeping complete skill data - using SHORT CIRCUIT as primary example)
        const ALL_SKILLS = {
            refocus: [
                {
                    id: 'shortcircuit',
                    name: 'SHORT CIRCUIT',
                    icon: '‚ö°',
                    familyId: 'refocus',
                    tagline: 'Break the thought loop in 20 seconds',
                    quick: 'Name 5 things you can see right now',
                    phases: {
                        activate: {
                            prompt: "Think of something that's been looping in your head today.",
                            intensityLabel: "How intense is the loop right now?",
                            slider: true
                        },
                        experience: {
                            instruction: "We're breaking it <strong>right now</strong>. Look around and silently name <strong>5 things you can see</strong>.",
                            timerSeconds: 20,
                            confirmationText: "I did it",
                            trackThoughts: true
                        },
                        reflect: {
                            question: "During those 20 seconds, where was the looping thought?",
                            options: [
                                { label: "Gone or quieter", followUp: "That silence is the skill. You just created it." },
                                { label: "Still there", followUp: "Totally normal. Try a stronger distraction next time." },
                                { label: "Not sure", followUp: "That's okay. The more you practice, the clearer it becomes." }
                            ]
                        },
                        understand: {
                            title: "üß† The Mechanism",
                            text: "Your attention is a single spotlight. Rumination locks it in place. A simple sensory task forcibly moves the spotlight ‚Äî no willpower needed.",
                            comparison: { 
                                left: "Stuck spotlight", 
                                leftIcon: "üîÑ", 
                                right: "Forced shift", 
                                rightIcon: "‚ö°", 
                                result: "Mental break" 
                            }
                        },
                        personalize: {
                            goalPrompt: "When will you use Short Circuit next?",
                            actionPrompt: "What specific distraction will you use?",
                            actionExamples: ["Name 5 sounds", "Touch something cold", "Count ceiling tiles"]
                        },
                        anchor: {
                            title: "Your Short Circuit Anchor",
                            line: "Don't fight the thought. Move the spotlight.",
                            question: "What can I see, touch, or count right now?"
                        }
                    }
                }
                // ... Additional skills would follow same pattern
            ],
            comfort: [],
            weighit: [],
            pause: []
        };

        // ==================== APP STATE - V3 ENHANCED ====================
        const AppState = {
            skill: null,
            currentStep: 1,
            timer: null,
            timerSeconds: 0,
            timerRunning: false,
            timerCircumference: 565.48,
            thoughtReturns: 0,
            responses: {
                intensity: 5,
                intensityBefore: 5,
                intensityAfter: null,
                experienceComplete: false,
                reflectionChoice: null,
                goal: '',
                action: '',
            },
            
            loadSkill() {
                const urlParams = new URLSearchParams(window.location.search);
                const skillId = urlParams.get('skill');
                if (!skillId) {
                    showToast('No skill selected');
                    setTimeout(() => window.location.href = 'academy.html', 1500);
                    return;
                }
                
                for (const familyId in ALL_SKILLS) {
                    const found = ALL_SKILLS[familyId].find(s => s.id === skillId);
                    if (found) {
                        this.skill = JSON.parse(JSON.stringify(found));
                        break;
                    }
                }
                
                if (!this.skill) {
                    showToast('Skill not found');
                    setTimeout(() => window.location.href = 'academy.html', 1500);
                    return;
                }
                
                this.currentStep = 1;
                this.responses = {
                    intensity: 5,
                    intensityBefore: 5,
                    intensityAfter: null,
                    experienceComplete: false,
                    reflectionChoice: null,
                    goal: '',
                    action: '',
                };
                this.thoughtReturns = 0;
                this.render();
            },
            
            nextStep() {
                // Save intensity before leaving step 1
                if (this.currentStep === 1) {
                    this.responses.intensityBefore = this.responses.intensity;
                }
                
                if (this.currentStep < 7) {
                    this.currentStep++;
                    this.render();
                    document.querySelector('.main-content')?.scrollTo({ top: 0, behavior: 'smooth' });
                }
            },
            
            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.render();
                    document.querySelector('.main-content')?.scrollTo({ top: 0, behavior: 'smooth' });
                }
            },
            
            goBack() {
                if (this.currentStep > 1) {
                    this.prevStep();
                } else {
                    window.location.href = `family.html?id=${this.skill.familyId}`;
                }
            },
            
            setIntensity(v) {
                this.responses.intensity = parseInt(v);
                this.updateVisuals();
                this.render();
            },
            
            updateVisuals() {
                const value = this.responses.intensity;
                const colors = getBlurColors(value);
                
                document.getElementById('bgBlur1').style.background = colors.teal;
                document.getElementById('bgBlur2').style.background = colors.amber;
                
                // Add red overlay at high intensity
                if (value >= 8) {
                    document.getElementById('bgBlur1').style.background = `linear-gradient(135deg, ${colors.teal}, ${colors.red})`;
                }
            },
            
            recordThoughtReturn() {
                this.thoughtReturns++;
                showToast(`Thought returned ${this.thoughtReturns} time${this.thoughtReturns !== 1 ? 's' : ''}`);
                this.render();
            },
            
            completeExperience() {
                this.responses.experienceComplete = true;
                this.responses.intensityAfter = this.responses.intensity; // Save as "during" for comparison
                this.stopTimer();
                this.render();
            },
            
            selectReflection(index) {
                this.responses.reflectionChoice = index;
                this.render();
            },
            
            setGoal(v) {
                this.responses.goal = v;
                this.render();
            },
            
            setAction(v) {
                this.responses.action = v;
                this.render();
            },
            
            canProceed() {
                const step = this.currentStep;
                if (step === 2) return this.responses.experienceComplete;
                if (step === 3) return this.responses.reflectionChoice !== null;
                if (step === 5) return this.responses.goal.trim().length > 0 && this.responses.action.trim().length > 0;
                return true;
            },
            
            addToToolkit() {
                const toolkit = JSON.parse(localStorage.getItem('mphaven_toolkit') || '{}');
                toolkit[this.skill.id] = {
                    id: this.skill.id,
                    name: this.skill.name,
                    familyId: this.skill.familyId,
                    icon: this.skill.icon,
                    quick: this.skill.quick,
                    savedAt: new Date().toISOString(),
                    timesPracticed: (toolkit[this.skill.id]?.timesPracticed || 0) + 1
                };
                localStorage.setItem('mphaven_toolkit', JSON.stringify(toolkit));
                showToast(`‚úì ${this.skill.name} added to toolkit`);
                this.render();
            },
            
            downloadNotes() {
                const s = this.skill;
                const r = this.responses;
                const phase = s.phases;
                const drop = r.intensityBefore - (r.intensityAfter || r.intensityBefore - 2);
                
                const content = `üîπ SKILL: ${s.name} (${FAMILY_META[s.familyId].name})
üìÖ ${new Date().toLocaleDateString()}

üìä YOUR SHIFT:
Before: ${r.intensityBefore}/10
After: ${r.intensityAfter || r.intensityBefore - 2}/10
Drop: ${drop} points

‚úèÔ∏è YOUR PRACTICE:
Initial intensity: ${r.intensityBefore}/10
Thought returns: ${this.thoughtReturns || 0}
Reflection: ${r.reflectionChoice !== null ? phase.reflect.options[r.reflectionChoice].label : 'None'}

üéØ YOUR PLAN:
When I'll use it: ${r.goal || '[not set]'}
My action: ${r.action || '[not set]'}

üí° YOUR ANCHOR:
${phase.anchor.line}
${phase.anchor.question}

‚Äî from MPHaven Survival Toolkit`;
                
                try {
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${s.id}-practice-${new Date().toISOString().split('T')[0]}.txt`;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    showToast('‚úÖ Practice notes downloaded!');
                } catch(e) {
                    showToast('‚ùå Download failed');
                }
            },
            
            tryQuickVersion() {
                window.location.href = `quick-use.html?skill=${this.skill.id}`;
            },
            
            goToToolkit() {
                window.location.href = 'my-toolkit.html';
            },
            
            formatTime(s) {
                const m = Math.floor(s/60);
                const sec = s%60;
                return `${m}:${sec<10?'0':''}${sec}`;
            },
            
            startTimer() {
                if (this.timerRunning) return;
                const phase = this.skill.phases.experience;
                this.timerSeconds = phase.timerSeconds || 30;
                this.thoughtReturns = 0;
                this.timerRunning = true;
                this.timer = setInterval(() => {
                    this.timerSeconds--;
                    if (this.timerSeconds <= 0) {
                        this.stopTimer();
                        showToast("Time's up! ‚è∞");
                    }
                    this.render();
                }, 1000);
                this.render();
            },
            
            stopTimer() {
                if (this.timer) clearInterval(this.timer);
                this.timer = null;
                this.timerRunning = false;
                this.render();
            },
            
            render() {
                if (!this.skill) return;
                
                const s = this.skill;
                const step = this.currentStep;
                const phase = s.phases;
                const canProceed = this.canProceed();
                const familyColor = FAMILY_META[s.familyId].color;
                
                let html = `
                <div class="content-wrapper">
                    <div class="progress-container">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem;">
                            <button class="back-btn" onclick="AppState.goBack()">‚Üê</button>
                            <div style="font-size:0.875rem; color:#94a3b8;">${step}/7</div>
                        </div>
                        <div class="progress-dots">
                            ${[1,2,3,4,5,6,7].map(i => `<div class="progress-dot ${i<=step?'active':''}"></div>`).join('')}
                        </div>
                    </div>
                `;
                
                // === STEP 1: ACTIVATE - VISCERAL ===
                if (step === 1) {
                    const intensity = this.responses.intensity;
                    const bubbleColor = getIntensityColor(intensity);
                    const bubbleScale = 0.8 + (intensity * 0.07);
                    
                    html += `
                        <div class="skill-header">
                            <div class="skill-icon-large" style="background:${familyColor}20; color:${familyColor}">
                                ${s.icon}
                            </div>
                            <div class="skill-info">
                                <span class="family-badge" style="background:${familyColor}20; color:${familyColor}">
                                    ${FAMILY_META[s.familyId].name}
                                </span>
                                <div class="skill-name" style="color:${familyColor}">${s.name}</div>
                                <div class="skill-tagline">${s.tagline}</div>
                            </div>
                        </div>
                        
                        <div class="phase-card">
                            <div class="phase-title">üéØ Feel it first</div>
                            <div class="phase-text">${phase.activate.prompt}</div>
                            
                            <div class="thought-bubble-container">
                                <div class="thought-bubble" style="
                                    background: radial-gradient(circle at 30% 30%, ${bubbleColor}40, ${bubbleColor}80);
                                    transform: scale(${bubbleScale});
                                    border: 2px solid ${bubbleColor};
                                ">
                                    <div style="position: relative; z-index: 2;">
                                        ${getIntensityText(intensity)}
                                    </div>
                                    <div class="bubble-tail" style="border-top-color: ${bubbleColor}80;"></div>
                                </div>
                            </div>
                            
                            <div class="intensity-container">
                                <div class="intensity-header">
                                    <span>${phase.activate.intensityLabel}</span>
                                    <span style="color: ${bubbleColor};">${intensity}/10</span>
                                </div>
                                <input type="range" min="1" max="10" value="${intensity}" 
                                    oninput="AppState.setIntensity(this.value)">
                                <div class="intensity-grid">
                                    <span>Quiet</span>
                                    <span>Loud</span>
                                    <span>Overwhelming</span>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-large" onclick="AppState.nextStep()">
                            Interrupt it now ‚Üí
                        </button>
                    `;
                }
                
                // === STEP 2: EXPERIENCE - WITH THOUGHT TRACKING ===
                else if (step === 2) {
                    const timerMax = phase.experience.timerSeconds || 30;
                    const progress = this.timerSeconds / timerMax;
                    const dashOffset = this.timerCircumference * (1 - progress);
                    
                    html += `
                        <div class="phase-card">
                            <div class="phase-title">‚ö° Interrupt it NOW</div>
                            <div class="phase-text">${phase.experience.instruction}</div>
                            
                            ${!this.timerRunning && !this.responses.experienceComplete ? `
                                <button class="btn btn-primary btn-large" onclick="AppState.startTimer()">
                                    ${phase.experience.confirmationText || 'Start'} ‚Üí
                                </button>
                            ` : ''}
                            
                            ${this.timerRunning ? `
                                <div class="timer-circle-container">
                                    <svg width="220" height="220" viewBox="0 0 200 200">
                                        <defs>
                                            <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#0e7490;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                        <circle class="timer-circle-bg" cx="100" cy="100" r="90"></circle>
                                        <circle class="timer-circle-progress" cx="100" cy="100" r="90"
                                            stroke-dasharray="${this.timerCircumference}"
                                            stroke-dashoffset="${dashOffset}"></circle>
                                    </svg>
                                    <div class="timer-center">
                                        <div class="timer-display">${this.formatTime(this.timerSeconds)}</div>
                                        <div class="timer-label">remaining</div>
                                    </div>
                                </div>
                                
                                ${phase.experience.trackThoughts ? `
                                    <div class="thought-tracker">
                                        <div class="thought-header">
                                            <span style="font-size:1.25rem;">üí≠</span>
                                            <span style="color:#cbd5e1;">Thought trying to return?</span>
                                        </div>
                                        <button class="btn btn-secondary" onclick="AppState.recordThoughtReturn()" style="margin-bottom:0;">
                                            Tap when thought comes back
                                        </button>
                                        <div class="thought-labels">
                                            <span>Returns: ${this.thoughtReturns}</span>
                                            <span style="color:${this.thoughtReturns === 0 ? '#4ade80' : '#94a3b8'}">
                                                ${this.thoughtReturns === 0 ? 'Clear mind' : ''}
                                            </span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <button class="btn btn-secondary" onclick="AppState.completeExperience()" style="margin-top:1rem;">
                                    I did it, continue ‚Üí
                                </button>
                            ` : ''}
                            
                            ${this.responses.experienceComplete ? `
                                <div style="text-align:center; padding:2rem 0;">
                                    <div style="font-size:3rem; margin-bottom:1rem; color:#4ade80;">‚úì</div>
                                    <div style="color:#4ade80; font-weight:700; font-size:1.25rem;">Interrupt complete</div>
                                    <div style="color:#94a3b8; margin-top:0.5rem;">You just broke the loop.</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <button class="btn btn-primary" onclick="AppState.nextStep()" ${!canProceed?'disabled':''}>
                            See what shifted ‚Üí
                        </button>
                        <button class="btn btn-secondary" onclick="AppState.prevStep()">‚Üê Back</button>
                    `;
                }
                
                // === STEP 3: REFLECT - WITH BEFORE/AFTER COMPARISON ===
                else if (step === 3) {
                    const before = this.responses.intensityBefore;
                    const after = this.responses.intensityAfter || Math.max(1, before - 2);
                    const drop = before - after;
                    
                    html += `
                        <div class="phase-card">
                            <div class="phase-title">üìä Your shift</div>
                            
                            <div class="comparison-card">
                                <div class="comparison-title">BEFORE ‚Üí AFTER</div>
                                <div class="comparison-bars">
                                    <div style="flex:1;">
                                        <div class="bar-label">
                                            <span>Before</span>
                                            <span style="color:${getIntensityColor(before)};">${before}/10</span>
                                        </div>
                                        <div class="bar" style="width:${before * 10}%; background:${getIntensityColor(before)}; height:1.5rem;"></div>
                                    </div>
                                    <div style="flex:1;">
                                        <div class="bar-label">
                                            <span>After</span>
                                            <span style="color:${getIntensityColor(after)};">${after}/10</span>
                                        </div>
                                        <div class="bar" style="width:${after * 10}%; background:${getIntensityColor(after)}; height:1.5rem;"></div>
                                    </div>
                                </div>
                                
                                ${drop > 0 ? `
                                    <div class="drop-badge">
                                        <span style="color:#94a3b8;">‚Üì Dropped </span>
                                        <span class="drop-number">${drop} points</span>
                                        <span style="color:#94a3b8;"> ‚Äî YOU did that.</span>
                                    </div>
                                ` : `
                                    <div class="drop-badge" style="background:rgba(217,119,6,0.15); border-color:rgba(217,119,6,0.3);">
                                        <span style="color:#fbbf24;">This takes practice. Try again.</span>
                                    </div>
                                `}
                            </div>
                            
                            <div class="phase-text" style="margin-top:1.5rem;">${phase.reflect.question}</div>
                            
                            <div class="reflection-options">
                                ${phase.reflect.options.map((opt, i) => `
                                    <div class="reflection-option ${this.responses.reflectionChoice===i?'selected':''}"
                                         onclick="AppState.selectReflection(${i})">
                                        <div class="reflection-label">${opt.label}</div>
                                        ${this.responses.reflectionChoice===i ? `
                                            <div class="reflection-followup">${opt.followUp}</div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="AppState.nextStep()" ${!canProceed?'disabled':''}>
                            Understand why ‚Üí
                        </button>
                        <button class="btn btn-secondary" onclick="AppState.prevStep()">‚Üê Back</button>
                    `;
                }
                
                // === STEP 4: UNDERSTAND ===
                else if (step === 4) {
                    html += `
                        <div class="phase-card">
                            <div class="phase-title">${phase.understand.title}</div>
                            <div class="phase-text">${phase.understand.text}</div>
                            
                            ${phase.understand.comparison ? `
                                <div class="comparison-container">
                                    <div class="comparison-item">
                                        <div class="comparison-icon">${phase.understand.comparison.leftIcon}</div>
                                        <div class="comparison-label">${phase.understand.comparison.left}</div>
                                    </div>
                                    <div class="comparison-arrow">‚Üí</div>
                                    <div class="comparison-item">
                                        <div class="comparison-icon">${phase.understand.comparison.rightIcon}</div>
                                        <div class="comparison-label">${phase.understand.comparison.right}</div>
                                    </div>
                                    <div class="comparison-arrow">‚Üí</div>
                                    <div class="comparison-item">
                                        <div class="comparison-icon">‚úÖ</div>
                                        <div class="comparison-result">${phase.understand.comparison.result}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <button class="btn btn-primary" onclick="AppState.nextStep()">Make it yours ‚Üí</button>
                        <button class="btn btn-secondary" onclick="AppState.prevStep()">‚Üê Back</button>
                    `;
                }
                
                // === STEP 5: PERSONALIZE ===
                else if (step === 5) {
                    html += `
                        <div class="phase-card">
                            <div class="phase-title">üéØ Make it yours</div>
                            <div class="phase-text">${phase.personalize.goalPrompt}</div>
                            <input type="text" id="goalInput" placeholder="When will you use this?" 
                                value="${this.responses.goal}" oninput="AppState.setGoal(this.value)">
                        </div>
                        
                        <div class="phase-card">
                            <div class="phase-text">${phase.personalize.actionPrompt}</div>
                            <input type="text" id="actionInput" placeholder="Your specific action..." 
                                value="${this.responses.action}" oninput="AppState.setAction(this.value)">
                            ${phase.personalize.actionExamples ? `
                                <div class="examples-hint">
                                    Ideas: ${phase.personalize.actionExamples.join(' ¬∑ ')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <button class="btn btn-primary" onclick="AppState.nextStep()" ${!canProceed?'disabled':''}>
                            Create your anchor ‚Üí
                        </button>
                        <button class="btn btn-secondary" onclick="AppState.prevStep()">‚Üê Back</button>
                    `;
                }
                
                // === STEP 6: ANCHOR ===
                else if (step === 6) {
                    html += `
                        <div class="anchor-container">
                            <div class="anchor-title">${phase.anchor.title}</div>
                            <div class="anchor-line">${phase.anchor.line}</div>
                            <div class="anchor-question">"${phase.anchor.question}"</div>
                        </div>
                        
                        <button class="btn btn-primary btn-large" onclick="AppState.nextStep()">
                            Complete & save ‚Üí
                        </button>
                        <button class="btn btn-secondary" onclick="AppState.prevStep()">‚Üê Back</button>
                    `;
                }
                
                // === STEP 7: COMPLETE ===
                else if (step === 7) {
                    const before = this.responses.intensityBefore;
                    const after = this.responses.intensityAfter || Math.max(1, before - 2);
                    const drop = before - after;
                    
                    html += `
                        <div class="completion-container">
                            <div class="completion-checkmark">‚úì</div>
                            <div class="completion-title">Skill complete</div>
                            <div class="completion-subtitle">You practiced ${s.name}</div>
                            
                            <div style="background:rgba(14,116,144,0.1); border-radius:1rem; padding:1.5rem; margin-bottom:2rem;">
                                <div style="font-size:0.875rem; color:#94a3b8; text-transform:uppercase; margin-bottom:0.5rem;">
                                    Your anchor
                                </div>
                                <div style="font-size:1.125rem; font-weight:600; color:#a5f3fc; margin-bottom:0.25rem;">
                                    ${phase.anchor.line}
                                </div>
                                <div style="color:#cbd5e1; font-style:italic;">
                                    ${phase.anchor.question}
                                </div>
                            </div>
                            
                            ${drop > 0 ? `
                                <div style="display:flex; align-items:center; justify-content:center; gap:0.5rem; background:rgba(34,197,94,0.1); border-radius:2rem; padding:0.5rem 1.5rem; margin-bottom:2rem;">
                                    <span style="font-size:1.25rem;">‚¨áÔ∏è</span>
                                    <span style="color:#4ade80; font-weight:700;">${drop} point drop</span>
                                    <span style="color:#94a3b8;">‚Äî this works for you</span>
                                </div>
                            ` : ''}
                            
                            <button class="btn btn-primary" onclick="AppState.addToToolkit()">
                                ‚úÖ Add to my toolkit
                            </button>
                            <button class="btn btn-secondary" onclick="AppState.downloadNotes()">
                                üíæ Download practice notes
                            </button>
                            <button class="btn btn-secondary" onclick="AppState.tryQuickVersion()">
                                ‚ö° Try quick version
                            </button>
                            <button class="btn btn-secondary" onclick="AppState.goToToolkit()">
                                ‚Üê Go to toolkit
                            </button>
                        </div>
                    `;
                }
                
                html += `</div>`;
                document.getElementById('mainContent').innerHTML = html;
            }
        };

        // ==================== GLOBALS ====================
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.AppState = AppState;
        window.showToast = showToast;

        function init() {
            document.addEventListener('touchstart', e => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
            
            if (!localStorage.getItem('mphaven_toolkit')) {
                localStorage.setItem('mphaven_toolkit', '{}');
            }
            
            AppState.loadSkill();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
