<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Module 1: Why Your Brain Goes Haywire</title>
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: rgba(15, 23, 42, 0.98);
    --bg-card-light: rgba(30, 41, 59, 0.65);
    --bg-card-dark: rgba(15, 23, 42, 0.45);
    --border-subtle: rgba(30, 41, 59, 0.5);
    --border-softer: rgba(51, 65, 85, 0.4);
    --primary-teal: #0e7490;
    --primary-teal-dark: #0c627a;
    --accent-amber: #d97706;
    --text-primary: rgb(241, 245, 249);
    --text-secondary: rgb(203, 213, 225);
    --text-muted: rgb(148, 163, 184);
    --text-teal: rgb(94, 234, 212);
    --text-amber: rgb(251, 191, 36);
    --success-emerald: rgb(74, 222, 128);
    --success-bg: rgba(34, 197, 94, 0.12);
    --crisis-red: #dc2626;
    --crisis-bg: rgba(220, 38, 38, 0.08);
    --gradient-main: linear-gradient(135deg, #0e7490, #d97706);
    --gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg-dark);
    color: var(--text-primary);
}

.container {
    width: 100%;
    height: 100vh;
    height: -webkit-fill-available;
    display: flex;
    flex-direction: column;
}

.app-wrapper {
    width: 100%;
    max-width: 28rem;
    height: 100%;
    margin: 0 auto;
    background: var(--bg-card);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.bg-blur-1, .bg-blur-2 {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.3;
}

.bg-blur-1 {
    top: -5%;
    left: 50%;
    transform: translateX(-50%);
    width: 22rem;
    height: 22rem;
    background: rgba(14, 116, 144, 0.15);
}

.bg-blur-2 {
    bottom: -5%;
    right: -5%;
    width: 18rem;
    height: 18rem;
    background: rgba(217, 119, 6, 0.15);
}

.main-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    position: relative;
    z-index: 1;
}

.main-content::-webkit-scrollbar {
    display: none;
}

.content-wrapper {
    padding: 1.25rem;
    padding-bottom: calc(2rem + env(safe-area-inset-bottom));
    min-height: 100%;
    display: flex;
    flex-direction: column;
}

/* Crisis Banner - Only on first page */
.crisis-banner {
    background: var(--crisis-bg);
    border: 1px solid var(--crisis-red);
    border-radius: 0.875rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.crisis-banner__text {
    color: #fca5a5;
    font-size: 0.875rem;
    font-weight: 600;
    flex: 1;
    min-width: 180px;
}

.crisis-banner__actions {
    display: flex;
    gap: 0.625rem;
}

.crisis-banner__link {
    color: white;
    background: var(--crisis-red);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-size: 0.8125rem;
    font-weight: 700;
    transition: all 0.2s;
}

.crisis-banner__link:active {
    background: #b91c1c;
    transform: scale(0.97);
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
}

.header__top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.back-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    transition: all 0.2s;
}

.back-btn:active {
    transform: scale(0.9);
}

.step-indicator {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 600;
}

.progress-dots {
    display: flex;
    gap: 0.375rem;
    margin-bottom: 1rem;
}

.progress-dot {
    flex: 1;
    height: 0.5rem;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 1rem;
    transition: all 0.3s;
}

.progress-dot.active {
    background: var(--gradient-main);
}

.step-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: var(--gradient-main);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.step-subtitle {
    color: var(--text-secondary);
    font-size: 0.9375rem;
}

/* Card */
.card {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1.25rem;
    padding: 1.75rem 1.5rem;
    margin-bottom: 1.25rem;
}

.card--highlight {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14, 116, 144, 0.3);
}

.card--celebration {
    background: linear-gradient(135deg, rgba(14,116,144,0.2), rgba(217,119,6,0.15));
    border-color: rgba(94,234,212,0.3);
    text-align: center;
}

.card__icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 1rem;
    line-height: 1;
}

.card__title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.25rem;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 0.625rem;
}

.card__content {
    color: var(--text-secondary);
    line-height: 1.7;
    font-size: 1rem;
}

.card__content p {
    margin-bottom: 1.25rem;
}

.card__content p:last-child {
    margin-bottom: 0;
}

.card__content strong {
    color: var(--text-primary);
    font-weight: 600;
}

.card__content ol {
    margin: 1.25rem 0;
    padding-left: 1.5rem;
}

.card__content ol li {
    margin-bottom: 1rem;
    padding-left: 0.5rem;
}

.card__content ol li:last-child {
    margin-bottom: 0;
}

.card__content ul {
    margin: 1rem 0 1rem 1.5rem;
    color: var(--text-secondary);
}

.card__content ul li {
    margin-bottom: 0.5rem;
}

/* Callout */
.callout {
    background: var(--crisis-bg);
    border-left: 4px solid var(--crisis-red);
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin: 1.5rem 0;
}

.callout p {
    color: var(--text-secondary);
    line-height: 1.6;
}

.callout strong {
    color: var(--text-primary);
    font-weight: 700;
}

/* Interactive Brain */
.brain-container {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 1rem;
    padding: 1.75rem;
    text-align: center;
}

.brain-svg {
    width: 100%;
    max-width: 260px;
    height: auto;
    margin: 0 auto 1.5rem;
    display: block;
}

.brain-btn {
    background: var(--crisis-red);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 2rem;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    margin: 1.25rem 0;
    transition: all 0.2s;
    width: 100%;
    max-width: 280px;
    position: relative;
}

/* Pulsing hint animation */
@keyframes pulse-hint {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
    50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
}

.brain-btn.pulse {
    animation: pulse-hint 2s infinite;
}

.brain-btn:active {
    background: #b91c1c;
    transform: scale(0.98);
}

.brain-btn.active {
    background: var(--primary-teal);
    animation: none;
}

.btn-hint {
    display: block;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin-top: 0.5rem;
    font-style: italic;
}

.brain-states {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-softer);
}

.brain-state {
    text-align: center;
}

.brain-state__name {
    font-weight: 700;
    font-size: 0.9375rem;
    margin-bottom: 0.375rem;
}

.brain-state__desc {
    color: var(--text-muted);
    font-size: 0.8125rem;
}

.action-urges {
    display: none;
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: var(--bg-card-dark);
    border-radius: 1rem;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.action-urges.show {
    display: block;
}

.action-urges__title {
    color: #fca5a5;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 1rem;
    text-align: center;
}

.action-urges__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.urge-badge {
    background: rgba(220, 38, 38, 0.15);
    color: #fca5a5;
    border: 1px solid var(--crisis-red);
    padding: 0.75rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    text-align: center;
}

/* Wave Container */
.wave-container {
    background: rgba(15, 23, 42, 0.6);
    border-radius: 1rem;
    padding: 1.75rem;
}

.wave-svg {
    width: 100%;
    max-width: 100%;
    height: auto;
    margin-bottom: 1.25rem;
}

.wave-legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    flex-wrap: wrap;
}

.scenario-question {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1rem;
}

.scenario-btns {
    display: grid;
    gap: 0.875rem;
    margin-bottom: 1.25rem;
}

.scenario-btn {
    padding: 1rem 1.25rem;
    border-radius: 0.875rem;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    border: 2px solid;
    transition: all 0.2s;
    text-align: left;
    position: relative;
}

.scenario-btn.pulse {
    animation: pulse-hint 2s infinite;
}

.scenario-btn--red {
    background: rgba(220, 38, 38, 0.12);
    color: #fca5a5;
    border-color: var(--crisis-red);
}

.scenario-btn--red:active {
    background: rgba(220, 38, 38, 0.2);
    transform: scale(0.98);
}

.scenario-btn--red.pulse {
    animation: pulse-hint 2s infinite;
}

.scenario-btn--green {
    background: rgba(14, 116, 144, 0.12);
    color: var(--text-teal);
    border-color: var(--primary-teal);
}

.scenario-btn--green:active {
    background: rgba(14, 116, 144, 0.2);
    transform: scale(0.98);
}

.scenario-btn--green.pulse {
    animation: pulse-hint 2s infinite;
}

.scenario-feedback {
    padding: 1.25rem;
    background: var(--bg-card-dark);
    border-radius: 0.875rem;
    font-size: 0.9375rem;
    line-height: 1.6;
    min-height: 70px;
}

/* Checkbox Grid */
.checkbox-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.875rem;
    margin: 1.5rem 0;
}

.checkbox-item {
    position: relative;
}

.checkbox-item input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 1;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 1rem 1.25rem;
    background: rgba(30, 41, 59, 0.5);
    border: 2px solid var(--border-softer);
    border-radius: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
    color: var(--text-secondary);
}

.checkbox-item input[type="checkbox"]:checked + .checkbox-label {
    background: rgba(14, 116, 144, 0.15);
    border-color: var(--primary-teal);
    color: var(--text-primary);
}

.checkbox-visual {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border-softer);
    border-radius: 6px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card-dark);
    transition: all 0.2s;
}

.checkbox-item input[type="checkbox"]:checked + .checkbox-label .checkbox-visual {
    background: var(--primary-teal);
    border-color: var(--primary-teal);
}

.checkbox-visual::after {
    content: '‚úì';
    color: white;
    font-weight: 700;
    font-size: 14px;
    opacity: 0;
    transform: scale(0);
    transition: all 0.15s;
}

.checkbox-item input[type="checkbox"]:checked + .checkbox-label .checkbox-visual::after {
    opacity: 1;
    transform: scale(1);
}

/* Window Zones */
.zone-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.zone {
    padding: 1.5rem;
    border-radius: 0.875rem;
    border-left: 4px solid;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.zone.pulse {
    animation: pulse-hint 2s infinite;
}

.zone:active {
    transform: translateX(4px);
}

.zone--hyper {
    background: rgba(220, 38, 38, 0.08);
    border-left-color: var(--crisis-red);
}

.zone--hyper.pulse {
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
}

.zone--optimal {
    background: rgba(14, 116, 144, 0.12);
    border-left-color: var(--primary-teal);
}

.zone--optimal.pulse {
    box-shadow: 0 0 0 0 rgba(14, 116, 144, 0.7);
}

.zone--hypo {
    background: rgba(100, 116, 139, 0.12);
    border-left-color: var(--text-muted);
}

.zone--hypo.pulse {
    box-shadow: 0 0 0 0 rgba(100, 116, 139, 0.7);
}

.zone__title {
    font-weight: 700;
    font-size: 1.0625rem;
    margin-bottom: 0.625rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.zone__desc {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
}

.zone-feedback {
    margin-top: 1.25rem;
    padding: 1.25rem;
    background: var(--bg-card-dark);
    border-radius: 0.875rem;
    font-size: 0.9375rem;
    line-height: 1.6;
    min-height: 80px;
}

.interaction-hint {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
    margin-top: 1rem;
    font-style: italic;
}

/* Quiz */
.quiz-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.quiz-item {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid var(--border-softer);
    border-radius: 0.875rem;
    padding: 1.5rem;
}

.quiz-question {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1rem;
}

.quiz-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.quiz-option {
    position: relative;
}

.quiz-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 1;
}

.quiz-option-label {
    display: flex;
    align-items: flex-start;
    gap: 0.875rem;
    padding: 1rem;
    background: var(--bg-card-dark);
    border: 2px solid var(--border-softer);
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
}

.quiz-option input[type="radio"]:checked + .quiz-option-label {
    border-color: var(--primary-teal);
    background: rgba(14, 116, 144, 0.12);
}

.quiz-option.correct .quiz-option-label {
    border-color: var(--success-emerald);
    background: var(--success-bg);
}

.quiz-option.incorrect .quiz-option-label {
    border-color: var(--crisis-red);
    background: var(--crisis-bg);
}

.quiz-radio {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-softer);
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    margin-top: 2px;
}

.quiz-option input[type="radio"]:checked + .quiz-option-label .quiz-radio {
    border-color: var(--primary-teal);
}

.quiz-radio::after {
    content: '';
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--primary-teal);
    opacity: 0;
    transform: scale(0);
    transition: all 0.15s;
}

.quiz-option input[type="radio"]:checked + .quiz-option-label .quiz-radio::after {
    opacity: 1;
    transform: scale(1);
}

.quiz-feedback {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    display: none;
}

.quiz-feedback.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

.quiz-feedback.correct {
    background: var(--success-bg);
    color: var(--success-emerald);
    border: 1px solid rgba(74, 222, 128, 0.3);
}

.quiz-feedback.incorrect {
    background: var(--crisis-bg);
    color: #fca5a5;
    border: 1px solid rgba(220, 38, 38, 0.3);
}

/* Summary */
.summary-card {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14, 116, 144, 0.3);
    border-radius: 1.25rem;
    padding: 2rem 1.75rem;
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.summary-icon {
    font-size: 1.75rem;
}

.summary-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: rgb(165, 243, 252);
}

.summary-list {
    list-style: none;
    margin-bottom: 1.75rem;
}

.summary-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.875rem;
    margin-bottom: 1rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
}

.summary-list li::before {
    content: '‚Ä¢';
    color: var(--text-teal);
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
}

/* Buttons */
.btn {
    width: 100%;
    padding: 1.125rem 1.5rem;
    border-radius: 1rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    text-decoration: none;
}

.btn--primary {
    background: var(--gradient-main);
    color: white;
}

.btn--primary:active {
    transform: scale(0.98);
    opacity: 0.9;
}

.btn--save {
    background: var(--gradient-subtle);
    color: rgb(165, 243, 252);
    border: 1px solid rgba(14, 116, 144, 0.3);
}

.btn--save:active {
    background: rgba(14, 116, 144, 0.2);
}

.btn--save.saved {
    background: var(--success-bg);
    color: var(--success-emerald);
    border-color: rgba(74, 222, 128, 0.3);
}

.btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

.btn--secondary {
    background: rgba(30, 41, 59, 0.6);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn--secondary:active {
    background: rgba(30, 41, 59, 0.8);
    transform: scale(0.98);
}

.save-feedback {
    color: var(--success-emerald);
    font-size: 0.875rem;
    text-align: center;
    margin-top: 0.875rem;
    display: none;
}

.save-feedback.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

/* Practice Button */
.practice-section {
    text-align: center;
    margin: 1.25rem 0;
}

.practice-btn {
    background: var(--success-bg);
    color: var(--success-emerald);
    border: 1px solid rgba(74, 222, 128, 0.3);
    padding: 0.875rem 2rem;
    border-radius: 2rem;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
}

.practice-btn:active {
    background: rgba(34, 197, 94, 0.2);
    transform: scale(0.97);
}

.practice-btn.marked {
    background: rgba(34, 197, 94, 0.25);
}

/* Completion Stats */
.completion-stats {
    display: flex;
    justify-content: space-around;
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-teal);
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
}

/* Footer */
.footer {
    margin-top: auto;
    padding-top: 2rem;
    border-top: 1px solid var(--border-subtle);
    text-align: center;
}

.footer__warning {
    color: #fca5a5;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.footer__resources {
    color: var(--text-muted);
    font-size: 0.8125rem;
    line-height: 1.8;
}

.footer__resources p {
    margin-bottom: 0.5rem;
}

.footer__link {
    color: var(--text-muted);
    text-decoration: underline;
    cursor: pointer;
}

.footer__link:active {
    color: var(--text-secondary);
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.step-content {
    animation: fadeIn 0.3s ease-out;
}

/* Mobile Adjustments */
@media (max-width: 640px) {
    .btn-group {
        grid-template-columns: 1fr;
    }
    
    .brain-states {
        grid-template-columns: 1fr;
    }
    
    .action-urges__grid {
        grid-template-columns: 1fr;
    }
}

/* iOS Safe Area */
@supports (-webkit-touch-callout: none) {
    .container {
        height: -webkit-fill-available;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="app-wrapper">
        <div class="bg-blur-1"></div>
        <div class="bg-blur-2"></div>
        <div class="main-content" id="mainContent">
            <div class="content-wrapper" id="content">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // CONFIGURATION
    const COURSE_HUB_URL = 'crisis-intro.html';
    const MODULE_2_URL = 'crisis-module-2.html'; // Make sure this matches your actual Module 2 filename
    
    // State
    let currentStep = 1;
    const totalSteps = 8;
    let userData = {
        actionUrges: [],
        windowZone: null,
        quizAnswers: {}
    };
    
    // Titles for each step
    const stepTitles = {
        1: 'Section 1.1: The Alarm System',
        2: 'Section 1.1: The Alarm System',
        3: 'Section 1.2: The Emotional Wave',
        4: 'Reflection: Your Action Urges',
        5: 'Section 1.3: Window of Tolerance',
        6: 'Section 1.4: Quick Check',
        7: 'Crisis Brain Facts',
        8: 'Module Complete!'
    };
    
    // Storage helpers
    function saveProgress() {
        try {
            const data = {
                step: currentStep,
                userData: userData,
                timestamp: Date.now()
            };
            localStorage.setItem('crisis_module1_progress', JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Save failed:', e);
            return false;
        }
    }
    
    function loadProgress() {
        try {
            const saved = localStorage.getItem('crisis_module1_progress');
            if (saved) {
                const data = JSON.parse(saved);
                if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                    currentStep = data.step;
                    userData = data.userData;
                    return true;
                }
            }
        } catch (e) {
            console.error('Load failed:', e);
        }
        return false;
    }
    
    function saveToCrisisPlan(key, value) {
        try {
            let plan = JSON.parse(localStorage.getItem('crisis_plan') || '{}');
            plan[key] = value;
            plan.lastUpdated = new Date().toISOString();
            localStorage.setItem('crisis_plan', JSON.stringify(plan));
            return true;
        } catch (e) {
            console.error('Save to crisis plan failed:', e);
            return false;
        }
    }
    
    function saveToToolkit(item) {
        try {
            let toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
            toolkit = toolkit.filter(t => t.id !== item.id);
            toolkit.push({
                ...item,
                date: new Date().toISOString()
            });
            localStorage.setItem('crisis_toolkit', JSON.stringify(toolkit));
            return true;
        } catch (e) {
            console.error('Save to toolkit failed:', e);
            return false;
        }
    }
    
    // Navigation with proper scroll
    function scrollToTop() {
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }
    
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;
        currentStep = step;
        saveProgress();
        render();
        scrollToTop();
    }
    
    function nextStep() {
        if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            goToStep(currentStep - 1);
        } else {
            // Go back to course hub when on first step
            window.location.href = COURSE_HUB_URL;
        }
    }
    
    // Render functions
    function renderHeader(showCrisis = false) {
        return `
            ${showCrisis ? `
            <div class="crisis-banner">
                <span class="crisis-banner__text">üö® In crisis? Help is available 24/7</span>
                <div class="crisis-banner__actions">
                    <a href="tel:988" class="crisis-banner__link">Call 988</a>
                    <a href="sms:988" class="crisis-banner__link">Text 988</a>
                </div>
            </div>
            ` : ''}
            
            <div class="header">
                <div class="header__top">
                    <button class="back-btn" onclick="previousStep()" aria-label="Go back">‚Üê</button>
                    <span class="step-indicator">${currentStep} / ${totalSteps}</span>
                </div>
                <div class="progress-dots">
                    ${Array(totalSteps).fill(0).map((_, i) => 
                        `<div class="progress-dot ${i < currentStep ? 'active' : ''}"></div>`
                    ).join('')}
                </div>
                <h1 class="step-title">${stepTitles[currentStep]}</h1>
                <p class="step-subtitle">Module 1: Why Your Brain Goes Haywire</p>
            </div>
        `;
    }
    
    function renderStep1() {
        return `
            <div class="step-content">
                ${renderHeader(true)}
                
                <div class="card">
                    <div class="card__icon">üß†</div>
                    <div class="card__content">
                        <p>Meet your <strong>amygdala</strong> ‚Äî your brain's smoke detector. Its job is to keep you alive by detecting threats.</p>
                        
                        <p>The problem? <strong>It can't tell the difference between a tiger and a text message.</strong></p>
                        
                        <p>When it fires, three things happen:</p>
                        
                        <ol>
                            <li>Your <strong>thinking brain (prefrontal cortex) goes partially offline</strong></li>
                            <li>Your body floods with <strong>stress chemicals</strong> (adrenaline, cortisol)</li>
                            <li>You get powerful <strong>action urges</strong> (fight, flee, freeze, or other impulsive behaviors)</li>
                        </ol>
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep2() {
        setTimeout(() => {
            initBrainInteraction();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="card__content">
                        <div class="callout">
                            <p><strong>This is why you can't 'logic yourself out' of panic.</strong> Your logic center is literally impaired.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="brain-container">
                        <svg class="brain-svg" viewBox="0 0 200 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path id="brainOutline" d="M40 40 Q60 20, 100 20 Q140 20, 160 40 Q170 60, 160 80 Q140 100, 100 100 Q60 100, 40 80 Q30 60, 40 40" 
                                  stroke="rgba(14,116,144,0.5)" stroke-width="2.5" fill="rgba(14,116,144,0.08)"/>
                            
                            <path id="pfc" d="M70 30 L90 30 L85 50 L75 50 Z" 
                                  fill="rgba(94,234,212,0.4)" stroke="#0e7490" stroke-width="2"
                                  style="transition: opacity 0.3s ease;"/>
                            
                            <circle id="amygdala" cx="110" cy="70" r="13" 
                                    fill="rgba(220,38,38,0.3)" stroke="#991b1b" stroke-width="2"
                                    style="transition: fill 0.3s ease;"/>
                            
                            <text x="110" y="75" font-size="12" text-anchor="middle" fill="#fca5a5" font-weight="bold">‚ö†Ô∏è</text>
                        </svg>
                        
                        <button id="brainBtn" class="brain-btn pulse">
                            <span id="brainBtnText">üî• Trigger Crisis Mode</span>
                        </button>
                        <p class="btn-hint">üëÜ Tap to see what happens in your brain during crisis</p>
                        
                        <div class="brain-states">
                            <div class="brain-state">
                                <div class="brain-state__name" style="color: #5eead4;">üß† Prefrontal Cortex</div>
                                <div class="brain-state__desc" id="pfcDesc">Thinking brain ‚Ä¢ ONLINE</div>
                            </div>
                            <div class="brain-state">
                                <div class="brain-state__name" style="color: #fca5a5;">‚ö†Ô∏è Amygdala</div>
                                <div class="brain-state__desc" id="amygdalaDesc">Alarm system ‚Ä¢ STANDBY</div>
                            </div>
                        </div>
                        
                        <div id="actionUrges" class="action-urges">
                            <div class="action-urges__title">‚ö° ACTION URGES:</div>
                            <div class="action-urges__grid">
                                <div class="urge-badge">üèÉ RUN!</div>
                                <div class="urge-badge">‚öîÔ∏è FIGHT!</div>
                                <div class="urge-badge">‚ùÑÔ∏è SHUT DOWN!</div>
                                <div class="urge-badge">üî• DO SOMETHING!</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep3() {
        setTimeout(() => {
            initWaveInteraction();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="card__title">
                        <span>üåä</span>
                        <span>The Emotional Wave</span>
                    </div>
                    <div class="card__content">
                        <p>Here's the most important thing to understand: <strong>Emotions are temporary.</strong></p>
                        
                        <p>They feel permanent, but they're not. Every emotion follows a predictable pattern - it rises, peaks, and falls. This is called habituation.</p>
                        
                        <p>The peak usually happens around <strong>10-20 minutes</strong>. If you can survive those 20 minutes without acting on destructive urges, the intensity WILL decrease.</p>
                        
                        <p>This isn't positive thinking - it's neuroscience.</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="wave-container">
                        <svg class="wave-svg" viewBox="0 0 300 120" preserveAspectRatio="xMidYMid meet">
                            <line x1="30" y1="100" x2="280" y2="100" stroke="#94a3b8" stroke-width="1" stroke-dasharray="2"/>
                            <line x1="30" y1="20" x2="30" y2="100" stroke="#94a3b8" stroke-width="1" stroke-dasharray="2"/>
                            
                            <text x="10" y="60" font-size="8" fill="#94a3b8" transform="rotate(-90 10,60)">Intensity</text>
                            <text x="280" y="115" font-size="8" fill="#94a3b8" text-anchor="end">Time (min) ‚Üí</text>
                            
                            <text x="30" y="115" font-size="7" fill="#94a3b8">0</text>
                            <text x="110" y="115" font-size="7" fill="#94a3b8">10</text>
                            <text x="190" y="115" font-size="7" fill="#94a3b8">20</text>
                            <text x="270" y="115" font-size="7" fill="#94a3b8">30</text>
                            
                            <path id="waveGreen" d="M30 90 Q70 50, 110 60 Q150 70, 190 75 Q230 85, 270 90" 
                                  stroke="#5eead4" stroke-width="3" fill="none" stroke-linecap="round"/>
                            
                            <path id="waveRed" d="M30 90 Q70 30, 110 35 Q150 75, 190 85 Q230 65, 270 55" 
                                  stroke="#ef4444" stroke-width="3" fill="none" opacity="0" stroke-dasharray="6 4" stroke-linecap="round"
                                  style="transition: opacity 0.3s ease;"/>
                            
                            <circle cx="110" cy="60" r="5" fill="#fbbf24"/>
                            <text x="110" y="48" font-size="9" fill="#fbbf24" text-anchor="middle" font-weight="600">Peak</text>
                            <text x="110" y="35" font-size="8" fill="#94a3b8" text-anchor="middle">~10-20min</text>
                        </svg>
                        
                        <div class="wave-legend">
                            <div style="color: #5eead4;">‚óè Using skills</div>
                            <div id="redWaveLegend" style="color: #fca5a5; opacity: 0.4; transition: opacity 0.3s ease;">‚óè Acting on urge</div>
                        </div>
                        
                        <p class="scenario-question">Scenario: You're at intensity level 8. You want to send an angry text. What happens?</p>
                        
                        <div class="scenario-btns">
                            <button id="scenarioRed" class="scenario-btn scenario-btn--red pulse">
                                üì± Send the text
                            </button>
                            <button id="scenarioGreen" class="scenario-btn scenario-btn--green pulse">
                                üßò Use a skill and wait
                            </button>
                        </div>
                        <p class="interaction-hint">üëÜ Tap each option to see what happens</p>
                        
                        <div id="scenarioFeedback" class="scenario-feedback">
                            Click a scenario to see what happens to your emotional wave.
                        </div>
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep4() {
        setTimeout(() => {
            initUrgeCheckboxes();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card card--highlight">
                    <div class="card__icon">‚ö°</div>
                    <div class="card__title">What Are Your Action Urges?</div>
                    <div class="card__content">
                        <p>When your amygdala fires in crisis, what does it tell you to do?</p>
                        
                        <p>Understanding your specific action urges is the first step in managing them.</p>
                    </div>
                    
                    <div class="checkbox-grid">
                        ${[
                            'Escape/run away',
                            'Hurt myself',
                            'Lash out at others',
                            'Use substances',
                            'Shut down completely',
                            'Other destructive behavior'
                        ].map((urge, i) => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="urge${i}" value="${urge}">
                                <label for="urge${i}" class="checkbox-label">
                                    <span class="checkbox-visual"></span>
                                    <span>${urge}</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button id="saveUrgesBtn" class="btn btn--save">
                        <span>üìã</span>
                        <span>Save My Action Urges</span>
                    </button>
                    <div id="urgesFeedback" class="save-feedback"></div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep5() {
        setTimeout(() => {
            initWindowZones();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="card__icon">üéØ</div>
                    <div class="card__title">Your Window of Tolerance</div>
                    <div class="card__content">
                        <p>Imagine you have an optimal zone where you can function well - not too activated, not too shut down.</p>
                        
                        <p>This is your <strong>window of tolerance</strong> (concept from Dr. Dan Siegel).</p>
                        
                        <p>Crisis skills are about getting back INTO your window, not about becoming perfectly calm.</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="zone-list">
                        <button id="zoneHyper" class="zone zone--hyper pulse">
                            <div class="zone__title" style="color: #fca5a5;">
                                <span>üî•</span>
                                <span>HYPERAROUSAL</span>
                            </div>
                            <div class="zone__desc">Racing heart ‚Ä¢ Can't sit still ‚Ä¢ Mind racing ‚Ä¢ Feel like you'll explode ‚Ä¢ Panic/rage</div>
                        </button>
                        
                        <button id="zoneOptimal" class="zone zone--optimal pulse">
                            <div class="zone__title" style="color: #5eead4;">
                                <span>üéØ</span>
                                <span>WINDOW OF TOLERANCE</span>
                            </div>
                            <div class="zone__desc">Can think clearly ‚Ä¢ Feel emotions but not overwhelmed ‚Ä¢ Can make choices ‚Ä¢ Connected to body and surroundings</div>
                        </button>
                        
                        <button id="zoneHypo" class="zone zone--hypo pulse">
                            <div class="zone__title" style="color: #94a3b8;">
                                <span>‚ùÑÔ∏è</span>
                                <span>HYPOAROUSAL</span>
                            </div>
                            <div class="zone__desc">Numb/disconnected ‚Ä¢ Foggy thinking ‚Ä¢ Very low energy ‚Ä¢ Feel nothing ‚Ä¢ Want to sleep/disappear</div>
                        </button>
                    </div>
                    <p class="interaction-hint">üëÜ Tap the zone that describes you RIGHT NOW</p>
                    
                    <div id="zoneFeedback" class="zone-feedback">
                        Click the zone that describes you to get personalized guidance.
                    </div>
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep6() {
        setTimeout(() => {
            initQuiz();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="card">
                    <div class="card__title">Quick Knowledge Check</div>
                    <div class="card__content">
                        <p>Let's make sure you understand the core concepts. Answer these questions to check your understanding.</p>
                    </div>
                </div>
                
                <div class="quiz-list">
                    ${[
                        {
                            q: '1. Why can\'t you think clearly in crisis?',
                            options: [
                                { text: 'You\'re not trying hard enough', correct: false },
                                { text: 'Your prefrontal cortex is partially offline', correct: true },
                                { text: 'You\'re weak or flawed', correct: false }
                            ],
                            correctFeedback: '‚úì Correct! Your prefrontal cortex (thinking brain) is partially offline during crisis.',
                            incorrectFeedback: '‚úó Not quite. Your thinking brain is literally impaired during crisis due to your amygdala taking over.'
                        },
                        {
                            q: '2. How long do emotional peaks typically last?',
                            options: [
                                { text: 'Several hours', correct: false },
                                { text: '10-20 minutes', correct: true },
                                { text: 'Several days', correct: false }
                            ],
                            correctFeedback: '‚úì Correct! Emotional peaks typically last 10-20 minutes, then naturally decline.',
                            incorrectFeedback: '‚úó Not quite. Emotions peak quickly ‚Äî usually within 10-20 minutes.'
                        },
                        {
                            q: '3. What\'s the goal of crisis skills?',
                            options: [
                                { text: 'Make emotions go away permanently', correct: false },
                                { text: 'Survive the peak without making things worse', correct: true },
                                { text: 'Fix all your problems instantly', correct: false }
                            ],
                            correctFeedback: '‚úì Correct! Crisis skills help you survive the peak without making things worse.',
                            incorrectFeedback: '‚úó Not quite. Crisis skills are about survival and harm reduction, not fixing everything.'
                        }
                    ].map((quiz, qNum) => `
                        <div class="quiz-item">
                            <div class="quiz-question">${quiz.q}</div>
                            <div class="quiz-options">
                                ${quiz.options.map((opt, oNum) => `
                                    <div class="quiz-option" data-question="${qNum}" data-correct="${opt.correct}">
                                        <input type="radio" name="q${qNum}" id="q${qNum}_${oNum}">
                                        <label for="q${qNum}_${oNum}" class="quiz-option-label">
                                            <span class="quiz-radio"></span>
                                            <span>${opt.text}</span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                            <div id="feedback${qNum}" class="quiz-feedback" data-correct="${quiz.correctFeedback}" data-incorrect="${quiz.incorrectFeedback}"></div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep7() {
        setTimeout(() => {
            initSummaryCard();
        }, 100);
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <div class="summary-card">
                    <div class="summary-header">
                        <span class="summary-icon">üß†</span>
                        <h2 class="summary-title">Crisis Brain Facts</h2>
                    </div>
                    
                    <ul class="summary-list">
                        <li>Your thinking brain goes offline during crisis</li>
                        <li>Emotions peak in 10-20 minutes, then naturally decline</li>
                        <li>Your body can calm your mind (Module 2 will teach you how)</li>
                        <li>You can't logic your way out of a crisis state</li>
                        <li>The emotional wave WILL pass if you wait and use skills</li>
                    </ul>
                    
                    <!-- NO SAVE BUTTON - these are facts, not actionable skills -->
                </div>
                
                <button class="btn btn--primary" onclick="nextStep()">
                    <span>Continue</span>
                    <span>‚Üí</span>
                </button>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderStep8() {
        setTimeout(() => {
            initPracticeBtn();
        }, 100);
        
        // Get progress data
        const progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        const isPracticed = progress.practicedModules?.includes('module1') || false;
        const toolkitCount = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]').length;
        
        return `
            <div class="step-content">
                ${renderHeader()}
                
                <!-- CELEBRATION CARD -->
                <div class="card card--celebration">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="font-size: 2rem; font-weight: 800; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">Module Complete!</h2>
                    <p style="color: var(--text-teal); font-size: 1.1rem; margin-bottom: 1.5rem;">You've mastered the science of crisis</p>
                    
                    <div class="completion-stats">
                        <div class="stat-item">
                            <div class="stat-value">${currentStep}/${totalSteps}</div>
                            <div class="stat-label">STEPS DONE</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${toolkitCount}</div>
                            <div class="stat-label">TOOLKIT ITEMS</div>
                        </div>
                    </div>
                    
                    <div class="card__content" style="text-align: left;">
                        <p><strong>You've learned:</strong></p>
                        <ul>
                            <li>How your amygdala takes over in crisis</li>
                            <li>Why your thinking brain goes offline</li>
                            <li>That emotions peak in 10-20 minutes</li>
                            <li>Your personal action urges</li>
                            <li>Your window of tolerance</li>
                        </ul>
                    </div>
                </div>
                
                <!-- MARK AS PRACTICED BUTTON -->
                <div class="practice-section">
                    <button id="practiceBtn" class="practice-btn ${isPracticed ? 'marked' : ''}">
                        <span>${isPracticed ? '‚úì' : '‚óã'}</span>
                        <span>${isPracticed ? 'Module 1 Practiced' : 'Mark Module as Practiced'}</span>
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Marking as practiced updates your progress on the course hub</p>
                </div>
                
                <!-- ACTION BUTTONS -->
                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;">
                    <!-- Primary options in a grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <a href="${COURSE_HUB_URL}" class="btn btn--secondary">
                            <span>üè†</span>
                            <span>Course Hub</span>
                        </a>
                        
                        <a href="${MODULE_2_URL}" class="btn btn--primary">
                            <span>Module 2 ‚Üí</span>
                        </a>
                    </div>
                    
                    <!-- Secondary options -->
                    <button class="btn btn--save" onclick="goToStep(1)" style="margin-top: 0.25rem;">
                        <span>‚Üª</span>
                        <span>Review Module 1 Again</span>
                    </button>
                    
                    <!-- Toolkit link -->
                    <a href="crisis-toolkit.html" class="btn btn--save" style="background: rgba(217,119,6,0.1);">
                        <span>üß∞</span>
                        <span>View My Toolkit</span>
                    </a>
                </div>
                
                <!-- NEXT MODULE PREVIEW -->
                <div class="card" style="margin-top: 1.5rem; background: rgba(14,116,144,0.08);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">‚è≠Ô∏è</div>
                        <div>
                            <h3 style="color: var(--text-teal); margin-bottom: 0.25rem;">Up Next: Module 2</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Physical Reset ‚Äî learn body-based techniques to calm your brain</p>
                        </div>
                    </div>
                </div>
                
                ${renderFooter()}
            </div>
        `;
    }
    
    function renderFooter() {
        return `
            <div class="footer">
                <p class="footer__warning">‚ö†Ô∏è EDUCATIONAL ONLY ‚Äî NOT THERAPY</p>
                <div class="footer__resources">
                    <p><span class="footer__link" onclick="showCrisisInfo()">Crisis resources available 24/7</span></p>
                </div>
            </div>
        `;
    }
    
    function showCrisisInfo() {
        alert('üö® CRISIS RESOURCES 24/7\n\n988 Suicide & Crisis Lifeline:\nCall or text 988\n\nCrisis Text Line:\nText HOME to 741741');
    }
    
    // Interactive functionality
    function initBrainInteraction() {
        const btn = document.getElementById('brainBtn');
        const btnText = document.getElementById('brainBtnText');
        const pfc = document.getElementById('pfc');
        const amygdala = document.getElementById('amygdala');
        const pfcDesc = document.getElementById('pfcDesc');
        const amygdalaDesc = document.getElementById('amygdalaDesc');
        const urges = document.getElementById('actionUrges');
        
        let active = false;
        
        if (btn) {
            btn.addEventListener('click', () => {
                active = !active;
                
                // Remove pulse animation after first click
                btn.classList.remove('pulse');
                
                if (active) {
                    pfc.style.opacity = '0.3';
                    amygdala.setAttribute('fill', 'rgba(220,38,38,0.9)');
                    pfcDesc.textContent = 'Thinking brain ‚Ä¢ OFFLINE';
                    amygdalaDesc.textContent = 'Alarm system ‚Ä¢ ACTIVATED';
                    btnText.textContent = 'üòÆ‚Äçüí® Reset Brain';
                    btn.classList.add('active');
                    urges.classList.add('show');
                } else {
                    pfc.style.opacity = '1';
                    amygdala.setAttribute('fill', 'rgba(220,38,38,0.3)');
                    pfcDesc.textContent = 'Thinking brain ‚Ä¢ ONLINE';
                    amygdalaDesc.textContent = 'Alarm system ‚Ä¢ STANDBY';
                    btnText.textContent = 'üî• Trigger Crisis Mode';
                    btn.classList.remove('active');
                    urges.classList.remove('show');
                }
            });
        }
    }
    
    function initWaveInteraction() {
        const redBtn = document.getElementById('scenarioRed');
        const greenBtn = document.getElementById('scenarioGreen');
        const waveRed = document.getElementById('waveRed');
        const legend = document.getElementById('redWaveLegend');
        const feedback = document.getElementById('scenarioFeedback');
        
        if (redBtn) {
            redBtn.addEventListener('click', () => {
                // Remove pulse from both buttons
                redBtn.classList.remove('pulse');
                greenBtn.classList.remove('pulse');
                
                waveRed.style.opacity = '1';
                legend.style.opacity = '1';
                feedback.innerHTML = '<span style="color: #fca5a5;"><strong>‚ùå Result:</strong> You felt relief for 30 seconds. Now you have regret on top of your original feeling. <strong>Intensity: 9/10</strong> ‚Äî and you may have damaged a relationship.</span>';
            });
        }
        
        if (greenBtn) {
            greenBtn.addEventListener('click', () => {
                // Remove pulse from both buttons
                redBtn.classList.remove('pulse');
                greenBtn.classList.remove('pulse');
                
                waveRed.style.opacity = '0.2';
                legend.style.opacity = '0.4';
                feedback.innerHTML = '<span style="color: #5eead4;"><strong>‚úÖ Result:</strong> You rode the wave. It was hard, but you didn\'t make things worse. After 20 minutes, <strong>intensity: 4/10</strong> ‚Äî and no regrets or relationship damage.</span>';
            });
        }
    }
    
    function initUrgeCheckboxes() {
        const saveBtn = document.getElementById('saveUrgesBtn');
        const feedback = document.getElementById('urgesFeedback');
        const checkboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]');
        
        // Load saved urges
        if (userData.actionUrges.length > 0) {
            checkboxes.forEach(cb => {
                if (userData.actionUrges.includes(cb.value)) {
                    cb.checked = true;
                }
            });
        }
        
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (selected.length === 0) {
                    feedback.textContent = 'Please select at least one action urge.';
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 3000);
                    return;
                }
                
                userData.actionUrges = selected;
                
                saveToCrisisPlan('actionUrges', selected);
                
                saveToToolkit({
                    id: 'action-urges',
                    category: 'My Crisis Profile',
                    name: 'My Action Urges',
                    description: selected.join(', ')
                });
                
                saveBtn.classList.add('saved');
                saveBtn.innerHTML = '<span>‚úì</span><span>Saved!</span>';
                feedback.textContent = '‚úì Saved to your crisis plan and toolkit.';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    saveBtn.classList.remove('saved');
                    saveBtn.innerHTML = '<span>üìã</span><span>Save My Action Urges</span>';
                    feedback.classList.remove('show');
                }, 3000);
            });
        }
    }
    
    function initWindowZones() {
        const zones = ['zoneHyper', 'zoneOptimal', 'zoneHypo'];
        const feedback = document.getElementById('zoneFeedback');
        
        const feedbackText = {
            zoneHyper: '<span style="color: #fca5a5;"><strong>üî• Hyperarousal:</strong> You need to bring your energy DOWN. Module 2 will teach you techniques like cold water immersion, intense physical exercise, and paced breathing to help you return to your window.</span>',
            zoneOptimal: '<span style="color: #5eead4;"><strong>‚úÖ Window of Tolerance:</strong> Great! You\'re in an optimal state for learning. This is the perfect time to practice the skills you\'ll learn in Modules 2 and 3, so they\'re ready when you need them.</span>',
            zoneHypo: '<span style="color: #94a3b8;"><strong>‚ùÑÔ∏è Hypoarousal:</strong> You need to bring your energy UP. Module 2 includes activation techniques like intense movement, temperature shock, and strong sensory input to help you reconnect.</span>'
        };
        
        zones.forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            if (zone) {
                zone.addEventListener('click', () => {
                    // Remove pulse from all zones
                    zones.forEach(z => {
                        const zoneEl = document.getElementById(z);
                        if (zoneEl) zoneEl.classList.remove('pulse');
                    });
                    
                    userData.windowZone = zoneId;
                    feedback.innerHTML = feedbackText[zoneId];
                    
                    // Save to crisis plan
                    saveToCrisisPlan('windowZone', zoneId);
                    
                    // Save to toolkit as self-knowledge
                    const zoneNames = {
                        zoneHyper: 'Hyperarousal (too activated)',
                        zoneOptimal: 'Window of Tolerance (optimal)',
                        zoneHypo: 'Hypoarousal (shut down)'
                    };
                    
                    saveToToolkit({
                        id: 'window-zone',
                        category: 'My Crisis Profile',
                        name: 'My Window of Tolerance',
                        description: zoneNames[zoneId] || zoneId
                    });
                });
            }
        });
    }
    
    function initQuiz() {
        const options = document.querySelectorAll('.quiz-option');
        
        options.forEach(option => {
            const radio = option.querySelector('input[type="radio"]');
            
            if (radio) {
                radio.addEventListener('change', () => {
                    const qNum = option.dataset.question;
                    const isCorrect = option.dataset.correct === 'true';
                    const feedback = document.getElementById(`feedback${qNum}`);
                    
                    document.querySelectorAll(`.quiz-option[data-question="${qNum}"]`).forEach(opt => {
                        opt.classList.remove('correct', 'incorrect');
                    });
                    
                    if (isCorrect) {
                        option.classList.add('correct');
                        feedback.className = 'quiz-feedback correct show';
                        feedback.textContent = feedback.dataset.correct;
                    } else {
                        option.classList.add('incorrect');
                        feedback.className = 'quiz-feedback incorrect show';
                        feedback.textContent = feedback.dataset.incorrect;
                    }
                    
                    userData.quizAnswers[qNum] = isCorrect;
                });
            }
        });
    }
    
    function initSummaryCard() {
        // No save button to initialize - facts don't belong in toolkit
        // This function intentionally left empty
    }
    
    function initPracticeBtn() {
        const btn = document.getElementById('practiceBtn');
        
        if (!btn) return;
        
        let progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        if (!progress.practicedModules) {
            progress.practicedModules = [];
        }
        
        // Update button state based on current progress
        if (progress.practicedModules.includes('module1')) {
            btn.classList.add('marked');
            btn.innerHTML = '<span>‚úì</span><span>Module 1 Practiced</span>';
        }
        
        btn.addEventListener('click', () => {
            if (!progress.practicedModules.includes('module1')) {
                progress.practicedModules.push('module1');
                progress.lastPracticed = new Date().toISOString();
                localStorage.setItem('crisis_course_progress', JSON.stringify(progress));
                
                btn.classList.add('marked');
                btn.innerHTML = '<span>‚úì</span><span>Module 1 Practiced</span>';
                
                // Show a quick feedback
                const feedback = document.createElement('div');
                feedback.style.cssText = 'color: var(--success-emerald); text-align: center; margin-top: 0.5rem; font-size: 0.9rem;';
                feedback.textContent = '‚úì Progress saved! Check the course hub.';
                btn.parentNode.appendChild(feedback);
                setTimeout(() => feedback.remove(), 3000);
                
                // Update the main app state if it exists
                try {
                    const mainState = JSON.parse(localStorage.getItem('mphaven_state') || '{}');
                    if (!mainState.courses) mainState.courses = {};
                    if (!mainState.courses['crisis-resilience']) mainState.courses['crisis-resilience'] = {};
                    mainState.courses['crisis-resilience'].lastActivity = new Date().toISOString();
                    mainState.courses['crisis-resilience'].progress = Math.round((progress.practicedModules.length / 5) * 100);
                    localStorage.setItem('mphaven_state', JSON.stringify(mainState));
                } catch(e) {}
            }
        });
    }
    
    // Main render
    function render() {
        const content = document.getElementById('content');
        
        let html = '';
        switch(currentStep) {
            case 1: html = renderStep1(); break;
            case 2: html = renderStep2(); break;
            case 3: html = renderStep3(); break;
            case 4: html = renderStep4(); break;
            case 5: html = renderStep5(); break;
            case 6: html = renderStep6(); break;
            case 7: html = renderStep7(); break;
            case 8: html = renderStep8(); break;
            default: html = renderStep1();
        }
        
        content.innerHTML = html;
        
        let courseProgress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        courseProgress.currentModule = 1;
        courseProgress.lastAccessed = new Date().toISOString();
        localStorage.setItem('crisis_course_progress', JSON.stringify(courseProgress));
    }
    
    // Expose functions globally
    window.nextStep = nextStep;
    window.previousStep = previousStep;
    window.goToStep = goToStep;
    window.showCrisisInfo = showCrisisInfo;
    
    // Initialize
    loadProgress();
    render();
})();
</script>
</body>
</html>
