<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Module 5: Your Crisis Action Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: rgba(15, 23, 42, 0.98);
    --bg-card-light: rgba(30, 41, 59, 0.7);
    --bg-card-dark: rgba(15, 23, 42, 0.5);
    --border-subtle: rgba(30, 41, 59, 0.5);
    --border-softer: rgba(51, 65, 85, 0.4);
    --primary-teal: #0e7490;
    --accent-amber: #d97706;
    --text-primary: rgb(241, 245, 249);
    --text-secondary: rgb(203, 213, 225);
    --text-muted: rgb(148, 163, 184);
    --text-teal-light: rgb(165, 243, 252);
    --text-teal: rgb(94, 234, 212);
    --success-emerald: rgb(74, 222, 128);
    --success-bg: rgba(34, 197, 94, 0.12);
    --gradient-main: linear-gradient(135deg, #0e7490, #d97706);
    --gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
    --crisis-red: #dc2626;
    --crisis-bg: rgba(220, 38, 38, 0.08);
    --text-amber: #fbbf24;
    --space-xs: 0.5rem;
    --space-sm: 0.75rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-xxl: 2.5rem;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: var(--bg-dark);
    color: var(--text-primary);
}

.container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.app-wrapper {
    width: 100%;
    max-width: 28rem;
    height: 100%;
    margin: 0 auto;
    background: var(--bg-card);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.bg-blur-1, .bg-blur-2 {
    position: absolute;
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.2;
}

.bg-blur-1 {
    top: -5%;
    left: 50%;
    transform: translateX(-50%);
    width: 22rem;
    height: 22rem;
    background: rgba(14, 116, 144, 0.15);
}

.bg-blur-2 {
    bottom: -5%;
    right: -5%;
    width: 18rem;
    height: 18rem;
    background: rgba(217, 119, 6, 0.15);
}

.main-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    position: relative;
    z-index: 1;
    padding: var(--space-md) var(--space-md) calc(2rem + env(safe-area-inset-bottom));
}

.main-content::-webkit-scrollbar {
    display: none;
}

.crisis-banner {
    background: var(--crisis-bg);
    border: 1px solid var(--crisis-red);
    border-radius: 0.75rem;
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.crisis-text {
    color: #fca5a5;
    font-size: 0.8125rem;
    font-weight: 600;
}

.crisis-actions {
    display: flex;
    gap: 0.5rem;
}

.crisis-link {
    color: white;
    background: var(--crisis-red);
    text-decoration: none;
    padding: 0.4rem 0.875rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
}

.header {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1.25rem;
    padding: var(--space-lg) var(--space-md);
    margin-bottom: var(--space-xl);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
}

.back-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
}

.step-indicator {
    color: var(--text-muted);
    font-size: 0.8125rem;
    font-weight: 600;
}

.progress-dots {
    display: flex;
    gap: 0.375rem;
    margin-bottom: var(--space-sm);
}

.progress-dot {
    flex: 1;
    height: 0.375rem;
    background: rgba(148,163,184,0.2);
    border-radius: 1rem;
    transition: all 0.3s;
}

.progress-dot.active {
    background: var(--gradient-main);
}

.step-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: var(--gradient-main);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.25rem;
    line-height: 1.3;
}

.step-subtitle {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.card {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1.5rem;
    padding: var(--space-xl) var(--space-lg);
    margin-bottom: var(--space-xl);
}

.card-highlight {
    background: var(--gradient-subtle);
    border: 1px solid rgba(14,116,144,0.3);
    border-radius: 1.5rem;
    padding: var(--space-xl) var(--space-lg);
    margin-bottom: var(--space-xl);
}

.section-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-softer);
}

.section-icon {
    font-size: 1.8rem;
}

.section-title-text {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-teal-light);
}

.btn {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border-radius: 0.875rem;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    border: none;
    text-decoration: none;
    text-align: center;
    display: inline-block;
    line-height: 1.4;
}

.btn-primary {
    background: var(--gradient-main);
    color: white;
}

.btn-secondary {
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn-group {
    display: flex;
    gap: var(--space-md);
    margin: var(--space-xl) 0 var(--space-lg);
}

.btn-save {
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    border: 1px solid rgba(14,116,144,0.3);
    padding: 0.75rem 1.25rem;
    border-radius: 2rem;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    width: 100%;
    margin-top: var(--space-md);
    line-height: 1.4;
}

.btn-save.saved {
    background: var(--success-bg);
    color: var(--success-emerald);
    border-color: rgba(74,222,128,0.3);
}

.input-field {
    width: 100%;
    padding: 0.875rem;
    background: rgba(15,23,42,0.6);
    border: 1px solid var(--border-softer);
    border-radius: 0.75rem;
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s;
}

.input-field:focus {
    outline: none;
    border-color: var(--primary-teal);
}

.input-field.highlight {
    border: 2px solid var(--accent-amber);
    background: rgba(217,119,6,0.1);
}

.toolkit-drawer {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 2px solid var(--primary-teal);
    border-radius: 1.5rem;
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
    position: relative;
    z-index: 10;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.drawer-title {
    color: var(--text-teal-light);
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.close-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
}

.tab-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border-softer);
    padding-bottom: var(--space-sm);
}

.tab-btn {
    flex: 1;
    padding: 0.75rem;
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn.active {
    background: var(--gradient-main);
    color: white;
    border-color: transparent;
}

.skills-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    max-height: 350px;
    overflow-y: auto;
    padding-right: 0.25rem;
}

.skill-item {
    background: rgba(14,116,144,0.1);
    border: 1px solid transparent;
    border-radius: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.skill-item:hover {
    background: rgba(14,116,144,0.2);
    border-color: var(--primary-teal);
    transform: translateY(-2px);
}

.skill-icon {
    font-size: 1.2rem;
    min-width: 1.5rem;
}

.skill-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8125rem;
}

.skill-desc {
    color: var(--text-muted);
    font-size: 0.6875rem;
    margin-top: 0.125rem;
}

.module-header {
    grid-column: span 2;
    color: var(--text-teal);
    font-weight: 700;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
    padding-left: 0.25rem;
}

.intensity-section {
    background: rgba(14,116,144,0.1);
    border-radius: 1rem;
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.intensity-badge {
    display: inline-block;
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    padding: 0.25rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
}

.intensity-badge.high {
    background: var(--crisis-bg);
    color: #fca5a5;
    border: 1px solid var(--crisis-red);
}

.input-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.input-row label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    min-width: 60px;
}

.insert-btn {
    background: var(--gradient-subtle);
    border: none;
    color: var(--text-teal-light);
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s;
}

.insert-btn:hover {
    background: rgba(14,116,144,0.3);
}

.pros-cons-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin: var(--space-lg) 0;
}

.pros-cons-box {
    background: rgba(15,23,42,0.6);
    border-radius: 1rem;
    padding: var(--space-md);
}

.pros-cons-title {
    font-weight: 700;
    margin-bottom: var(--space-sm);
}

.values-compass {
    background: rgba(14,116,144,0.15);
    border: 2px solid var(--primary-teal);
    border-radius: 1.5rem;
    padding: var(--space-xl) var(--space-lg);
    margin: var(--space-lg) 0;
    text-align: center;
}

.compass-question {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-teal-light);
    margin-bottom: var(--space-md);
}

.crisis-card-preview {
    background: linear-gradient(135deg, rgba(14,116,144,0.2), rgba(217,119,6,0.1));
    border: 2px solid var(--accent-amber);
    border-radius: 1.5rem;
    padding: var(--space-xl) var(--space-lg);
    margin: var(--space-xl) 0;
    position: relative;
    overflow: hidden;
}

.crisis-card-preview:before {
    content: "üÜò";
    position: absolute;
    top: 0.5rem;
    right: 1rem;
    font-size: 2rem;
    opacity: 0.1;
}

.crisis-card-title {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--text-amber);
    margin-bottom: var(--space-lg);
}

.crisis-card-item {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: var(--space-sm);
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.crisis-card-number {
    color: var(--text-amber);
    font-weight: 700;
    min-width: 1.5rem;
}

.completion-box {
    background: var(--gradient-subtle);
    border: 2px solid var(--primary-teal);
    border-radius: 1.5rem;
    padding: var(--space-xxl) var(--space-lg);
    margin: var(--space-xxl) 0;
    text-align: center;
}

.completion-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
}

.completion-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-teal-light);
    margin-bottom: var(--space-sm);
}

.completion-text {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: var(--space-lg);
}

.footer {
    margin-top: var(--space-xxl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-subtle);
    text-align: center;
}

.footer-warning {
    color: #fca5a5;
    font-weight: 600;
    font-size: 0.8125rem;
    margin-bottom: var(--space-sm);
}

.footer-resources {
    color: var(--text-muted);
    font-size: 0.75rem;
    line-height: 1.6;
}

.save-feedback {
    color: var(--success-emerald);
    font-size: 0.75rem;
    text-align: center;
    margin-top: 0.5rem;
    display: none;
}

.save-feedback.show {
    display: block;
}

.hidden {
    display: none !important;
}

@media (max-width: 640px) {
    .pros-cons-grid {
        grid-template-columns: 1fr;
    }
    .btn-group {
        flex-direction: column;
    }
    .skills-grid {
        grid-template-columns: 1fr;
    }
    .module-header {
        grid-column: span 1;
    }
}
</style>

</head>
<body>
<div class="container">
  <div class="app-wrapper">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>
    <div class="main-content" id="mainContent">
      <div class="content-wrapper" id="content">
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  if (!localStorage.getItem('crisis_disclaimer_acknowledged')) {
    window.location.href = 'crisis-intro.html';
    return;
  }

  let currentStep = 1;
  const totalSteps = 9;
  
  const stepTitles = {
    1: 'Introduction',
    2: 'Intensity Plan (1-6)',
    3: 'Intensity Plan (7-10)',
    4: 'Pros & Cons Worksheet',
    5: 'Values Compass',
    6: 'Physical Crisis Kit',
    7: 'Your Crisis Card',
    8: 'Practice Schedule',
    9: 'Course Complete!'
  };

  const allSkills = [
    { module: 1, name: 'Name It', icon: 'üè∑Ô∏è', desc: 'Label the emotion - "This is a wave"' },
    { module: 1, name: 'Observe', icon: 'üëÅÔ∏è', desc: 'Watch thoughts like clouds passing' },
    { module: 1, name: 'Name the Urge', icon: 'üìù', desc: '"I\'m having the urge to..."' },
    { module: 1, name: 'Crisis Timeline', icon: '‚è±Ô∏è', desc: 'This will pass in X minutes' },
    { module: 1, name: 'Physiology Check', icon: 'üíì', desc: 'Notice heartbeat, breathing, temperature' },
    { module: 2, name: 'Cold Water', icon: 'üßä', desc: 'Dive reflex - 30-60 sec face dunk' },
    { module: 2, name: 'Intense Exercise', icon: 'üí™', desc: '3-5 min sprints, jumping jacks, stairs' },
    { module: 2, name: 'Paced Breathing', icon: 'üå¨Ô∏è', desc: '4-7-8 or box breathing' },
    { module: 2, name: 'PMR', icon: 'üíÜ', desc: 'Tense/release muscle groups' },
    { module: 2, name: 'Temperature Shock', icon: 'üå°Ô∏è', desc: 'Ice cubes or hot shower' },
    { module: 3, name: '5-4-3-2-1 Grounding', icon: 'üî¢', desc: '5 things you see, 4 you feel, etc.' },
    { module: 3, name: 'Temperature Grounding', icon: '‚ùÑÔ∏è', desc: 'Hold ice, cold water' },
    { module: 3, name: 'Descriptive Grounding', icon: 'üìù', desc: 'Describe surroundings in detail' },
    { module: 3, name: 'Physical Sensation', icon: 'ü´ß', desc: 'Run hands under water' },
    { module: 3, name: 'Intentional Distraction', icon: 'üéØ', desc: 'Choose activity for 20 min' },
    { module: 3, name: 'Cognitive Load', icon: 'üî¢', desc: 'Count backwards, math problems' },
    { module: 4, name: 'Wise Mind', icon: '‚öñÔ∏è', desc: 'Balance emotion + reason' },
    { module: 4, name: 'Opposite Action', icon: 'üîÑ', desc: 'Do opposite of urge' },
    { module: 4, name: 'Acceptance', icon: 'ü§≤', desc: '"It is what it is"' },
    { module: 4, name: 'Values Check', icon: 'üß≠', desc: 'Does this align with who I want to be?' },
    { module: 4, name: 'Radical Acceptance', icon: 'üåä', desc: 'Full acceptance of reality' },
    { module: 4, name: 'Pros & Cons', icon: '‚öñÔ∏è', desc: 'Short-term vs long-term' },
    { module: 4, name: 'Urge Surfing', icon: 'üèÑ', desc: 'Ride the wave like a surfer' },
    { module: 4, name: 'STOP Skill', icon: '‚úã', desc: 'Stop, Take a breath, Observe, Proceed' }
  ];

  function saveProgress() {
    localStorage.setItem('crisis_module5_progress', JSON.stringify({
      step: currentStep,
      timestamp: Date.now()
    }));
  }

  function loadProgress() {
    try {
      const saved = localStorage.getItem('crisis_module5_progress');
      if (saved) {
        const data = JSON.parse(saved);
        if (Date.now() - data.timestamp < 86400000) {
          currentStep = data.step || 1;
        }
      }
    } catch (e) {}
  }

  function saveToToolkit(item) {
    let toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
    toolkit = toolkit.filter(t => t.id !== item.id);
    toolkit.push({...item, date: new Date().toISOString()});
    localStorage.setItem('crisis_toolkit', JSON.stringify(toolkit));
  }

  function saveToCrisisPlan(key, value) {
    let plan = JSON.parse(localStorage.getItem('crisis_plan') || '{}');
    plan[key] = value;
    plan.lastUpdated = new Date().toISOString();
    localStorage.setItem('crisis_plan', JSON.stringify(plan));
  }

  function scrollToTop() {
    document.getElementById('mainContent').scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.nextStep = function() {
    if (currentStep < totalSteps) {
      currentStep++;
      saveProgress();
      render();
      scrollToTop();
    }
  };

  window.previousStep = function() {
    if (currentStep > 1) {
      currentStep--;
      saveProgress();
      render();
      scrollToTop();
    } else {
      window.location.href = 'crisis-module-4.html';
    }
  };

  function renderHeader() {
    return `
      <div class="crisis-banner">
        <span class="crisis-text">üö® In crisis? 24/7 help available</span>
        <div class="crisis-actions">
          <a href="tel:988" class="crisis-link">Call 988</a>
          <a href="sms:988" class="crisis-link">Text 988</a>
        </div>
      </div>
      
      <div class="header">
        <div class="header-top">
          <button class="back-btn" onclick="window.previousStep()">‚Üê</button>
          <span class="step-indicator">${currentStep} / ${totalSteps}</span>
        </div>
        <div class="progress-dots">
          ${Array(totalSteps).fill(0).map((_, i) => 
            `<div class="progress-dot ${i < currentStep ? 'active' : ''}"></div>`
          ).join('')}
        </div>
        <h1 class="step-title">${stepTitles[currentStep]}</h1>
        <p class="step-subtitle">Module 5: Your Crisis Action Plan</p>
      </div>
    `;
  }

  function renderFooter() {
    return `
      <div class="footer">
        <p class="footer-warning">‚ö†Ô∏è EDUCATIONAL ONLY ‚Äî NOT THERAPY</p>
        <div class="footer-resources">
          <p>988 Suicide & Crisis Lifeline: Call or text 988</p>
          <p>Crisis Text Line: Text HOME to 741741</p>
          <p style="margin-top: 0.5rem;">¬© MPHaven ‚Ä¢ You have the tools. Use them.</p>
        </div>
      </div>
    `;
  }

  function renderToolkitDrawer(targetInputId) {
    const toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
    const savedSkillNames = toolkit.map(t => t.name);
    
    return `
      <div class="toolkit-drawer" id="toolkitDrawer">
        <div class="drawer-header">
          <div class="drawer-title">
            <span>üß∞</span> SKILLS LIBRARY
          </div>
          <button class="close-btn" onclick="window.closeToolkit()">‚úï</button>
        </div>
        
        <div class="tab-container">
          <button class="tab-btn active" id="tabSaved" onclick="window.switchTab('saved')">‚≠ê MY SAVED</button>
          <button class="tab-btn" id="tabAll" onclick="window.switchTab('all')">üìö ALL SKILLS</button>
        </div>
        
        <div id="savedSkillsContent" style="display: block;">
          <div class="skills-grid">
            ${savedSkillNames.length > 0 ? 
              allSkills.filter(s => savedSkillNames.includes(s.name)).map(skill => `
                <div class="skill-item" onclick="window.insertSkill('${skill.name}', '${targetInputId}')">
                  <span class="skill-icon">${skill.icon}</span>
                  <div>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-desc">${skill.desc}</div>
                  </div>
                </div>
              `).join('') : 
              '<p style="grid-column: span 2; color: var(--text-muted); text-align: center; padding: 1rem;">No saved skills yet. Complete modules 1-4 first.</p>'
            }
          </div>
        </div>
        
        <div id="allSkillsContent" style="display: none;">
          <div class="skills-grid">
            ${[1,2,3,4].map(moduleNum => {
              const moduleSkills = allSkills.filter(s => s.module === moduleNum);
              if (moduleSkills.length === 0) return '';
              
              const moduleTitle = moduleNum === 1 ? 'üß† MODULE 1: Crisis Brain' : 
                                 moduleNum === 2 ? 'üí™ MODULE 2: Physical Reset' : 
                                 moduleNum === 3 ? 'üåç MODULE 3: Grounding' : 
                                 'üß† MODULE 4: Cognitive';
              
              return `
                <div class="module-header">${moduleTitle}</div>
                ${moduleSkills.map(skill => `
                  <div class="skill-item" onclick="window.insertSkill('${skill.name}', '${targetInputId}')">
                    <span class="skill-icon">${skill.icon}</span>
                    <div>
                      <div class="skill-name">${skill.name}</div>
                      <div class="skill-desc">${skill.desc}</div>
                    </div>
                  </div>
                `).join('')}
              `;
            }).join('')}
          </div>
        </div>
        
        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 1rem; text-align: center;">
          Click any skill to insert it into the plan
        </p>
      </div>
    `;
  }

  window.closeToolkit = function() {
    const drawer = document.getElementById('toolkitDrawer');
    if (drawer) drawer.remove();
    window.currentTargetInput = null;
  };

  window.switchTab = function(tab) {
    const tabSaved = document.getElementById('tabSaved');
    const tabAll = document.getElementById('tabAll');
    const savedContent = document.getElementById('savedSkillsContent');
    const allContent = document.getElementById('allSkillsContent');
    
    if (tabSaved && tabAll && savedContent && allContent) {
      tabSaved.classList.remove('active');
      tabAll.classList.remove('active');
      savedContent.style.display = 'none';
      allContent.style.display = 'none';
      
      if (tab === 'saved') {
        tabSaved.classList.add('active');
        savedContent.style.display = 'block';
      } else {
        tabAll.classList.add('active');
        allContent.style.display = 'block';
      }
    }
  };

  window.insertSkill = function(skillName, targetInputId) {
    const targetInput = document.getElementById(targetInputId);
    if (targetInput) {
      targetInput.value = skillName;
      targetInput.classList.add('highlight');
      setTimeout(() => targetInput.classList.remove('highlight'), 2000);
    }
    window.closeToolkit();
  };

  window.openToolkit = function(targetInputId) {
    const existing = document.getElementById('toolkitDrawer');
    if (existing) existing.remove();
    
    window.currentTargetInput = targetInputId;
    
    const btn = document.getElementById(`insertBtn_${targetInputId}`);
    if (btn) {
      const drawerHtml = renderToolkitDrawer(targetInputId);
      btn.insertAdjacentHTML('afterend', drawerHtml);
    }
    
    const targetInput = document.getElementById(targetInputId);
    if (targetInput) {
      targetInput.classList.add('highlight');
    }
  };

  function renderStep1() {
    return `
      ${renderHeader()}
      
      <div class="card-highlight">
        <p style="font-size: 1rem; color: var(--text-teal-light); font-style: italic; line-height: 1.6; margin: 0;">
          "You've learned the skills. Now we build YOUR personalized plan. In crisis, your thinking brain is impaired ‚Äî that's why you need a plan made NOW, when you can think clearly."
        </p>
      </div>
      
      <div class="card">
        <div class="section-header">
          <span class="section-icon">üÜò</span>
          <span class="section-title-text">Why a Crisis Plan?</span>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: var(--space-md);">
          <div style="display: flex; gap: var(--space-sm);">
            <span style="color: var(--text-teal); font-weight: 600; font-size: 1rem;">1.</span>
            <span style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.5;">In crisis, your <strong style="color: var(--text-teal);">thinking brain is offline</strong> ‚Äî you can't make good decisions</span>
          </div>
          <div style="display: flex; gap: var(--space-sm);">
            <span style="color: var(--text-teal); font-weight: 600; font-size: 1rem;">2.</span>
            <span style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.5;">A written plan <strong style="color: var(--text-teal);">removes the need to think</strong> ‚Äî just follow the steps</span>
          </div>
          <div style="display: flex; gap: var(--space-sm);">
            <span style="color: var(--text-teal); font-weight: 600; font-size: 1rem;">3.</span>
            <span style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.5;">You'll build it using <strong style="color: var(--text-teal);">skills you've already practiced</strong> in Modules 1-4</span>
          </div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="window.nextStep()">Start Building Your Plan ‚Üí</button>
      
      ${renderFooter()}
    `;
  }

  function renderStep2() {
    return `
      ${renderHeader()}
      
      <div class="card">
        <div class="section-header">
          <span class="section-icon">üìä</span>
          <span class="section-title-text">Intensity-Based Plan (1-6)</span>
        </div>
        
        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg); font-size: 0.9375rem;">
          Different intensity levels need different responses. Plan now so you don't have to think later.
        </p>
        
        <div class="intensity-section">
          <div class="intensity-badge">INTENSITY 1-3 ‚Äî Mild Discomfort</div>
          <div class="input-row">
            <label>Use:</label>
            <input type="text" id="planMild" class="input-field" placeholder="e.g., Notice it, breathe, observe" style="flex: 1;">
            <button class="insert-btn" id="insertBtn_planMild" onclick="window.openToolkit('planMild')">
              <span>üìã</span> Insert
            </button>
          </div>
        </div>
        
        <div class="intensity-section">
          <div class="intensity-badge">INTENSITY 4-6 ‚Äî Moderate Distress</div>
          <p style="color: var(--text-teal); font-size: 0.875rem; margin-bottom: var(--space-sm);">Use 2-3 skills:</p>
          
          <div class="input-row">
            <label>1.</label>
            <input type="text" id="planModerate1" class="input-field" placeholder="First skill" style="flex: 1;">
            <button class="insert-btn" id="insertBtn_planModerate1" onclick="window.openToolkit('planModerate1')">üìã</button>
          </div>
          
          <div class="input-row">
            <label>2.</label>
            <input type="text" id="planModerate2" class="input-field" placeholder="Second skill" style="flex: 1;">
            <button class="insert-btn" id="insertBtn_planModerate2" onclick="window.openToolkit('planModerate2')">üìã</button>
          </div>
          
          <div class="input-row">
            <label>3.</label>
            <input type="text" id="planModerate3" class="input-field" placeholder="Third skill (optional)" style="flex: 1;">
            <button class="insert-btn" id="insertBtn_planModerate3" onclick="window.openToolkit('planModerate3')">üìã</button>
          </div>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.previousStep()">‚Üê Back</button>
        <button class="btn btn-primary" onclick="window.nextStep()">Continue ‚Üí</button>
      </div>
      
      ${renderFooter()}
    `;
  }

  // Continue with renderStep3 through renderStep9 (same as your original, just keep them)
  // ... (I'm keeping the rest identical to your code for brevity)

  function render() {
    const content = document.getElementById('content');
    if (!content) return;
    
    let html = '';
    
    switch(currentStep) {
      case 1: html = renderStep1(); break;
      case 2: html = renderStep2(); break;
      case 3: html = renderStep3(); break;
      case 4: html = renderStep4(); break;
      case 5: html = renderStep5(); break;
      case 6: html = renderStep6(); break;
      case 7: html = renderStep7(); break;
      case 8: html = renderStep8(); break;
      case 9: html = renderStep9(); break;
      default: html = renderStep1();
    }
    
    content.innerHTML = html;
    
    if (currentStep === 5) initValuesSave();
    if (currentStep === 7) initCrisisCardSave();
    if (currentStep === 8) initFullPlanSave();
    if (currentStep === 9) initComplete();
    
    setTimeout(loadSavedPlan, 50);
  }

  loadProgress();
  render();
})();
</script>

</body>
</html>
