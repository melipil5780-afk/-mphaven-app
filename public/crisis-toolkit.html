<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>My Crisis Toolkit</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #0f172a;
    --bg-card: rgba(15, 23, 42, 0.98);
    --bg-card-light: rgba(30, 41, 59, 0.65);
    --bg-card-dark: rgba(15, 23, 42, 0.45);
    --border-subtle: rgba(30, 41, 59, 0.5);
    --border-softer: rgba(51, 65, 85, 0.4);
    --primary-teal: #0e7490;
    --primary-teal-dark: #0c627a;
    --accent-amber: #d97706;
    --accent-amber-dark: #b45309;
    --text-primary: rgb(241, 245, 249);
    --text-secondary: rgb(203, 213, 225);
    --text-muted: rgb(148, 163, 184);
    --text-teal-light: rgb(165, 243, 252);
    --text-teal: rgb(94, 234, 212);
    --text-amber: rgb(251, 191, 36);
    --success-emerald: rgb(74, 222, 128);
    --success-bg: rgba(34, 197, 94, 0.12);
    --gradient-main: linear-gradient(135deg, #0e7490, #d97706);
    --gradient-subtle: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.10));
    --crisis-red: #dc2626;
    --crisis-red-dark: #b91c1c;
    --crisis-bg: rgba(220, 38, 38, 0.08);
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
    -webkit-tap-highlight-color: transparent; 
}

html, body { 
    width: 100%; 
    height: 100%; 
    overflow: hidden; 
    background: var(--bg-dark); 
    color: var(--text-primary); 
}

.container { 
    width: 100%; 
    height: 100vh; 
    display: flex; 
    flex-direction: column; 
}

.app-wrapper { 
    width: 100%; 
    max-width: 28rem; 
    height: 100%; 
    margin: 0 auto; 
    background: var(--bg-card); 
    display: flex; 
    flex-direction: column; 
    position: relative; 
    overflow: hidden; 
}

.bg-blur-1, .bg-blur-2 { 
    position: absolute; 
    border-radius: 50%; 
    pointer-events: none; 
    z-index: 0; 
    opacity: 0.3; 
}

.bg-blur-1 { 
    top: -5%; 
    left: 50%; 
    transform: translateX(-50%); 
    width: 22rem; 
    height: 22rem; 
    background: rgba(14, 116, 144, 0.15); 
}

.bg-blur-2 { 
    bottom: -5%; 
    right: -5%; 
    width: 18rem; 
    height: 18rem; 
    background: rgba(217, 119, 6, 0.15); 
}

.main-content { 
    flex: 1; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; 
    scrollbar-width: none; 
    position: relative; 
    z-index: 1; 
}

.main-content::-webkit-scrollbar { 
    display: none; 
}

.content-wrapper { 
    padding: 1rem 1.25rem 2rem; 
    padding-bottom: calc(2rem + env(safe-area-inset-bottom)); 
}

/* Crisis Banner - Only here at the top of toolkit */
.crisis-banner {
    background: var(--crisis-bg);
    border: 1px solid var(--crisis-red);
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}

.crisis-banner span {
    color: #fca5a5;
    font-size: 0.8125rem;
    font-weight: 600;
}

.crisis-banner a {
    color: #fca5a5;
    font-weight: 700;
    text-decoration: none;
    background: rgba(220,38,38,0.2);
    padding: 0.375rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.75rem;
}

.nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
}

.back-link:hover {
    color: var(--text-primary);
}

.toolkit-title {
    font-size: 1.75rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
    background: var(--gradient-main);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.toolkit-subtitle {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1.5rem;
}

.stats-grid {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--bg-card-light);
    border: 1px solid var(--border-softer);
    border-radius: 1rem;
    padding: 1rem;
    flex: 1;
    text-align: center;
}

.stat-number {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--text-teal);
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

/* Crisis Card - Special Highlight */
.crisis-card-preview {
    background: linear-gradient(135deg, rgba(14,116,144,0.2), rgba(217,119,6,0.15));
    border: 2px solid var(--accent-amber);
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin: 1.5rem 0;
    position: relative;
    overflow: hidden;
}

.crisis-card-preview:before {
    content: "üÜò";
    position: absolute;
    top: 0.5rem;
    right: 1rem;
    font-size: 3rem;
    opacity: 0.1;
}

.crisis-card-title {
    font-size: 1.35rem;
    font-weight: 800;
    color: var(--text-amber);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.crisis-card-item {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    margin-bottom: 1rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.5;
}

.crisis-card-number {
    color: var(--text-amber);
    font-weight: 700;
    min-width: 1.5rem;
}

.crisis-card-label {
    color: var(--text-primary);
    font-weight: 600;
    min-width: 5rem;
}

/* Category Sections */
.category-section {
    margin-bottom: 2rem;
}

.category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-softer);
}

.category-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-teal-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.category-count {
    background: var(--gradient-subtle);
    color: var(--text-teal);
    padding: 0.25rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Skill Cards */
.skill-card {
    background: linear-gradient(135deg, var(--bg-card-light), var(--bg-card-dark));
    border: 1px solid var(--border-softer);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: all 0.2s;
}

.skill-card:hover {
    border-color: var(--primary-teal);
}

.skill-card.crisis-plan-item {
    border-left: 4px solid var(--accent-amber);
    background: linear-gradient(135deg, rgba(14,116,144,0.15), rgba(217,119,6,0.1));
}

.skill-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.skill-name {
    font-weight: 700;
    color: var(--text-primary);
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.skill-category-badge {
    background: var(--gradient-subtle);
    color: var(--text-teal-light);
    padding: 0.25rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.6875rem;
    font-weight: 600;
    border: 1px solid rgba(14,116,144,0.25);
    white-space: nowrap;
}

.skill-description {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.skill-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: rgba(15,23,42,0.4);
    border-radius: 0.75rem;
}

.skill-detail-item {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.skill-detail-label {
    color: var(--text-teal);
    font-weight: 600;
    margin-right: 0.25rem;
}

.skill-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.6875rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}

.skill-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.btn-small {
    background: var(--bg-card-dark);
    border: 1px solid var(--border-softer);
    color: var(--text-secondary);
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    text-decoration: none;
}

.btn-small:hover {
    border-color: var(--primary-teal);
    color: var(--text-primary);
}

.btn-small.danger {
    color: #fca5a5;
    border-color: rgba(220,38,38,0.3);
}

.btn-small.danger:hover {
    border-color: var(--crisis-red);
    background: rgba(220,38,38,0.1);
}

.btn-small.primary {
    background: var(--gradient-main);
    color: white;
    border: none;
}

.btn {
    padding: 0.875rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    border: none;
    text-decoration: none;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-primary {
    background: var(--gradient-main);
    color: white;
}

.btn-secondary {
    background: var(--bg-card-dark);
    color: var(--text-secondary);
    border: 1px solid var(--border-softer);
}

.btn-block {
    width: 100%;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    background: var(--bg-card-light);
    border: 1px solid var(--border-softer);
    border-radius: 1.5rem;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.empty-text {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

/* Action Buttons */
.action-group {
    display: flex;
    gap: 0.75rem;
    margin: 1.5rem 0;
    flex-wrap: wrap;
}

.action-btn {
    flex: 1;
    min-width: 120px;
}

/* Footer */
.footer {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-subtle);
}

.footer-warning {
    color: #fca5a5;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success-bg);
    color: var(--success-emerald);
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-size: 0.875rem;
    font-weight: 600;
    border: 1px solid var(--success-emerald);
    z-index: 1000;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from { transform: translate(-50%, 100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

/* Print Styles */
@media print {
    .crisis-banner, .nav-header, .skill-actions, .action-group, .btn, .footer {
        display: none !important;
    }
    body { background: white; }
    .app-wrapper { background: white; max-width: 100%; }
    .skill-card { break-inside: avoid; border: 1px solid #ccc; }
    .crisis-card-preview { border: 2px solid #000; }
}
</style>
</head>
<body>
<div class="container">
  <div class="app-wrapper">
    <div class="bg-blur-1"></div>
    <div class="bg-blur-2"></div>
    <div class="main-content">
      <div class="content-wrapper">

        <!-- CRISIS BANNER - Only here at the top of toolkit -->
        <div class="crisis-banner">
          <span>üö® In crisis? Help is available 24/7</span>
          <span style="display: flex; gap: 0.5rem;">
            <a href="tel:988">Call 988</a>
            <a href="sms:988">Text 988</a>
          </span>
        </div>

        <!-- HEADER -->
        <div class="nav-header">
          <a href="crisis-intro.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Course Home
          </a>
          <a href="app.html" class="back-link">
            Main App
          </a>
        </div>

        <h1 class="toolkit-title">My Crisis Toolkit</h1>
        <p class="toolkit-subtitle">Your complete crisis plan ‚Ä¢ All your tools in one place</p>

        <!-- STATS - DYNAMICALLY UPDATED -->
        <div class="stats-grid" id="statsContainer">
          <div class="stat-card">
            <div class="stat-number" id="totalSkills">0</div>
            <div class="stat-label">Total Tools</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="practicedModules">0</div>
            <div class="stat-label">Modules Done</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="crisisPlanStatus">‚Äî</div>
            <div class="stat-label">Crisis Plan</div>
          </div>
        </div>

        <!-- CRISIS CARD - Always shown if exists -->
        <div id="crisisCardContainer"></div>

        <!-- TOOLKIT CONTENT -->
        <div id="toolkitContent">
          <!-- Populated by JavaScript -->
        </div>

        <!-- ACTION BUTTONS -->
        <div class="action-group">
          <button id="exportToolkitBtn" class="btn btn-secondary action-btn">
            <span>üì•</span> Export
          </button>
          <button id="importToolkitBtn" class="btn btn-secondary action-btn">
            <span>üì§</span> Import
          </button>
          <button id="printToolkitBtn" class="btn btn-secondary action-btn">
            <span>üñ®Ô∏è</span> Print
          </button>
        </div>

        <div style="display: flex; gap: 0.75rem; margin: 0.5rem 0 1.5rem;">
          <button id="clearToolkitBtn" class="btn btn-secondary" style="flex: 1; color: #fca5a5; border-color: rgba(220,38,38,0.3);">
            <span>üóëÔ∏è</span> Clear All
          </button>
          <a href="crisis-module-5.html" class="btn btn-primary" style="flex: 1; text-decoration: none;">
            <span>‚ûï</span> Add More
          </a>
        </div>

        <!-- BACK TO COURSE -->
        <a href="crisis-intro.html" class="btn btn-secondary btn-block" style="text-decoration: none; margin-bottom: 1rem;">
          ‚Üê Back to Course Hub
        </a>

        <!-- FOOTER -->
        <div class="footer">
          <p class="footer-warning">‚ö†Ô∏è EDUCATIONAL ONLY ‚Äî NOT THERAPY</p>
          <p>988 Suicide & Crisis Lifeline: Call or text 988</p>
          <p>Crisis Text Line: Text HOME to 741741</p>
          <p style="margin-top: 1rem; color: var(--text-teal);">Your tools. Practice when calm. Use in crisis.</p>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script>
(function() {
    'use strict';
    
    // ===== NO DISCLAIMER CHECK - REMOVED =====
    // The toolkit loads directly without any redirects

    // ===== LOAD AND RENDER TOOLKIT =====
    function loadToolkit() {
        const toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
        const crisisPlan = JSON.parse(localStorage.getItem('crisis_plan') || '{}');
        const progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        
        // Update stats
        document.getElementById('totalSkills').textContent = toolkit.length;
        document.getElementById('practicedModules').textContent = progress.practicedModules?.length || 0;
        document.getElementById('crisisPlanStatus').textContent = crisisPlan.completed ? '‚úì Ready' : '‚Äî';
        
        // Render Crisis Card (always show if exists)
        renderCrisisCard(crisisPlan);
        
        // Render toolkit items
        renderToolkitItems(toolkit, crisisPlan);
    }

    // ===== RENDER CRISIS CARD =====
    function renderCrisisCard(crisisPlan) {
        const container = document.getElementById('crisisCardContainer');
        
        if (crisisPlan.crisisCard) {
            const card = crisisPlan.crisisCard;
            
            // Get values from intensity plan if available
            const phys1 = crisisPlan.intensityPlan?.high?.physical?.[0] || card.physical || 'Cold water, intense exercise';
            const mental = crisisPlan.intensityPlan?.high?.mental || card.wait || 'Grounding, cognitive load';
            const acceptance = card.acceptance || '"It is what it is"';
            const values = card.values || 'Will this align with who I want to be?';
            const emergency = card.emergency || 'Call 988';
            
            container.innerHTML = `
                <div class="crisis-card-preview">
                    <div class="crisis-card-title">
                        <span>üÜò</span> MY CRISIS CARD
                    </div>
                    
                    <div class="crisis-card-item">
                        <span class="crisis-card-number">1.</span>
                        <span class="crisis-card-label">PHYSICAL:</span>
                        <span>${phys1}</span>
                    </div>
                    
                    <div class="crisis-card-item">
                        <span class="crisis-card-number">2.</span>
                        <span class="crisis-card-label">WAIT 20 MIN:</span>
                        <span>${mental}</span>
                    </div>
                    
                    <div class="crisis-card-item">
                        <span class="crisis-card-number">3.</span>
                        <span class="crisis-card-label">ACCEPT:</span>
                        <span>${acceptance}</span>
                    </div>
                    
                    <div class="crisis-card-item">
                        <span class="crisis-card-number">4.</span>
                        <span class="crisis-card-label">VALUES:</span>
                        <span>${values}</span>
                    </div>
                    
                    <div class="crisis-card-item">
                        <span class="crisis-card-number">5.</span>
                        <span class="crisis-card-label">EMERGENCY:</span>
                        <span>${emergency}</span>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(217,119,6,0.3); text-align: center;">
                        <p style="color: var(--text-amber); font-weight: 600; font-style: italic;">
                            The wave WILL pass. You have the tools.
                        </p>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    // ===== RENDER TOOLKIT ITEMS =====
    function renderToolkitItems(toolkit, crisisPlan) {
        const container = document.getElementById('toolkitContent');
        
        if (toolkit.length === 0 && !crisisPlan.completed) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üß∞</div>
                    <div class="empty-title">Your toolkit is empty</div>
                    <div class="empty-text">
                        Complete the Crisis Resilience course and save skills to build your personalized crisis toolkit.
                    </div>
                    <a href="crisis-intro.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                        Start Course ‚Üí
                    </a>
                </div>
            `;
            return;
        }
        
        // Group by category
        const categories = {
            'üÜò My Crisis Plan': [],
            'üí™ Physical Skills': [],
            'üß† Mental Techniques': [],
            'üïäÔ∏è Acceptance Skills': [],
            'üìã My Profile': []
        };
        
        // Add Crisis Plan items from crisisPlan object
        if (crisisPlan.completed) {
            // Values Compass
            if (crisisPlan.values) {
                categories['üÜò My Crisis Plan'].push({
                    id: 'values-compass',
                    name: 'üß≠ My Values Compass',
                    description: 'Your personal values to guide decisions in crisis',
                    details: crisisPlan.values,
                    category: 'Crisis Plan',
                    date: crisisPlan.lastUpdated
                });
            }
            
            // Intensity Plan
            if (crisisPlan.intensityPlan) {
                const ip = crisisPlan.intensityPlan;
                const desc = `Mild: ${ip.mild || '‚Äî'} ‚Ä¢ Moderate: ${ip.moderate?.filter(Boolean).join(', ') || '‚Äî'} ‚Ä¢ High: ${ip.high?.physical?.filter(Boolean).join(', ') || '‚Äî'}`;
                categories['üÜò My Crisis Plan'].push({
                    id: 'intensity-plan',
                    name: 'üìä My Intensity Plan',
                    description: desc,
                    category: 'Crisis Plan',
                    date: crisisPlan.lastUpdated
                });
            }
            
            // Practice Plan
            if (crisisPlan.practicePlan) {
                const pp = crisisPlan.practicePlan;
                const desc = `Practice: ${pp.skill1 || '‚Äî'} (${pp.freq1 || 'daily'})${pp.skill2 ? `, ${pp.skill2} (${pp.freq2})` : ''}`;
                categories['üÜò My Crisis Plan'].push({
                    id: 'practice-plan',
                    name: 'üìÖ My Practice Plan',
                    description: desc,
                    category: 'Crisis Plan',
                    date: crisisPlan.lastUpdated
                });
            }
        }
        
        // Add toolkit items to appropriate categories
        toolkit.forEach(skill => {
            const cat = skill.category || 'Other';
            const name = skill.name?.toLowerCase() || '';
            
            if (cat.includes('Physical') || cat.includes('Module 2') || name.includes('cold') || name.includes('exercise') || name.includes('breath') || name.includes('pmr') || name.includes('temperature')) {
                categories['üí™ Physical Skills'].push(skill);
            } else if (cat.includes('Mental') || cat.includes('Module 3') || name.includes('ground') || name.includes('cognitive') || name.includes('sensation') || name.includes('bilateral') || name.includes('distraction')) {
                categories['üß† Mental Techniques'].push(skill);
            } else if (cat.includes('Acceptance') || cat.includes('Making Peace') || cat.includes('Module 4') || name.includes('accept') || name.includes('compassion') || name.includes('defusion') || name.includes('willing') || name.includes('smile')) {
                categories['üïäÔ∏è Acceptance Skills'].push(skill);
            } else if (cat.includes('Profile') || cat.includes('Module 1') || name.includes('urge') || name.includes('window')) {
                categories['üìã My Profile'].push(skill);
            } else if (cat.includes('Crisis Plan') || cat.includes('Module 5')) {
                categories['üÜò My Crisis Plan'].push(skill);
            } else {
                categories['üìã My Profile'].push(skill);
            }
        });
        
        let html = '';
        
        // Render each category that has items
        for (let [categoryTitle, skills] of Object.entries(categories)) {
            if (skills.length === 0) continue;
            
            // Sort by date (newest first)
            skills.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            
            html += `
                <div class="category-section">
                    <div class="category-header">
                        <div class="category-title">
                            <span>${categoryTitle.split(' ')[0]}</span>
                            ${categoryTitle}
                        </div>
                        <span class="category-count">${skills.length}</span>
                    </div>
            `;
            
            skills.forEach(skill => {
                const date = skill.date ? new Date(skill.date).toLocaleDateString() : 'Recently';
                const isCrisisPlan = categoryTitle.includes('Crisis Plan');
                
                html += `
                    <div class="skill-card ${isCrisisPlan ? 'crisis-plan-item' : ''}" data-id="${skill.id}">
                        <div class="skill-header">
                            <div class="skill-name">
                                ${skill.name || 'Skill'}
                                ${isCrisisPlan ? '<span style="color: var(--text-amber);">‚≠ê</span>' : ''}
                            </div>
                            <span class="skill-category-badge">${getCategoryBadge(categoryTitle)}</span>
                        </div>
                        <div class="skill-description">
                            ${skill.description?.replace(/\n/g, '<br>') || 'No description'}
                        </div>
                        
                        ${renderSkillDetails(skill)}
                        
                        <div class="skill-meta">
                            <span>üìÖ ${date}</span>
                        </div>
                        <div class="skill-actions">
                            <button class="btn-small primary" onclick="practiceSkill('${skill.id}')">
                                <span>‚ö°</span> Practice
                            </button>
                            <button class="btn-small danger" onclick="removeSkill('${skill.id}')">
                                <span>üóëÔ∏è</span> Remove
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
    }

    // ===== RENDER SKILL DETAILS =====
    function renderSkillDetails(skill) {
        if (skill.id === 'values-compass' && skill.details) {
            const v = skill.details;
            return `
                <div class="skill-detail-grid">
                    <div class="skill-detail-item"><span class="skill-detail-label">1.</span> ${v.val1 || '‚Äî'}</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">2.</span> ${v.val2 || '‚Äî'}</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">3.</span> ${v.val3 || '‚Äî'}</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">Rel:</span> ${v.rel || '‚Äî'}</div>
                </div>
            `;
        }
        if (skill.id === 'crisis-card' && skill.details) {
            return `
                <div class="skill-detail-grid">
                    <div class="skill-detail-item"><span class="skill-detail-label">1.</span> Physical</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">2.</span> Wait 20 min</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">3.</span> Acceptance</div>
                    <div class="skill-detail-item"><span class="skill-detail-label">4.</span> Values</div>
                </div>
            `;
        }
        return '';
    }

    // ===== HELPER FUNCTIONS =====
    function getCategoryBadge(category) {
        const badges = {
            'üÜò My Crisis Plan': 'CRISIS PLAN',
            'üí™ Physical Skills': 'PHYSICAL',
            'üß† Mental Techniques': 'MENTAL',
            'üïäÔ∏è Acceptance Skills': 'ACCEPTANCE',
            'üìã My Profile': 'MY PROFILE'
        };
        return badges[category] || 'SKILL';
    }

    // ===== PRACTICE SKILL =====
    window.practiceSkill = function(skillId) {
        if (skillId.includes('cold') || skillId.includes('exercise') || skillId.includes('breath') || skillId.includes('pmr') || skillId.includes('temperature')) {
            window.location.href = 'crisis-module-2.html';
        } else if (skillId.includes('ground') || skillId.includes('cognitive') || skillId.includes('sensation') || skillId.includes('bilateral') || skillId.includes('distraction')) {
            window.location.href = 'crisis-module-3.html';
        } else if (skillId.includes('accept') || skillId.includes('compassion') || skillId.includes('defusion') || skillId.includes('willing') || skillId.includes('smile')) {
            window.location.href = 'crisis-module-4.html';
        } else if (skillId.includes('values') || skillId.includes('crisis-card') || skillId.includes('intensity') || skillId.includes('practice') || skillId.includes('pros-cons') || skillId.includes('kit')) {
            window.location.href = 'crisis-module-5.html';
        } else if (skillId.includes('urges') || skillId.includes('window')) {
            window.location.href = 'crisis-module-1.html';
        } else {
            window.location.href = 'crisis-intro.html';
        }
    };

    // ===== REMOVE SKILL =====
    window.removeSkill = function(skillId) {
        if (!confirm('Remove this skill from your toolkit?')) return;
        
        let toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
        toolkit = toolkit.filter(item => item.id !== skillId);
        localStorage.setItem('crisis_toolkit', JSON.stringify(toolkit));
        
        showToast('‚úì Skill removed');
        loadToolkit();
    };

    // ===== EXPORT TOOLKIT =====
    document.getElementById('exportToolkitBtn')?.addEventListener('click', function() {
        const toolkit = JSON.parse(localStorage.getItem('crisis_toolkit') || '[]');
        const crisisPlan = JSON.parse(localStorage.getItem('crisis_plan') || '{}');
        const progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        
        const exportData = {
            toolkit,
            crisisPlan,
            progress,
            exportedAt: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `crisis-toolkit-${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showToast('‚úì Toolkit exported');
    });

    // ===== IMPORT TOOLKIT =====
    document.getElementById('importToolkitBtn')?.addEventListener('click', function() {
        document.getElementById('importFile').click();
    });

    document.getElementById('importFile')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                
                if (imported.toolkit) {
                    localStorage.setItem('crisis_toolkit', JSON.stringify(imported.toolkit));
                }
                if (imported.crisisPlan) {
                    localStorage.setItem('crisis_plan', JSON.stringify(imported.crisisPlan));
                }
                if (imported.progress) {
                    localStorage.setItem('crisis_course_progress', JSON.stringify(imported.progress));
                }
                
                showToast('‚úì Toolkit imported successfully');
                loadToolkit();
            } catch (err) {
                alert('Invalid file format. Please export a toolkit file first.');
            }
        };
        reader.readAsText(file);
        
        // Clear input
        e.target.value = '';
    });

    // ===== CLEAR ALL =====
    document.getElementById('clearToolkitBtn')?.addEventListener('click', function() {
        if (!confirm('Are you sure? This will remove ALL skills from your toolkit.')) return;
        if (!confirm('This cannot be undone. Clear everything?')) return;
        
        localStorage.removeItem('crisis_toolkit');
        // Keep crisis plan and progress, just clear toolkit
        loadToolkit();
        showToast('‚úì All skills cleared');
    });

    // ===== PRINT TOOLKIT =====
    document.getElementById('printToolkitBtn')?.addEventListener('click', function() {
        window.print();
    });

    // ===== SHOW TOAST NOTIFICATION =====
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // ===== INITIALIZE =====
    function init() {
        // Update progress
        let progress = JSON.parse(localStorage.getItem('crisis_course_progress') || '{}');
        progress.lastAccessed = new Date().toISOString();
        localStorage.setItem('crisis_course_progress', JSON.stringify(progress));
        
        // Load data
        loadToolkit();
    }

    init();
})();
</script>
</body>
</html>
